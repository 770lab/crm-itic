<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Mini-CRM Inscriptions</title>
  <style>
    /* Icône calendrier en blanc + date inputs en mode sombre */
    input[type="date"]::-webkit-calendar-picker-indicator{ filter: invert(1); opacity: .95 }
    input[type="date"]{ color-scheme: dark }

    :root{--bg:#0f172a;--panel:#111827;--muted:#94a3b8;--text:#e5e7eb;--accent:#4f46e5;--ok:#16a34a;--warn:#f59e0b;--bad:#ef4444;--chip:#1f2937}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Inter,Arial,sans-serif;background:linear-gradient(180deg,#0f172a,#0b1220 40%,#0b1020);color:var(--text)}
    header{position:sticky;top:0;backdrop-filter:saturate(1.2) blur(8px);background:#0b1020cc;border-bottom:1px solid #1f2937;z-index:10}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    h1{font-size:clamp(20px,2.2vw,28px);margin:0 0 4px 0}
    .sub{color:var(--muted);font-size:14px}
    .grid{display:grid;gap:14px}
    .cols{grid-template-columns:repeat(12,1fr)}
    .card{background:linear-gradient(180deg,#0e1628,#0b1323);border:1px solid #1f2937;border-radius:14px;box-shadow:0 10px 30px #0006}
    .card .hd{padding:14px 16px;border-bottom:1px solid #1f2937;display:flex;align-items:center;gap:10px}
    .card .bd{padding:16px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #243044;background:#0a1322;color:var(--text);outline:none}
    textarea{min-height:70px;resize:vertical}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .btn{appearance:none;border:1px solid #2a3550;background:#121a2b;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
    .btn:hover{border-color:#334155;background:#0d1628}
    .btn.primary{background:linear-gradient(180deg,#3943f1,#2a35d8);border-color:#4f46e5}
    .btn.good{border-color:#15803d;background:#113319}
    .btn.warn{border-color:#b45309;background:#2b1f06}
    .btn.bad{border-color:#b91c1c;background:#2a0e0e}
    .chip{display:inline-flex;align-items:center;gap:6px;background:var(--chip);border:1px solid #334155;color:#cbd5e1;padding:6px 10px;border-radius:999px;font-size:12px}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th{font-size:12px;color:#94a3b8;text-align:left;padding:4px 8px}
    td{background:#0a1322;border:1px solid #22314b;padding:10px 8px;vertical-align:top}
    tr td:first-child{border-radius:10px 0 0 10px}
    tr td:last-child{border-radius:0 10px 10px 0}
    .tag{font-size:11px;padding:4px 8px;border-radius:999px;border:1px solid #334155}
    .tag.ok{background:#052a14;color:#86efac;border-color:#14532d}
    .tag.wait{background:#2a2405;color:#fde68a;border-color:#854d0e}
    .tag.no{background:#2a0a0a;color:#fecaca;border-color:#7f1d1d}
    .overdue{background:linear-gradient(90deg,#2a0b0b,#160c12)}
    .toolbar{display:flex;flex-wrap:wrap;gap:8px}
    .kpi{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .kpi .box{background:#0a1322;border:1px solid #22314b;border-radius:12px;padding:12px}
    .kpi .n{font-weight:700;font-size:20px}
    @media (max-width:960px){.row,.cols{grid-template-columns:repeat(6,1fr)}.kpi{grid-template-columns:repeat(2,1fr)}}
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex;align-items:center;gap:14px">
      <img src="sandbox:/mnt/data/Capture d’écran 2025-10-20 à 14.18.16.png" alt="ITIC Paris" style="height:34px;filter:invert(1) brightness(1.2);object-fit:contain"/>
      <h1>Mini-CRM Inscriptions</h1>
      <div class="sub">Saisie des élèves, échéanciers, suivi des paiements, relances e-mail pour <b>jessica@iticparis.com</b>.</div>
    </div>
  </header>

  <main class="wrap grid" style="margin-top:14px">
    <section class="card" id="section-form">
      <div class="hd"><strong>Nouvelle fiche élève / modification</strong><span class="chip" id="draftBadge" hidden>Brouillon</span></div>
      <div class="bd grid cols">
        <div class="row" style="grid-column:1/13">
          <div style="grid-column:span 3">
            <label>Nom</label>
            <input id="f_nom" placeholder="Dupont" />
          </div>
          <div style="grid-column:span 3">
            <label>Prénom</label>
            <input id="f_prenom" placeholder="Alice" />
          </div>
          <div style="grid-column:span 3">
            <label>Formation</label>
            <select id="f_formation">
              <option value="">—</option>
              <option>BTS SIO - SISR</option>
              <option>BTS SIO - SLAM</option>
              <option>BTS MCO</option>
              <option>BTS NDRC</option>
              <option>BTS COM</option>
              <option>BTS CI</option>
              <option>BTS CG</option>
              <option>IOA</option>
              <option>Bachelor Marketing</option>
              <option>Bachelor RH</option>
              <option>Bachelor Communication</option>
              <option>M1 COM</option>
              <option>M1 MRH</option>
              <option>M1 MSC</option>
              <option>M1 MSFO</option>
              <option>M2 COM</option>
              <option>M2 MRH</option>
              <option>M2 MSC</option>
              <option>M2 MSFO</option>
              <option>ALT-BTS1 SIO</option>
              <option>ALT-BTS2 SISR</option>
              <option>ALT-BTS2 SLAM</option>
              <option>ALT-BTS2 MCO</option>
              <option>ALT-BTS2 NDRC</option>
              <option>ALT-BTS2 COM</option>
              <option>ALT-BTS2 CI</option>
              <option>ALT-BTS2 CG</option>
              <option>ALT-M1-MRH</option>
              <option>ALT-M1-MSC</option>
              <option>ALT-M1-MSFO</option>
              <option>ALT-M2-COM</option>
              <option>e-learning cpf</option>
            </select>
          </div>
          <div style="grid-column:span 3">
            <label>Année scolaire</label>
            <select id="f_annee">
              <option value="">—</option>
              <option>2008-2009</option>
              <option>2009-2010</option>
              <option>2010-2011</option>
              <option>2011-2012</option>
              <option>2012-2013</option>
              <option>2013-2014</option>
              <option>2014-2015</option>
              <option>2015-2016</option>
              <option>2016-2017</option>
              <option>2017-2018</option>
              <option>2018-2019</option>
              <option>2019-2020</option>
              <option>2020-2021</option>
              <option>2021-2022</option>
              <option>2022-2023</option>
              <option>2023-2024</option>
              <option>2024-2025</option>
              <option selected>2025-2026</option>
              <option>2026-2027</option>
            </select>
          </div>
          <div style="grid-column:span 3">
            <label>Responsable</label>
            <select id="f_responsable">
              <option value="">—</option>
              <option>NASSIM</option>
              <option>ANNA</option>
              <option>MOUSSA</option>
            </select>
          </div>
          <div style="grid-column:span 3">
            <label>Statut</label>
            <select id="f_statut">
              <option>En attente</option>
              <option>Inscription ferme</option>
              <option>Abandon</option>
              <option>Refusé</option>
            </select>
          </div>
          <div style="grid-column:span 3">
            <label>Financement</label>
            <select id="f_financement">
              <option value="">—</option>
              <option>CPF</option>
              <option>Entreprise</option>
              <option>Personnel</option>
              <option>Pôle Emploi</option>
              <option>OPCO</option>
              <option>Alternance (apprentissage)</option>
              <option>Initiale</option>
              <option>E-learning</option>
              <option>SFP</option>
              <option>Bourse</option>
              <option>Autre</option>
            </select>
          </div>
          <div style="grid-column:span 3">
            <label>E-mail (élève / contact)</label>
            <input id="f_email" placeholder="eleve@exemple.com" type="email" />
          </div>
          <div style="grid-column:1/13">
            <label>Commentaires</label>
            <textarea id="f_notes" placeholder="Notes libres…"></textarea>
          </div>
        </div>

        <div style="grid-column:1/13;margin-top:8px">
          <div class="row">
            <div style="grid-column:span 6">
              <h3 style="margin:6px 0 10px 0">Échéancier</h3>
              <div class="toolbar" style="margin-bottom:8px; gap:10px; flex-wrap:wrap">
                <button class="btn" id="btnAddEcheance" type="button">Ajouter une échéance</button>
                <span class="sub">ou planifier automatiquement :</span>
                <label class="chip">Départ&nbsp;<input type="date" id="planStart" style="background:transparent;border:none;color:inherit"/></label>
                <label class="chip">Nb échéances&nbsp;<input type="number" id="planCount" min="1" max="60" value="3" style="width:70px;background:transparent;border:none;color:inherit"/></label>
                <label class="chip">Montant total (€)&nbsp;<input type="number" id="planTotal" step="0.01" placeholder="0" style="width:110px;background:transparent;border:none;color:inherit"/></label>
                <button class="btn" id="btnPlanifier" type="button">Planifier</button>
              </div>
              <div id="echeances"></div>
            </div>
            <div style="grid-column:span 6">
              <h3 style="margin:6px 0 10px 0">Totaux</h3>
              <div class="kpi">
                <div class="box"><div class="sub">Montant total dû</div><div class="n" id="k_total">0 €</div></div>
                <div class="box"><div class="sub">Payé</div><div class="n" id="k_paye">0 €</div></div>
                <div class="box"><div class="sub">Restant</div><div class="n" id="k_restant">0 €</div></div>
                <div class="box"><div class="sub">Retard</div><div class="n" id="k_retard">0 €</div></div>
              </div>
            </div>
          </div>
        </div>

        <div style="grid-column:1/13;display:flex;gap:8px;flex-wrap:wrap;margin-top:12px">
          <button class="btn primary" id="btnSave" type="button">Enregistrer / Mettre à jour</button>
          <button class="btn" id="btnReset" type="button">Vider le formulaire</button>
        </div>
      </div>
    </section>

    <section class="card">
      <div class="hd"><strong>Liste & filtres</strong></div>
      <div class="bd">
        <div class="toolbar" style="margin-bottom:10px">
          <input id="q" placeholder="Recherche (nom, formation, responsable, e-mail)…" style="min-width:260px" />
          <select id="fltStatut"><option value="">Tous statuts</option><option>En attente</option><option>Inscription ferme</option><option>Abandon</option><option>Refusé</option></select>
          <input id="fltAnnee" placeholder="Année (ex: 2024-2025)" />
          <input id="fltResp" placeholder="Responsable" />
          <button class="btn" id="btnExport">Exporter CSV</button>
          <label class="btn" for="fileImport" style="cursor:pointer">Importer CSV<input id="fileImport" type="file" accept=".csv" hidden></label>
          <button class="btn warn" id="btnRelances">Relancer tous les retards</button>
        </div>
        <div style="overflow:auto">
          <table id="tab">
            <thead>
              <tr>
                <th>Élève</th><th>Formation / Année</th><th>Responsable</th><th>Statut</th><th>Financement</th><th>Total</th><th>Payé</th><th>Restant</th><th>Prochaine échéance</th><th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <template id="rowEch">
    <div class="row" style="align-items:end;margin-bottom:8px">
      <div style="grid-column:span 4">
        <label>Date d’échéance</label>
        <input type="date" class="ech-date" />
      </div>
      <div style="grid-column:span 3">
        <label>Montant (€)</label>
        <input type="number" step="0.01" class="ech-montant" placeholder="0" />
      </div>
      <div style="grid-column:span 3">
        <label>Payé ?</label>
        <select class="ech-paye"><option value="non">Non</option><option value="oui">Oui</option></select>
      </div>
      <div style="grid-column:span 2;display:flex;gap:8px">
        <button class="btn good ech-mark" type="button">Marquer payé</button>
        <button class="btn bad ech-del" type="button">Suppr.</button>
      </div>
    </div>
  </template>

  <script>
  // ========= Constantes =========
  const FORMATIONS=[
    'BTS SIO - SISR','BTS SIO - SLAM','BTS MCO','BTS NDRC','BTS COM','BTS CG','BTS CI',
    'Bachelor Marketing','Bachelor RH','Bachelor Communication','BACHELOR MARKETING',
    'M1 COM','M1 MRH','M1 MSC','M1 MSFO','M2 COM','M2 MRH','M2 MSC','M2 MSFO',
    'ALT-BTS1 SIO','ALT-BTS2 SISR','ALT-BTS2 SLAM','ALT-BTS2 MCO','ALT-BTS2 NDRC','ALT-BTS2 COM','ALT-BTS2 CI','ALT-BTS2 CG',
    'ALT-M1-MRH','ALT-M1-MSC','ALT-M1-MSFO','ALT-M2-COM',
    'IOA','BACH CI','BACH RH','e-learning cpf'
  ];
  const RESPONSABLES=['NASSIM','ANNA','MOUSSA'];
  const FINANCEMENTS=['CPF','Entreprise','Personnel','Pôle Emploi','OPCO','Alternance (apprentissage)','Initiale','E-learning','SFP','Bourse','Autre'];
  const ANNEES=[]; for(let y=2008;y<=2026;y++) ANNEES.push(`${y}-${y+1}`);

  // ========= Helpers =========
  const KEY='crm_inscriptions_v1';
  const $=(s,root=document)=>root.querySelector(s);
  const $$=(s,root=document)=>Array.from(root.querySelectorAll(s));
  const kTotal=$('#k_total'),kPaye=$('#k_paye'),kRestant=$('#k_restant'),kRetard=$('#k_retard');
  const echeancesBox=$('#echeances');

  function populateSelect(id,opts,def){ const sel=document.getElementById(id); sel.innerHTML=''; const e=document.createElement('option'); e.value=''; e.textContent='—'; sel.appendChild(e); opts.forEach(v=>{const o=document.createElement('option');o.value=v;o.textContent=v;sel.appendChild(o)}); if(def) sel.value=def; }
  function loadAll(){ try{return JSON.parse(localStorage.getItem(KEY))||[]}catch{return[]} }
  function saveAll(a){ localStorage.setItem(KEY,JSON.stringify(a)) }
  function blankFiche(){ return {id:crypto.randomUUID(),nom:'',prenom:'',formation:'',annee:'',responsable:'',statut:'En attente',financement:'',email:'',notes:'',echeances:[],createdAt:Date.now(),updatedAt:Date.now()} }

  // ========= Form state =========
  let currentId=null;
  const f={ nom:$('#f_nom'), prenom:$('#f_prenom'), formation:$('#f_formation'), annee:$('#f_annee'), responsable:$('#f_responsable'), statut:$('#f_statut'), financement:$('#f_financement'), email:$('#f_email'), notes:$('#f_notes') };

  function fillForm(data){ for(const k of Object.keys(f)) f[k].value=data[k]||''; echeancesBox.innerHTML=''; (data.echeances||[]).forEach(addEcheanceRowFromData); refreshKPIs(); currentId=data.id||null; $('#draftBadge').hidden=!currentId; }
  function readForm(){ const d={}; for(const k of Object.keys(f)) d[k]=(f[k].value||'').trim(); d.echeances=readEcheances(); d.id=currentId||crypto.randomUUID(); return d; }

  // ========= Echéancier =========
  // filet de sécurité: délégation globale
  document.addEventListener('click',(e)=>{
    const del=e.target.closest('.ech-del');
    if(del && echeancesBox.contains(del)){
      const row=del.closest('.row');
      if(row && confirm('Supprimer cette échéance ?')){ row.remove(); refreshKPIs(); }
    }
    const mark=e.target.closest('.ech-mark');
    if(mark && echeancesBox.contains(mark)){
      const row=mark.closest('.row'); if(row){ row.querySelector('.ech-paye').value='oui'; refreshKPIs(); }
    }
  });

  function addMonthsSameDay(base, months){ const day=base.getDate(); const y=base.getFullYear(); const m=base.getMonth()+months; const last=new Date(y,m+1,0).getDate(); const target=Math.min(day,last); return new Date(y,m,target); }
  function toYMD(dt){ const y=dt.getFullYear(); const m=('0'+(dt.getMonth()+1)).slice(-2); const d=('0'+dt.getDate()).slice(-2); return `${y}-${m}-${d}`; }
  function parseAmount(v){ if(v==null) return 0; if(typeof v==='number') return v; const n=Number(String(v).replace(',','.')); return isNaN(n)?0:n; }
  function splitEven(total,n){ const cents=Math.round(total*100); const base=Math.floor(cents/n); let rem=cents-base*n; const out=[]; for(let i=0;i<n;i++){ const add=i<rem?base+1:base; out.push(add/100) } return out }
  function redistribute(total,first,n){ if(n<=0) return []; if(first<0) first=0; const rem=Math.max(0,total-first); return [first,...splitEven(rem,n)] }
  function sumCurrentAmounts(){ return $$('.row',echeancesBox).reduce((s,row)=> s+parseAmount(row.querySelector('.ech-montant').value||0),0) }

  function addEcheanceRow(){
    const tpl=$('#rowEch').content.cloneNode(true);
    const row=tpl.querySelector('.row');
    row.querySelectorAll('button').forEach(b=> b.type='button');
    row.querySelector('.ech-del').addEventListener('click',(ev)=>{ ev.preventDefault(); ev.stopPropagation(); if(confirm('Supprimer cette échéance ?')){ row.remove(); refreshKPIs(); } });
    row.querySelector('.ech-mark').addEventListener('click',(ev)=>{ ev.preventDefault(); ev.stopPropagation(); row.querySelector('.ech-paye').value='oui'; refreshKPIs(); });
    row.querySelectorAll('input,select').forEach(el=> el.addEventListener('input', refreshKPIs));
    echeancesBox.appendChild(row);
  }
  function addEcheanceRowFromData(e){ addEcheanceRow(); const last=echeancesBox.lastElementChild; if(e.date) last.querySelector('.ech-date').value=e.date; last.querySelector('.ech-montant').value=String(e.montant||''); last.querySelector('.ech-paye').value=e.paye?'oui':'non'; }
  function readEcheances(){ return $$('.row',echeancesBox).map(row=>({ date:row.querySelector('.ech-date').value||'', montant:Number(row.querySelector('.ech-montant').value||0), paye:row.querySelector('.ech-paye').value==='oui' })).filter(x=> x.date || x.montant>0) }

  function computeTotals(eches){ const now=new Date(); let total=0,paye=0,retard=0,next=null; eches.forEach(e=>{ total+=(e.montant||0); if(e.paye) paye+=(e.montant||0); else { const d=e.date?new Date(e.date):null; if(d && d<new Date(now.toDateString())) retard+=(e.montant||0); if(!next || (d && d<next && d>=new Date(now.toDateString()))) next=d; } }); return {total,paye,restant:Math.max(0,total-paye),retard,prochaine:next} }
  function fmtEUR(n){ return (n||0).toLocaleString('fr-FR',{style:'currency',currency:'EUR',maximumFractionDigits:0}) }
  function fmtDate(d){ if(!d) return '—'; try{ return new Date(d).toLocaleDateString('fr-FR') }catch{ return '—' } }
  function refreshKPIs(){ const t=computeTotals(readEcheances()); kTotal.textContent=fmtEUR(t.total); kPaye.textContent=fmtEUR(t.paye); kRestant.textContent=fmtEUR(t.restant); kRetard.textContent=fmtEUR(t.retard); }

  // ========= Actions =========
  $('#btnSave').onclick=()=>{ const all=loadAll(); const data=readForm(); data.updatedAt=Date.now(); const i=all.findIndex(x=>x.id===data.id); if(i>=0) all[i]=Object.assign(all[i],data); else all.push(Object.assign(blankFiche(),data)); saveAll(all); currentId=data.id; $('#draftBadge').hidden=false; renderList(); alert('Fiche enregistrée.'); };
  $('#btnReset').onclick=()=> fillForm(blankFiche());
  $('#btnAddEcheance').onclick=addEcheanceRow;

  // Redistribution auto quand le 1er montant change
  let REDIST_SNAPSHOT=null;
  echeancesBox.addEventListener('focusin',(ev)=>{
    if(ev.target.classList.contains('ech-montant')){ const rows=$$('.row',echeancesBox); if(rows[0] && ev.target===rows[0].querySelector('.ech-montant')) REDIST_SNAPSHOT=sumCurrentAmounts(); }
  });
  echeancesBox.addEventListener('input',(ev)=>{
    if(!ev.target.classList.contains('ech-montant')) return; const rows=$$('.row',echeancesBox); if(rows.length<2) return; const firstInput=rows[0].querySelector('.ech-montant'); if(ev.target!==firstInput) return; const first=parseAmount(firstInput.value||0); const totalPref=parseAmount($('#planTotal').value||0); const target= totalPref>0 ? totalPref : (REDIST_SNAPSHOT!=null? REDIST_SNAPSHOT : sumCurrentAmounts()); const rest=redistribute(target,first,rows.length-1).slice(1); rest.forEach((amt,i)=>{ const inp=rows[i+1].querySelector('.ech-montant'); if(inp) inp.value=amt; }); refreshKPIs();
  });

  $('#btnPlanifier').onclick=()=>{
    const startVal=$('#planStart').value; const n=parseInt($('#planCount').value||'0',10); const total=parseAmount($('#planTotal').value||0);
    if(!startVal || !n || n<1){ alert('Indique une date de départ et un nombre d\'échéances.'); return; }
    const start=new Date(startVal); const amounts= total>0 ? splitEven(total,n) : null;
    for(let i=0;i<n;i++){ const d=addMonthsSameDay(start,i); addEcheanceRowFromData({date:toYMD(d), montant: amounts?amounts[i]:0, paye:false}); }
    refreshKPIs();
  };

  // ========= Liste =========
  const tbody=$('#tab tbody');
  function renderList(){
    const q=$('#q').value.toLowerCase(); const fltS=$('#fltStatut').value; const fltA=$('#fltAnnee').value.trim().toLowerCase(); const fltR=$('#fltResp').value.trim().toLowerCase();
    const rows=loadAll().filter(r=>{ const hay=[r.nom,r.prenom,r.formation,r.annee,r.responsable,r.financement,r.email].join(' ').toLowerCase(); if(q && !hay.includes(q)) return false; if(fltS && r.statut!==fltS) return false; if(fltA && (r.annee||'').toLowerCase()!==fltA) return false; if(fltR && (r.responsable||'').toLowerCase()!==fltR) return false; return true; }).sort((a,b)=>(b.updatedAt||0)-(a.updatedAt||0));
    tbody.innerHTML='';
    for(const r of rows){ const t=computeTotals(r.echeances||[]); const tr=document.createElement('tr'); const overdue=(t.retard||0)>0; tr.innerHTML=`
      <td class="${overdue?'overdue':''}"><div style="font-weight:600">${r.nom||''} ${r.prenom||''}</div><div class="sub" style="font-size:12px">${r.email||'—'}</div></td>
      <td><div>${r.formation||'—'}</div><div class="sub">${r.annee||'—'}</div></td>
      <td>${r.responsable||'—'}</td>
      <td>${badgeStatut(r.statut)}</td>
      <td>${r.financement||'—'}</td>
      <td>${fmtEUR(t.total)}</td>
      <td>${fmtEUR(t.paye)}</td>
      <td>${fmtEUR(t.restant)}</td>
      <td>${t.prochaine? t.prochaine.toLocaleDateString('fr-FR') : '—'}</td>
      <td><div style="display:flex;gap:6px;flex-wrap:wrap"><button class="btn" data-act="edit">Ouvrir</button><button class="btn good" data-act="paid">Tout payé</button><button class="btn warn" data-act="relance" ${overdue?'':'disabled'}>Relancer</button><button class="btn bad" data-act="del">Suppr.</button></div></td>`;
      tr.querySelector('[data-act="edit"]').onclick=()=> fillForm(r);
      tr.querySelector('[data-act="paid"]').onclick=()=>{ r.echeances=(r.echeances||[]).map(e=>({...e,paye:true})); r.updatedAt=Date.now(); persist(r); renderList(); };
      tr.querySelector('[data-act="relance"]').onclick=()=> sendReminder(r);
      tr.querySelector('[data-act="del"]').onclick=()=>{ if(confirm('Supprimer cette fiche ?')){ removeById(r.id); renderList(); } };
      tbody.appendChild(tr);
    }
  }
  function badgeStatut(s){ if(s==='Inscription ferme') return `<span class="tag ok">${s}</span>`; if(s==='En attente') return `<span class="tag wait">${s}</span>`; if(s==='Abandon' || s==='Refusé') return `<span class="tag no">${s}</span>`; return `<span class="tag">${s||'—'}</span>`; }
  function persist(r){ const all=loadAll(); const i=all.findIndex(x=>x.id===r.id); if(i>=0) all[i]=r; else all.push(r); saveAll(all); }
  function removeById(id){ const all=loadAll().filter(x=>x.id!==id); saveAll(all); }

  // ========= Export / Import =========
  function toCSV(){ const all=loadAll(); const head=['id','nom','prenom','formation','annee','responsable','statut','financement','email','notes','echeances']; const lines=[head.join(',')]; for(const r of all){ const eJSON=JSON.stringify(r.echeances||[]).replaceAll('"','""'); const row=[r.id,r.nom,r.prenom,r.formation,r.annee,r.responsable,r.statut,r.financement,r.email,(r.notes||'').replaceAll('\n',' ').replaceAll('"','""'),`"${eJSON}"`]; lines.push(row.map(x=>x==null?'':String(x)).join(',')); } const blob=new Blob([lines.join('\n')],{type:'text/csv;charset=utf-8'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='inscriptions.csv'; a.click(); }
  $('#btnExport').onclick=toCSV;
  $('#fileImport').addEventListener('change', async(e)=>{ const file=e.target.files[0]; if(!file) return; const text=await file.text(); const [head,...rows]=text.split(/\r?\n/).filter(Boolean); const idxEch=head.split(',').indexOf('echeances'); const out=rows.map(line=>{ const p=splitCSV(line); const o={id:p[0],nom:p[1],prenom:p[2],formation:p[3],annee:p[4],responsable:p[5],statut:p[6],financement:p[7],email:p[8],notes:p[9]}; try{o.echeances=JSON.parse(p[idxEch]||'[]')}catch{o.echeances=[]} o.createdAt=Date.now(); o.updatedAt=Date.now(); return o; }); saveAll(out); renderList(); alert('Import terminé.'); });
  function splitCSV(line){ const out=[]; let cur=''; let inQ=false; for(let i=0;i<line.length;i++){ const ch=line[i]; if(ch==='"'){ inQ=!inQ; continue; } if(ch===',' && !inQ){ out.push(cur); cur=''; } else cur+=ch; } out.push(cur); return out; }

  // ========= Relances =========
  function composeMail(to,subject,body){ const url=new URL('https://mail.google.com/mail/'); url.searchParams.set('view','cm'); url.searchParams.set('to',to); url.searchParams.set('su',subject); url.searchParams.set('body',body); window.open(url.toString(),'_blank'); }
  function sendReminder(rec){ const overdue=(rec.echeances||[]).filter(e=>{ if(e.paye) return false; if(!e.date) return false; const d=new Date(e.date); const today=new Date(new Date().toDateString()); return d<today; }); if(overdue.length===0){ alert('Aucune échéance en retard pour cette fiche.'); return; } const totalRetard=overdue.reduce((s,e)=> s+(e.montant||0),0); const list=overdue.map(e=>`• ${fmtDate(e.date)} — ${fmtEUR(e.montant)}`).join('\n'); const sujet=`[Relance] ${rec.nom} ${rec.prenom} – Échéances en retard (${fmtEUR(totalRetard)})`; const corps=`Bonjour,\n\nDossier: ${rec.nom} ${rec.prenom}\nFormation: ${rec.formation} (${rec.annee})\nResponsable: ${rec.responsable}\n\nÉchéances en retard :\n${list}\n\nMontant total en retard: ${fmtEUR(totalRetard)}\n\nNotes: ${rec.notes||'—'}\n\nMerci,\nMini-CRM Inscriptions`; composeMail('jessica@iticparis.com',sujet,corps); }
  $('#btnRelances').onclick=()=>{ const all=loadAll(); const withOverdue=all.filter(r=> (computeTotals(r.echeances||[]).retard||0)>0 ); if(withOverdue.length===0){ alert('Aucune relance à effectuer aujourd\'hui.'); return; } if(!confirm(`Préparer ${withOverdue.length} e-mail(s) de relance dans Gmail ?`)) return; withOverdue.forEach(sendReminder); };

  // ========= Init =========
  window.addEventListener('load',()=>{ try{populateSelect('f_formation',FORMATIONS)}catch(e){} try{populateSelect('f_responsable',RESPONSABLES)}catch(e){} try{populateSelect('f_financement',FINANCEMENTS)}catch(e){} try{populateSelect('f_annee',ANNEES,'2025-2026')}catch(e){} renderList(); fillForm(blankFiche()); $$('#section-form input, #section-form select, #section-form textarea').forEach(el=> el.addEventListener('input', refreshKPIs)); });

  // ========= Mini-tests (console) =========
  (function runTests(){ function assert(c,m){ if(!c){ console.error('Test failed:',m); throw new Error(m) } }
    assert(parseAmount('2,5')===2.5,'parseAmount virgule');
    assert(parseAmount('2.50')===2.5,'parseAmount point');
    const parts=splitEven(10,3); const sum=parts.reduce((a,b)=>a+b,0); assert(Math.abs(sum-10)<1e-9 && parts.length===3,'splitEven somme/len');
    const d0=new Date(2024,0,31); const d1=addMonthsSameDay(d0,1); assert(d1.getMonth()===1 && d1.getDate()>=28 && d1.getDate()<=29,'fin de mois');
    const r=splitCSV('a,"b,c",d'); assert(r.length===3 && r[1]==='b,c','splitCSV');
    const red=redistribute(6000,1000,2); assert(Math.abs(red[1]+red[2]-5000)<1e-9 && red[1]===2500 && red[2]===2500,'redistribute');
    console.log('%cTests OK','color:#10b981');
  })();
  </script>
  <noscript style="color:#fff;display:block;text-align:center;margin:10px 0">JavaScript désactivé : les listes sont disponibles en version statique.</noscript>
</body>
</html>
