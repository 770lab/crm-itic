<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestion Effectifs 2025-26</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:system-ui,-apple-system,sans-serif;background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%);min-height:100vh;color:#fff}
.app{max-width:1400px;margin:0 auto;padding:20px}
.header{display:flex;justify-content:space-between;align-items:center;padding:20px;background:rgba(255,255,255,0.05);border-radius:16px;margin-bottom:24px;backdrop-filter:blur(10px);flex-wrap:wrap;gap:12px}
.logo{display:flex;align-items:center;gap:12px}
.logo span{font-size:32px}
.logo h1{font-size:22px;font-weight:600}
.header-buttons{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.user-info{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,0.1);padding:8px 16px;border-radius:20px;font-size:14px}
.user-info span{color:#2ed573}
.btn{padding:12px 24px;border:none;border-radius:12px;font-size:14px;font-weight:600;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;gap:8px}
.btn-primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(102,126,234,0.4)}
.btn-secondary{background:rgba(255,255,255,0.1);color:#fff}
.btn-secondary:hover{background:rgba(255,255,255,0.15)}
.btn-success{background:linear-gradient(135deg,#2ed573 0%,#7bed9f 100%);color:#1a1a2e}
.btn-success:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(46,213,115,0.4)}
.btn-warning{background:linear-gradient(135deg,#ff9f43 0%,#ffc048 100%);color:#1a1a2e}
.btn-warning:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(255,159,67,0.4)}
.btn-danger{background:rgba(255,71,87,0.2);color:#ff4757}
.btn-danger:hover{background:rgba(255,71,87,0.3)}
.btn-sm{padding:8px 16px;font-size:13px}
.btn:disabled{opacity:0.5;cursor:not-allowed;transform:none!important}
.dashboard{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;margin-bottom:24px}
.stat-card{background:rgba(255,255,255,0.05);border-radius:16px;padding:24px;display:flex;align-items:center;gap:16px;border:1px solid rgba(255,255,255,0.1);transition:all 0.3s}
.stat-card:hover{transform:translateY(-4px);border-color:rgba(255,255,255,0.2)}
.stat-icon{width:56px;height:56px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px}
.stat-icon.blue{background:rgba(102,126,234,0.2)}
.stat-icon.green{background:rgba(46,213,115,0.2)}
.stat-icon.orange{background:rgba(255,159,67,0.2)}
.stat-icon.red{background:rgba(255,71,87,0.2)}
.stat-value{font-size:28px;font-weight:700;display:block}
.stat-label{font-size:14px;color:rgba(255,255,255,0.6)}
.filters{display:flex;gap:16px;margin-bottom:24px;flex-wrap:wrap;align-items:center}
.search-box{flex:1;min-width:250px;display:flex;align-items:center;background:rgba(255,255,255,0.05);border-radius:12px;padding:0 16px;border:1px solid rgba(255,255,255,0.1)}
.search-box input{flex:1;background:none;border:none;padding:14px;color:#fff;font-size:14px;outline:none}
.search-box input::placeholder{color:rgba(255,255,255,0.4)}
.filters select{padding:14px 20px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:12px;color:#fff;font-size:14px;cursor:pointer}
.filters select option{background:#1a1a2e}
.students-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:20px}
.student-card{background:rgba(255,255,255,0.05);border-radius:16px;padding:24px;border:1px solid rgba(255,255,255,0.1);transition:all 0.3s;cursor:pointer}
.student-card:hover{transform:translateY(-5px);border-color:rgba(102,126,234,0.5);box-shadow:0 20px 40px rgba(0,0,0,0.3)}
.student-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px}
.student-name{font-size:18px;font-weight:600;margin-bottom:6px}
.student-formation{font-size:12px;color:rgba(255,255,255,0.7);background:rgba(102,126,234,0.2);padding:4px 10px;border-radius:20px;display:inline-block}
.status-badge{padding:6px 12px;border-radius:20px;font-size:11px;font-weight:600}
.status-badge.ok{background:rgba(46,213,115,0.2);color:#2ed573}
.status-badge.pending{background:rgba(255,159,67,0.2);color:#ff9f43}
.status-badge.late{background:rgba(255,71,87,0.2);color:#ff4757}
.student-details{margin-bottom:16px}
.detail-row{display:flex;align-items:center;gap:8px;font-size:14px;color:rgba(255,255,255,0.7);margin-bottom:8px}
.payment-progress{background:rgba(255,255,255,0.1);height:8px;border-radius:4px;overflow:hidden}
.payment-bar{height:100%;border-radius:4px;transition:width 0.5s}
.payment-bar.ok{background:linear-gradient(90deg,#2ed573,#7bed9f)}
.payment-bar.pending{background:linear-gradient(90deg,#ff9f43,#ffc048)}
.payment-bar.late{background:linear-gradient(90deg,#ff4757,#ff6b81)}
.payment-info{display:flex;justify-content:space-between;margin-top:10px;font-size:13px;color:rgba(255,255,255,0.6)}

/* Login */
.login-container{display:flex;justify-content:center;align-items:center;min-height:100vh;padding:20px}
.login-box{background:rgba(255,255,255,0.05);border-radius:20px;padding:40px;width:100%;max-width:400px;border:1px solid rgba(255,255,255,0.1)}
.login-box h1{text-align:center;margin-bottom:10px;font-size:28px}
.login-box .subtitle{text-align:center;color:rgba(255,255,255,0.6);margin-bottom:30px}
.login-box .form-group{margin-bottom:20px}
.login-box label{display:block;margin-bottom:8px;font-size:14px;font-weight:500}
.login-box input{width:100%;padding:14px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:12px;color:#fff;font-size:15px}
.login-box input:focus{outline:none;border-color:#667eea}
.login-box .btn{width:100%;justify-content:center;padding:16px}
.login-error{background:rgba(255,71,87,0.2);color:#ff4757;padding:12px;border-radius:10px;margin-bottom:20px;text-align:center;display:none}
.login-footer{text-align:center;margin-top:30px;color:rgba(255,255,255,0.4);font-size:13px}
.login-footer a{color:#667eea;text-decoration:none}

/* Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:none;justify-content:center;align-items:center;z-index:1000;backdrop-filter:blur(5px);padding:20px}
.modal-overlay.active{display:flex}
.modal{background:linear-gradient(135deg,#1a1a2e,#16213e);border-radius:20px;width:100%;max-width:700px;max-height:90vh;overflow-y:auto;border:1px solid rgba(255,255,255,0.1)}
.modal-header{display:flex;justify-content:space-between;align-items:center;padding:24px;border-bottom:1px solid rgba(255,255,255,0.1)}
.modal-header h2{font-size:20px;font-weight:600}
.close-btn{width:36px;height:36px;border:none;background:rgba(255,255,255,0.1);color:#fff;border-radius:50%;font-size:24px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.close-btn:hover{background:rgba(255,255,255,0.2)}
.modal-body{padding:24px}
.form-group{margin-bottom:20px}
.form-group label{display:block;margin-bottom:10px;font-size:14px;font-weight:500}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:14px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:12px;color:#fff;font-size:14px;outline:none;transition:border-color 0.3s}
.form-group input:focus,.form-group textarea:focus{border-color:#667eea}
.form-group textarea{min-height:80px;resize:vertical;font-family:inherit}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.modal-footer{padding:24px;border-top:1px solid rgba(255,255,255,0.1);display:flex;justify-content:flex-end;gap:12px}

/* D√©tail √©tudiant */
.student-profile{text-align:center;padding-bottom:20px;border-bottom:1px solid rgba(255,255,255,0.1);margin-bottom:20px}
.student-avatar{width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);display:flex;align-items:center;justify-content:center;font-size:32px;margin:0 auto 16px;font-weight:700}
.student-profile h3{font-size:24px;font-weight:600;margin-bottom:8px}
.info-section{margin-bottom:24px}
.info-section h4{font-size:14px;color:rgba(255,255,255,0.5);text-transform:uppercase;letter-spacing:1px;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.info-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.info-item{background:rgba(255,255,255,0.03);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.05)}
.info-item.full{grid-column:1/-1}
.info-label{font-size:12px;color:rgba(255,255,255,0.5);margin-bottom:6px}
.info-value{font-size:15px;font-weight:500}
.info-value a{color:#667eea;text-decoration:none}
.payment-detail .payment-progress{height:12px;margin-bottom:12px}
.payment-stats{display:flex;justify-content:space-between;font-size:14px}
.payment-stats .paid{color:#2ed573}
.payment-stats .remaining{color:#ff9f43}
.status-section{display:flex;align-items:center;justify-content:center;gap:12px;padding:16px;background:rgba(255,255,255,0.03);border-radius:12px;margin-bottom:20px}
.status-section .status-badge{font-size:14px;padding:8px 20px}
.meta-info{font-size:12px;color:rgba(255,255,255,0.4);text-align:center;margin-top:20px;padding-top:20px;border-top:1px solid rgba(255,255,255,0.1)}
.notes-section textarea{width:100%;min-height:80px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:12px;color:#fff;padding:14px;font-size:14px;resize:vertical;font-family:inherit}
.edit-input{width:100%;padding:12px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:10px;color:#fff;font-size:14px;margin-top:6px}
.edit-input:focus{outline:none;border-color:#667eea}

/* √âch√©ancier */
.echeances-section{background:rgba(255,255,255,0.03);border-radius:12px;padding:16px;margin-top:12px}
.echeances-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:10px}
.echeances-stats{display:flex;gap:16px}
.echeances-stats .stat{text-align:center}
.echeances-stats .stat-value{font-size:18px;font-weight:700}
.echeances-stats .stat-value.green{color:#2ed573}
.echeances-stats .stat-value.orange{color:#ff9f43}
.echeances-stats .stat-label{font-size:10px;color:rgba(255,255,255,0.5)}
.echeances-list{max-height:250px;overflow-y:auto}
.echeance-item{display:flex;align-items:center;gap:12px;padding:10px 12px;background:rgba(255,255,255,0.02);border-radius:8px;margin-bottom:6px}
.echeance-item.paid{opacity:0.5}
.echeance-check{width:20px;height:20px;border-radius:5px;border:2px solid rgba(255,255,255,0.3);cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.echeance-check.checked{background:#2ed573;border-color:#2ed573}
.echeance-check.checked::after{content:"‚úì";color:#fff;font-size:12px}
.echeance-date{font-size:13px;min-width:90px}
.echeance-amount{font-weight:600;color:#ff9f43;min-width:70px}
.echeance-amount.paid{color:#2ed573}
.echeance-type{font-size:11px;color:rgba(255,255,255,0.4)}
.echeances-raw{background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;font-size:13px;color:rgba(255,255,255,0.7);white-space:pre-wrap;word-break:break-word}

/* Import */
.import-zone{border:2px dashed rgba(102,126,234,0.4);border-radius:16px;padding:40px;text-align:center;margin-bottom:20px;transition:all 0.3s;cursor:pointer}
.import-zone:hover,.import-zone.dragover{border-color:#667eea;background:rgba(102,126,234,0.1)}
.import-zone input{display:none}
.import-stats{display:flex;gap:20px;justify-content:center;margin:20px 0}
.import-stat{background:rgba(255,255,255,0.05);padding:12px 24px;border-radius:10px;text-align:center}
.import-stat-value{font-size:24px;font-weight:700;color:#667eea}
.import-stat-label{font-size:12px;color:rgba(255,255,255,0.5)}
.import-preview{background:rgba(255,255,255,0.03);border-radius:12px;padding:16px;max-height:200px;overflow-y:auto}
.import-preview table{width:100%;font-size:12px;border-collapse:collapse}
.import-preview th,.import-preview td{padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.1)}

/* Historique */
.history-list{max-height:400px;overflow-y:auto}
.history-item{display:flex;gap:16px;padding:12px 0;border-bottom:1px solid rgba(255,255,255,0.05)}
.history-item:last-child{border-bottom:none}
.history-date{font-size:12px;color:rgba(255,255,255,0.4);min-width:130px}
.history-user{font-size:13px;color:#667eea;min-width:80px}
.history-action{font-size:13px;font-weight:500;min-width:100px}
.history-action.creation{color:#2ed573}
.history-action.modification{color:#ff9f43}
.history-action.suppression{color:#ff4757}
.history-action.import{color:#667eea}
.history-details{font-size:13px;color:rgba(255,255,255,0.6)}

/* Toast */
.toast{position:fixed;bottom:30px;right:30px;background:#2ed573;color:#1a1a2e;padding:16px 24px;border-radius:12px;font-weight:600;transform:translateY(100px);opacity:0;transition:all 0.3s;z-index:2000}
.toast.show{transform:translateY(0);opacity:1}
.toast.error{background:#ff4757;color:#fff}

/* Loading */
.loading{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);justify-content:center;align-items:center;z-index:3000}
.loading.active{display:flex}
.spinner{width:50px;height:50px;border:4px solid rgba(255,255,255,0.1);border-top-color:#667eea;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Footer */
.footer{text-align:center;padding:20px;color:rgba(255,255,255,0.4);font-size:13px}
.footer a{color:#667eea;text-decoration:none;font-weight:600}

@media(max-width:900px){.dashboard{grid-template-columns:repeat(2,1fr)}.info-grid{grid-template-columns:1fr}.form-row{grid-template-columns:1fr}}
@media(max-width:600px){.dashboard{grid-template-columns:1fr}.header{flex-direction:column;text-align:center}.header-buttons{justify-content:center}}
</style>
</head>
<body>

<!-- PAGE LOGIN -->
<div id="loginPage" class="login-container">
    <div class="login-box">
        <h1>üéì Gestion Effectifs</h1>
        <p class="subtitle">2025-26</p>
        <div class="login-error" id="loginError">Identifiants incorrects</div>
        <div class="form-group">
            <label>Nom d'utilisateur</label>
            <input type="text" id="loginUsername" placeholder="Votre identifiant">
        </div>
        <div class="form-group">
            <label>Mot de passe</label>
            <input type="password" id="loginPassword" placeholder="Votre mot de passe" onkeypress="if(event.key==='Enter')login()">
        </div>
        <button class="btn btn-primary" onclick="login()">üîê Se connecter</button>
        <div class="login-footer">Propuls√© par <a href="https://770lab.com" target="_blank">770 Lab</a></div>
    </div>
</div>

<!-- PAGE PRINCIPALE -->
<div id="mainPage" class="app" style="display:none">
    <header class="header">
        <div class="logo"><span>üéì</span><h1>Gestion Effectifs 2025-26</h1></div>
        <div class="header-buttons">
            <div class="user-info">üë§ <span id="currentUser">-</span></div>
            <button class="btn btn-success btn-sm" onclick="openImportModal()">üì• Importer</button>
            <button class="btn btn-secondary btn-sm" onclick="openHistoryModal()">üìú Historique</button>
            <button class="btn btn-primary btn-sm" onclick="openModal()">+ Nouvel √©tudiant</button>
            <button class="btn btn-danger btn-sm" onclick="logout()">üö™</button>
        </div>
    </header>
    
    <div class="dashboard">
        <div class="stat-card"><div class="stat-icon blue">üë•</div><div><span class="stat-value" id="totalCount">0</span><span class="stat-label">√âtudiants</span></div></div>
        <div class="stat-card"><div class="stat-icon green">‚úÖ</div><div><span class="stat-value" id="okCount">0</span><span class="stat-label">√Ä jour</span></div></div>
        <div class="stat-card"><div class="stat-icon orange">‚è≥</div><div><span class="stat-value" id="pendingCount">0</span><span class="stat-label">En attente</span></div></div>
        <div class="stat-card"><div class="stat-icon red">‚ö†Ô∏è</div><div><span class="stat-value" id="lateCount">0</span><span class="stat-label">Retard</span></div></div>
    </div>
    
    <div class="filters">
        <div class="search-box"><span>üîç</span><input type="text" id="searchInput" placeholder="Rechercher un √©tudiant..." oninput="renderStudents()"></div>
        <select id="formationFilter" onchange="renderStudents()"><option value="">Toutes formations</option></select>
        <select id="statusFilter" onchange="renderStudents()"><option value="">Tous statuts</option><option value="ok">‚úÖ √Ä jour</option><option value="pending">‚è≥ En attente</option><option value="late">‚ö†Ô∏è En retard</option></select>
        <button class="btn btn-secondary btn-sm" onclick="loadStudents()">üîÑ Actualiser</button>
    </div>
    
    <div class="students-grid" id="studentsGrid"></div>
    
    <div class="footer">Propuls√© par <a href="https://770lab.com" target="_blank">770 Lab</a></div>
</div>

<!-- MODAL NOUVEL √âTUDIANT -->
<div class="modal-overlay" id="modalOverlay" onclick="closeModal()">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-header"><h2>üìù Nouvel √©tudiant</h2><button class="close-btn" onclick="closeModal()">√ó</button></div>
        <div class="modal-body">
            <div class="form-row">
                <div class="form-group"><label>Nom</label><input type="text" id="studentNom" placeholder="NOM"></div>
                <div class="form-group"><label>Pr√©nom</label><input type="text" id="studentPrenom" placeholder="Pr√©nom"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Formation</label><input type="text" id="studentFormation" placeholder="Ex: M1 INFO CS"></div>
                <div class="form-group"><label>Rythme</label><select id="studentRythme"><option value="IOA">IOA</option><option value="Initiale">Initiale</option><option value="Alternance">Alternance</option><option value="SFP">SFP</option></select></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>T√©l√©phone</label><input type="text" id="studentPhone" placeholder="0612345678"></div>
                <div class="form-group"><label>Banque</label><input type="text" id="studentBank" placeholder="BNP, LCL, SG..."></div>
            </div>
            <div class="form-group">
                <label>√âch√©ances</label>
                <textarea id="studentEcheances" placeholder="Ex: 760 le 5/9/25 puis 323 du 5/10/25 au 5/6/26" oninput="previewEcheances(this.value)"></textarea>
                <div id="echeancesPreview" class="echeances-section" style="display:none"></div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Annuler</button>
            <button class="btn btn-primary" onclick="saveStudent()">üíæ Enregistrer</button>
        </div>
    </div>
</div>

<!-- MODAL D√âTAIL √âTUDIANT -->
<div class="modal-overlay" id="detailModal" onclick="closeDetailModal()">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-header"><h2>üë§ Fiche √©tudiant</h2><button class="close-btn" onclick="closeDetailModal()">√ó</button></div>
        <div class="modal-body" id="detailContent"></div>
        <div class="modal-footer" id="detailFooter"></div>
    </div>
</div>

<!-- MODAL IMPORT -->
<div class="modal-overlay" id="importModal" onclick="closeImportModal()">
    <div class="modal" onclick="event.stopPropagation()" style="max-width:800px">
        <div class="modal-header"><h2>üì• Importer des donn√©es</h2><button class="close-btn" onclick="closeImportModal()">√ó</button></div>
        <div class="modal-body">
            <div class="import-zone" id="importZone" onclick="document.getElementById('fileInput').click()">
                <span style="font-size:48px">üìÑ</span>
                <p style="color:rgba(255,255,255,0.6);margin-top:10px">Cliquez ou glissez un fichier CSV/TSV</p>
                <input type="file" id="fileInput" accept=".csv,.tsv,.txt" onchange="handleFileSelect(event)">
            </div>
            <div id="importPreview" style="display:none">
                <div class="import-stats">
                    <div class="import-stat"><div class="import-stat-value" id="previewCount">0</div><div class="import-stat-label">D√©tect√©s</div></div>
                    <div class="import-stat"><div class="import-stat-value" id="previewNew">0</div><div class="import-stat-label">Nouveaux</div></div>
                    <div class="import-stat"><div class="import-stat-value" id="previewUpdate">0</div><div class="import-stat-label">M√†j</div></div>
                </div>
                <div class="import-preview"><table><thead><tr><th>Nom</th><th>Formation</th><th>Rythme</th><th>T√©l</th></tr></thead><tbody id="previewTable"></tbody></table></div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeImportModal()">Annuler</button>
            <button class="btn btn-primary" id="importBtn" onclick="confirmImport()" disabled>üì• Importer</button>
        </div>
    </div>
</div>

<!-- MODAL HISTORIQUE -->
<div class="modal-overlay" id="historyModal" onclick="closeHistoryModal()">
    <div class="modal" onclick="event.stopPropagation()" style="max-width:800px">
        <div class="modal-header"><h2>üìú Historique des modifications</h2><button class="close-btn" onclick="closeHistoryModal()">√ó</button></div>
        <div class="modal-body">
            <div class="history-list" id="historyList"></div>
        </div>
    </div>
</div>

<!-- TOAST & LOADING -->
<div class="toast" id="toast"></div>
<div class="loading" id="loading"><div class="spinner"></div></div>

<script>
// ==========================================
// CONFIGURATION - REMPLACEZ CETTE URL
// ==========================================
const API_URL = 'VOTRE_URL_APPS_SCRIPT';

let students = [];
let currentUser = null;
let currentStudentId = null;
let pendingImport = [];

// ==========================================
// AUTHENTIFICATION
// ==========================================
function login() {
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;
    
    if (!username || !password) {
        showLoginError('Veuillez remplir tous les champs');
        return;
    }
    
    // Mode test si l'API n'est pas configur√©e
    if (API_URL === 'VOTRE_URL_APPS_SCRIPT') {
        currentUser = { username: username, role: 'admin' };
        localStorage.setItem('user', JSON.stringify(currentUser));
        showMainPage();
        showToast('‚ö†Ô∏è Mode test - Configurez l\'API pour la prod', true);
        return;
    }
    
    showLoading(true);
    
    fetch(`${API_URL}?action=login&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`)
        .then(r => r.json())
        .then(data => {
            showLoading(false);
            if (data.success) {
                currentUser = data.user;
                localStorage.setItem('user', JSON.stringify(currentUser));
                showMainPage();
            } else {
                showLoginError(data.error || 'Identifiants incorrects');
            }
        })
        .catch(err => {
            showLoading(false);
            showLoginError('Erreur de connexion au serveur');
        });
}

function logout() {
    currentUser = null;
    localStorage.removeItem('user');
    document.getElementById('loginPage').style.display = 'flex';
    document.getElementById('mainPage').style.display = 'none';
    document.getElementById('loginUsername').value = '';
    document.getElementById('loginPassword').value = '';
}

function showLoginError(msg) {
    const el = document.getElementById('loginError');
    el.textContent = msg;
    el.style.display = 'block';
}

function showMainPage() {
    document.getElementById('loginPage').style.display = 'none';
    document.getElementById('mainPage').style.display = 'block';
    document.getElementById('currentUser').textContent = currentUser.username;
    document.getElementById('loginError').style.display = 'none';
    loadStudents();
}

// ==========================================
// CHARGEMENT DES DONN√âES
// ==========================================
function loadStudents() {
    // Mode test
    if (API_URL === 'VOTRE_URL_APPS_SCRIPT') {
        students = JSON.parse(localStorage.getItem('students_test') || '[]');
        updateStats();
        updateFormationFilter();
        renderStudents();
        return;
    }
    
    showLoading(true);
    
    fetch(`${API_URL}?action=getStudents`)
        .then(r => r.json())
        .then(data => {
            showLoading(false);
            if (data.success) {
                students = data.students;
                students.sort((a, b) => (a.nom || '').localeCompare(b.nom || '', 'fr'));
                updateStats();
                updateFormationFilter();
                renderStudents();
            } else {
                showToast('Erreur: ' + data.error, true);
            }
        })
        .catch(err => {
            showLoading(false);
            showToast('Erreur de connexion', true);
        });
}

function saveToServer(student, callback) {
    // Mode test
    if (API_URL === 'VOTRE_URL_APPS_SCRIPT') {
        const now = new Date().toLocaleString('fr-FR');
        if (!student.id) {
            student.id = Date.now();
            student.creePar = currentUser.username;
            student.creeDate = now;
        }
        student.modifiePar = currentUser.username;
        student.modifieDate = now;
        
        const idx = students.findIndex(s => s.id === student.id);
        if (idx >= 0) students[idx] = student;
        else students.push(student);
        
        localStorage.setItem('students_test', JSON.stringify(students));
        if (callback) callback({ success: true, student: student });
        return;
    }
    
    showLoading(true);
    fetch(`${API_URL}?action=saveStudent&user=${encodeURIComponent(currentUser.username)}&data=${encodeURIComponent(JSON.stringify(student))}`)
        .then(r => r.json())
        .then(data => {
            showLoading(false);
            if (callback) callback(data);
        })
        .catch(err => {
            showLoading(false);
            showToast('Erreur de connexion', true);
        });
}

function deleteFromServer(id, callback) {
    // Mode test
    if (API_URL === 'VOTRE_URL_APPS_SCRIPT') {
        students = students.filter(s => s.id !== id);
        localStorage.setItem('students_test', JSON.stringify(students));
        if (callback) callback({ success: true });
        return;
    }
    
    showLoading(true);
    fetch(`${API_URL}?action=deleteStudent&id=${id}&user=${encodeURIComponent(currentUser.username)}`)
        .then(r => r.json())
        .then(data => {
            showLoading(false);
            if (callback) callback(data);
        });
}

function updateStats() {
    document.getElementById('totalCount').textContent = students.length;
    document.getElementById('okCount').textContent = students.filter(s => s.status === 'ok').length;
    document.getElementById('pendingCount').textContent = students.filter(s => s.status === 'pending').length;
    document.getElementById('lateCount').textContent = students.filter(s => s.status === 'late').length;
}

function updateFormationFilter() {
    const formations = [...new Set(students.map(s => s.formation).filter(f => f))].sort();
    const select = document.getElementById('formationFilter');
    const current = select.value;
    select.innerHTML = '<option value="">Toutes formations</option>' + formations.map(f => `<option value="${f}">${f}</option>`).join('');
    select.value = current;
}

function renderStudents() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const formation = document.getElementById('formationFilter').value;
    const status = document.getElementById('statusFilter').value;
    
    const filtered = students.filter(s => {
        const matchSearch = (s.nom || '').toLowerCase().includes(search) || (s.telephone || '').includes(search);
        const matchFormation = !formation || s.formation === formation;
        const matchStatus = !status || s.status === status;
        return matchSearch && matchFormation && matchStatus;
    });
    
    const grid = document.getElementById('studentsGrid');
    
    if (filtered.length === 0) {
        grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:60px;color:rgba(255,255,255,0.4)"><span style="font-size:64px;display:block;margin-bottom:20px">üì≠</span>Aucun √©tudiant trouv√©</div>';
        return;
    }
    
    grid.innerHTML = filtered.map(s => {
        const pct = s.total > 0 ? Math.round((s.paid || 0) / s.total * 100) : 0;
        const statusText = s.status === 'ok' ? '‚úÖ √Ä jour' : s.status === 'pending' ? '‚è≥ En attente' : '‚ö†Ô∏è En retard';
        return `
            <div class="student-card" onclick="openDetailModal('${s.id}')">
                <div class="student-header">
                    <div><div class="student-name">${s.nom || 'Sans nom'}</div><span class="student-formation">${s.formation || '-'}</span></div>
                    <span class="status-badge ${s.status || 'pending'}">${statusText}</span>
                </div>
                <div class="student-details">
                    <div class="detail-row">üìû ${s.telephone || 'Non renseign√©'}</div>
                    <div class="detail-row">üìö ${s.rythme || '-'}</div>
                </div>
                <div class="payment-progress"><div class="payment-bar ${s.status || 'pending'}" style="width:${pct}%"></div></div>
                <div class="payment-info"><span>${s.paid || 0}‚Ç¨ pay√©s</span><span>${s.total || 0}‚Ç¨ total</span></div>
            </div>
        `;
    }).join('');
}

// ==========================================
// MODAL NOUVEL √âTUDIANT
// ==========================================
function openModal() {
    document.getElementById('studentNom').value = '';
    document.getElementById('studentPrenom').value = '';
    document.getElementById('studentFormation').value = '';
    document.getElementById('studentRythme').value = 'IOA';
    document.getElementById('studentPhone').value = '';
    document.getElementById('studentBank').value = '';
    document.getElementById('studentEcheances').value = '';
    document.getElementById('echeancesPreview').style.display = 'none';
    document.getElementById('modalOverlay').classList.add('active');
}

function closeModal() {
    document.getElementById('modalOverlay').classList.remove('active');
}

function saveStudent() {
    const nom = document.getElementById('studentNom').value.trim();
    const prenom = document.getElementById('studentPrenom').value.trim();
    const fullName = (nom + ' ' + prenom).trim();
    
    if (!fullName) {
        showToast('Veuillez remplir le nom', true);
        return;
    }
    
    const echeancesRaw = document.getElementById('studentEcheances').value.trim();
    const parsed = parseEcheances(echeancesRaw);
    
    const student = {
        nom: fullName,
        formation: document.getElementById('studentFormation').value.trim(),
        rythme: document.getElementById('studentRythme').value,
        telephone: document.getElementById('studentPhone').value.trim().replace(/[^0-9]/g, ''),
        banque: document.getElementById('studentBank').value.trim(),
        echeancesRaw: echeancesRaw,
        status: 'pending',
        paid: parsed.paid,
        total: parsed.total
    };
    
    saveToServer(student, (data) => {
        if (data.success) {
            closeModal();
            loadStudents();
            showToast('‚úÖ ' + fullName + ' enregistr√©!');
        } else {
            showToast('Erreur: ' + data.error, true);
        }
    });
}

// ==========================================
// MODAL D√âTAIL √âTUDIANT
// ==========================================
function openDetailModal(id) {
    currentStudentId = id;
    const s = students.find(st => st.id == id);
    if (!s) return;
    
    const pct = s.total > 0 ? Math.round((s.paid || 0) / s.total * 100) : 0;
    const remaining = (s.total || 0) - (s.paid || 0);
    const statusText = s.status === 'ok' ? '‚úÖ √Ä jour' : s.status === 'pending' ? '‚è≥ En attente' : '‚ö†Ô∏è En retard';
    const initials = (s.nom || 'XX').split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
    
    // Parser les √©ch√©ances
    const parsed = parseEcheances(s.echeancesRaw || '');
    let echeancesHtml = '';
    if (parsed.echeances.length > 0) {
        echeancesHtml = `
            <div class="echeances-section">
                <div class="echeances-header">
                    <div class="echeances-stats">
                        <div class="stat"><div class="stat-value green">${parsed.paid}‚Ç¨</div><div class="stat-label">Pay√©</div></div>
                        <div class="stat"><div class="stat-value orange">${parsed.remaining}‚Ç¨</div><div class="stat-label">Restant</div></div>
                    </div>
                </div>
                <div class="echeances-list">
                    ${parsed.echeances.map((e, i) => `
                        <div class="echeance-item ${e.paid ? 'paid' : ''}">
                            <div class="echeance-check ${e.paid ? 'checked' : ''}"></div>
                            <div class="echeance-date">${e.label || formatDate(e.date)}</div>
                            <div class="echeance-amount ${e.paid ? 'paid' : ''}">${e.montant.toFixed(0)}‚Ç¨</div>
                            <div class="echeance-type">${e.type}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    } else if (s.echeancesRaw) {
        echeancesHtml = `<div class="echeances-raw">${s.echeancesRaw}</div>`;
    } else {
        echeancesHtml = '<p style="color:rgba(255,255,255,0.4);font-style:italic">Aucune √©ch√©ance d√©finie</p>';
    }
    
    const html = `
        <div class="student-profile">
            <div class="student-avatar">${initials}</div>
            <h3>${s.nom || 'Sans nom'}</h3>
            <span class="student-formation">${s.formation || '-'}</span>
        </div>
        <div class="status-section">
            <span>Statut:</span>
            <span class="status-badge ${s.status || 'pending'}">${statusText}</span>
        </div>
        <div class="info-section">
            <h4>üìã Informations</h4>
            <div class="info-grid">
                <div class="info-item"><div class="info-label">T√©l√©phone</div><div class="info-value"><a href="tel:${s.telephone}">${s.telephone || '-'}</a></div></div>
                <div class="info-item"><div class="info-label">Rythme</div><div class="info-value">${s.rythme || '-'}</div></div>
                <div class="info-item"><div class="info-label">Banque</div><div class="info-value">${s.banque || '-'}</div></div>
                <div class="info-item"><div class="info-label">Formation</div><div class="info-value">${s.formation || '-'}</div></div>
            </div>
        </div>
        <div class="info-section">
            <h4>üí≥ Situation financi√®re</h4>
            <div class="payment-detail">
                <div class="payment-progress"><div class="payment-bar ${s.status || 'pending'}" style="width:${pct}%"></div></div>
                <div class="payment-stats">
                    <span class="paid">${s.paid || 0}‚Ç¨ pay√©s (${pct}%)</span>
                    <span class="remaining">${remaining}‚Ç¨ restant</span>
                </div>
            </div>
        </div>
        <div class="info-section">
            <h4>üìÖ √âch√©ances</h4>
            ${echeancesHtml}
        </div>
        <div class="info-section">
            <h4>üìù Notes</h4>
            <textarea id="studentNotes" class="notes-section" placeholder="Ajouter des notes...">${s.notes || ''}</textarea>
        </div>
        <div class="meta-info">
            Cr√©√© par <strong>${s.creePar || '-'}</strong> le ${s.creeDate || '-'}<br>
            Modifi√© par <strong>${s.modifiePar || '-'}</strong> le ${s.modifieDate || '-'}
        </div>
    `;
    
    document.getElementById('detailContent').innerHTML = html;
    document.getElementById('detailFooter').innerHTML = `
        <button class="btn btn-danger" onclick="deleteStudent()">üóëÔ∏è Supprimer</button>
        <button class="btn btn-secondary" onclick="closeDetailModal()">Fermer</button>
        <button class="btn btn-primary" onclick="editStudent()">‚úèÔ∏è Modifier</button>
    `;
    document.getElementById('detailModal').classList.add('active');
}

function closeDetailModal() {
    if (currentStudentId) {
        const notesEl = document.getElementById('studentNotes');
        if (notesEl) {
            const s = students.find(st => st.id == currentStudentId);
            if (s && s.notes !== notesEl.value) {
                s.notes = notesEl.value;
                saveToServer(s, () => {});
            }
        }
    }
    document.getElementById('detailModal').classList.remove('active');
    currentStudentId = null;
}

function editStudent() {
    const s = students.find(st => st.id == currentStudentId);
    if (!s) return;
    
    const statusOptions = ['ok', 'pending', 'late'].map(v => 
        `<option value="${v}" ${s.status === v ? 'selected' : ''}>${v === 'ok' ? '‚úÖ √Ä jour' : v === 'pending' ? '‚è≥ En attente' : '‚ö†Ô∏è En retard'}</option>`
    ).join('');
    
    const rythmeOptions = ['IOA', 'Initiale', 'Alternance', 'SFP'].map(v =>
        `<option value="${v}" ${s.rythme === v ? 'selected' : ''}>${v}</option>`
    ).join('');
    
    const html = `
        <div class="form-group"><label>Nom complet</label><input type="text" id="editNom" class="edit-input" value="${s.nom || ''}"></div>
        <div class="form-row">
            <div class="form-group"><label>T√©l√©phone</label><input type="text" id="editPhone" class="edit-input" value="${s.telephone || ''}"></div>
            <div class="form-group"><label>Formation</label><input type="text" id="editFormation" class="edit-input" value="${s.formation || ''}"></div>
        </div>
        <div class="form-row">
            <div class="form-group"><label>Rythme</label><select id="editRythme" class="edit-input">${rythmeOptions}</select></div>
            <div class="form-group"><label>Banque</label><input type="text" id="editBank" class="edit-input" value="${s.banque || ''}"></div>
        </div>
        <div class="form-row">
            <div class="form-group"><label>Statut</label><select id="editStatus" class="edit-input">${statusOptions}</select></div>
            <div class="form-group"><label>Montant pay√© (‚Ç¨)</label><input type="number" id="editPaid" class="edit-input" value="${s.paid || 0}"></div>
        </div>
        <div class="form-group"><label>Montant total (‚Ç¨)</label><input type="number" id="editTotal" class="edit-input" value="${s.total || 0}"></div>
        <div class="form-group"><label>√âch√©ances</label><textarea id="editEcheances" class="edit-input" style="min-height:80px">${s.echeancesRaw || ''}</textarea></div>
        <div class="form-group"><label>Notes</label><textarea id="editNotes" class="edit-input">${s.notes || ''}</textarea></div>
    `;
    
    document.getElementById('detailContent').innerHTML = html;
    document.getElementById('detailFooter').innerHTML = `
        <button class="btn btn-secondary" onclick="openDetailModal('${currentStudentId}')">Annuler</button>
        <button class="btn btn-primary" onclick="saveEdit()">üíæ Enregistrer</button>
    `;
}

function saveEdit() {
    const s = students.find(st => st.id == currentStudentId);
    if (!s) return;
    
    s.nom = document.getElementById('editNom').value.trim();
    s.telephone = document.getElementById('editPhone').value.trim();
    s.formation = document.getElementById('editFormation').value.trim();
    s.rythme = document.getElementById('editRythme').value;
    s.banque = document.getElementById('editBank').value.trim();
    s.status = document.getElementById('editStatus').value;
    s.paid = parseFloat(document.getElementById('editPaid').value) || 0;
    s.total = parseFloat(document.getElementById('editTotal').value) || 0;
    s.echeancesRaw = document.getElementById('editEcheances').value;
    s.notes = document.getElementById('editNotes').value;
    
    saveToServer(s, (data) => {
        if (data.success) {
            loadStudents();
            openDetailModal(currentStudentId);
            showToast('‚úÖ Modifications enregistr√©es');
        } else {
            showToast('Erreur: ' + data.error, true);
        }
    });
}

function deleteStudent() {
    const s = students.find(st => st.id == currentStudentId);
    if (!s) return;
    
    if (!confirm('Supprimer ' + s.nom + ' ?')) return;
    
    deleteFromServer(currentStudentId, (data) => {
        if (data.success) {
            closeDetailModal();
            loadStudents();
            showToast('üóëÔ∏è √âtudiant supprim√©');
        } else {
            showToast('Erreur: ' + data.error, true);
        }
    });
}

// ==========================================
// IMPORT CSV
// ==========================================
function openImportModal() {
    pendingImport = [];
    document.getElementById('importPreview').style.display = 'none';
    document.getElementById('importBtn').disabled = true;
    document.getElementById('fileInput').value = '';
    document.getElementById('importModal').classList.add('active');
}

function closeImportModal() {
    document.getElementById('importModal').classList.remove('active');
}

document.addEventListener('DOMContentLoaded', () => {
    const zone = document.getElementById('importZone');
    if (zone) {
        zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
        zone.addEventListener('drop', e => {
            e.preventDefault();
            zone.classList.remove('dragover');
            if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
        });
    }
});

function handleFileSelect(e) {
    if (e.target.files.length) handleFile(e.target.files[0]);
}

function handleFile(file) {
    const reader = new FileReader();
    reader.onload = e => parseCSV(e.target.result);
    reader.readAsText(file, 'UTF-8');
}

function parseCSV(content) {
    const firstLine = content.split('\n')[0];
    let sep = '\t';
    if (firstLine.includes(';') && !firstLine.includes('\t')) sep = ';';
    else if (firstLine.includes(',') && !firstLine.includes('\t')) sep = ',';
    
    const lines = content.split('\n').map(l => l.split(sep).map(c => c.trim()));
    const headers = lines[0].map(h => h.toUpperCase().replace(/[^A-Z0-9]/g, ''));
    
    const col = {
        nom: headers.findIndex(h => h === 'NOM'),
        prenom: headers.findIndex(h => h.includes('PRENOM') || h === 'PR2NOM'),
        formation: headers.findIndex(h => h.includes('FORMATION')),
        rythme: headers.findIndex(h => h.includes('RYTHME')),
        telephone: headers.findIndex(h => h.includes('TELEPHONE') || h.includes('TEL')),
        banque: headers.findIndex(h => h.includes('BANQUE')),
        echeances: headers.findIndex(h => h.includes('ECHEANCE'))
    };
    
    pendingImport = [];
    let newCount = 0, updateCount = 0;
    
    for (let i = 1; i < lines.length; i++) {
        const row = lines[i];
        if (row.length < 2 || !row[col.nom]) continue;
        
        const nom = row[col.nom] || '';
        const prenom = col.prenom >= 0 ? (row[col.prenom] || '') : '';
        const fullName = (nom + ' ' + prenom).trim();
        if (!fullName) continue;
        
        let phone = col.telephone >= 0 ? (row[col.telephone] || '') : '';
        phone = phone.replace(/[^0-9]/g, '');
        if (phone.length === 9 && !phone.startsWith('0')) phone = '0' + phone;
        if (phone.startsWith('33') && phone.length > 10) phone = '0' + phone.substring(2);
        
        let bank = col.banque >= 0 ? (row[col.banque] || '') : '';
        const bankMatch = bank.match(/^([A-Z\s\.]+)/i);
        if (bankMatch) bank = bankMatch[1].trim();
        
        const echeancesRaw = col.echeances >= 0 ? (row[col.echeances] || '') : '';
        const parsed = parseEcheances(echeancesRaw);
        
        const student = {
            nom: fullName,
            formation: col.formation >= 0 ? (row[col.formation] || '') : '',
            rythme: col.rythme >= 0 ? (row[col.rythme] || 'IOA') : 'IOA',
            telephone: phone,
            banque: bank,
            echeancesRaw: echeancesRaw,
            status: 'pending',
            paid: parsed.paid,
            total: parsed.total
        };
        
        const existing = students.find(s => (s.nom || '').toUpperCase() === fullName.toUpperCase());
        if (existing) updateCount++; else newCount++;
        
        pendingImport.push(student);
    }
    
    document.getElementById('previewCount').textContent = pendingImport.length;
    document.getElementById('previewNew').textContent = newCount;
    document.getElementById('previewUpdate').textContent = updateCount;
    
    document.getElementById('previewTable').innerHTML = pendingImport.slice(0, 15).map(s =>
        `<tr><td>${s.nom}</td><td>${s.formation}</td><td>${s.rythme}</td><td>${s.telephone}</td></tr>`
    ).join('') + (pendingImport.length > 15 ? `<tr><td colspan="4" style="text-align:center;opacity:0.5">... et ${pendingImport.length - 15} autres</td></tr>` : '');
    
    document.getElementById('importPreview').style.display = 'block';
    document.getElementById('importBtn').disabled = false;
}

function confirmImport() {
    if (!pendingImport.length) return;
    
    // Mode test
    if (API_URL === 'VOTRE_URL_APPS_SCRIPT') {
        const now = new Date().toLocaleString('fr-FR');
        pendingImport.forEach(s => {
            const existing = students.find(st => (st.nom || '').toUpperCase() === (s.nom || '').toUpperCase());
            if (existing) {
                Object.assign(existing, s, { id: existing.id, creePar: existing.creePar, creeDate: existing.creeDate });
                existing.modifiePar = currentUser.username;
                existing.modifieDate = now;
            } else {
                s.id = Date.now() + Math.random();
                s.creePar = currentUser.username;
                s.creeDate = now;
                s.modifiePar = currentUser.username;
                s.modifieDate = now;
                students.push(s);
            }
        });
        localStorage.setItem('students_test', JSON.stringify(students));
        closeImportModal();
        loadStudents();
        showToast(`‚úÖ ${pendingImport.length} √©tudiants import√©s!`);
        return;
    }
    
    showLoading(true);
    
    fetch(`${API_URL}?action=importStudents&user=${encodeURIComponent(currentUser.username)}&data=${encodeURIComponent(JSON.stringify(pendingImport))}`)
        .then(r => r.json())
        .then(data => {
            showLoading(false);
            if (data.success) {
                closeImportModal();
                loadStudents();
                showToast(`‚úÖ ${data.created} cr√©√©s, ${data.updated} mis √† jour`);
            } else {
                showToast('Erreur: ' + data.error, true);
            }
        });
}

// ==========================================
// HISTORIQUE
// ==========================================
function openHistoryModal() {
    document.getElementById('historyModal').classList.add('active');
    
    // Mode test
    if (API_URL === 'VOTRE_URL_APPS_SCRIPT') {
        document.getElementById('historyList').innerHTML = '<p style="text-align:center;color:rgba(255,255,255,0.4)">Historique non disponible en mode test</p>';
        return;
    }
    
    document.getElementById('historyList').innerHTML = '<p style="text-align:center;color:rgba(255,255,255,0.4)">Chargement...</p>';
    
    fetch(`${API_URL}?action=getHistory`)
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                document.getElementById('historyList').innerHTML = data.history.map(h => `
                    <div class="history-item">
                        <div class="history-date">${h.date}</div>
                        <div class="history-user">${h.utilisateur}</div>
                        <div class="history-action ${h.action.toLowerCase()}">${h.action}</div>
                        <div class="history-details"><strong>${h.etudiant}</strong> - ${h.details}</div>
                    </div>
                `).join('') || '<p style="text-align:center;color:rgba(255,255,255,0.4)">Aucun historique</p>';
            }
        });
}

function closeHistoryModal() {
    document.getElementById('historyModal').classList.remove('active');
}

// ==========================================
// PARSEUR D'√âCH√âANCES
// ==========================================
function parseEcheances(text) {
    const result = { echeances: [], paid: 0, remaining: 0, total: 0 };
    if (!text || !text.trim()) return result;
    
    let normalized = text.toLowerCase().replace(/‚Ç¨/g, '').replace(/\s+/g, ' ').trim();
    const parts = normalized.split(/\s+(?:puis|ensuite|\+|et(?:\s+enfin)?)\s+/);
    
    for (const part of parts) {
        parsePart(part.trim(), result);
    }
    
    result.echeances.sort((a, b) => a.date - b.date);
    result.echeances.forEach(e => {
        if (e.paid) result.paid += e.montant;
        else result.remaining += e.montant;
    });
    result.total = result.paid + result.remaining;
    
    return result;
}

function parsePart(text, result) {
    if (!text) return;
    
    // "a r√©gl√© X‚Ç¨"
    const regleMatch = text.match(/(?:a\s+)?(?:r√©gl√©|regl√©|pay√©|vers√©)\s+(\d+(?:[.,]\d+)?)/i);
    if (regleMatch) {
        result.echeances.push({
            date: new Date(),
            montant: parseFloat(regleMatch[1].replace(',', '.')),
            type: 'D√©j√† pay√©',
            paid: true,
            label: 'D√©j√† r√©gl√©'
        });
        return;
    }
    
    // "X tous les J jusqu'au DD/MM/YY"
    const tousMatch = text.match(/(\d+(?:[.,]\d+)?)\s*(?:par\s+mois\s+)?tous\s+les\s+(\d+)\s+jusqu['\s]?(?:au)?\s*(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/i);
    if (tousMatch) {
        const montant = parseFloat(tousMatch[1].replace(',', '.'));
        const jour = parseInt(tousMatch[2]);
        const dateFin = makeDate(tousMatch[3], tousMatch[4], tousMatch[5]);
        dateFin.setDate(dateFin.getDate() + 1);
        
        let current = new Date();
        current.setDate(jour);
        if (current <= new Date()) current.setMonth(current.getMonth() + 1);
        
        while (current < dateFin) {
            result.echeances.push({ date: new Date(current), montant, type: 'Pr√©l√®vement', paid: false });
            current.setMonth(current.getMonth() + 1);
        }
        return;
    }
    
    // "X/mois du DD/MM/YY au DD/MM/YY"
    const mensMatch = text.match(/(\d+(?:[.,]\d+)?)\s*(?:\/mois|par\s+mois)?\s*(?:du|√†\s+partir\s+du)\s+(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})\s+(?:au|jusqu['\s]?au?)\s+(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/i);
    if (mensMatch) {
        const montant = parseFloat(mensMatch[1].replace(',', '.'));
        const dateDebut = makeDate(mensMatch[2], mensMatch[3], mensMatch[4]);
        const dateFin = makeDate(mensMatch[5], mensMatch[6], mensMatch[7]);
        dateFin.setDate(dateFin.getDate() + 1);
        
        let current = new Date(dateDebut);
        while (current < dateFin) {
            result.echeances.push({ date: new Date(current), montant, type: 'Pr√©l√®vement', paid: current < new Date() });
            current.setMonth(current.getMonth() + 1);
        }
        return;
    }
    
    // "X le DD/MM/YY"
    const uniqueMatch = text.match(/(?:(pvt|cb|esp|chq|vrt)\s+)?(\d+(?:[.,]\d+)?)\s*(?:\/(cb|esp|chq|vrt|pvt))?\s*(?:le|pour\s+le)?\s*(\d{1,2})[\/\-](\d{1,2})(?:[\/\-](\d{2,4}))?/i);
    if (uniqueMatch) {
        const type = getType(uniqueMatch[1] || uniqueMatch[3] || 'pvt');
        const montant = parseFloat(uniqueMatch[2].replace(',', '.'));
        const annee = uniqueMatch[6] || new Date().getFullYear();
        const date = makeDate(uniqueMatch[4], uniqueMatch[5], annee);
        
        result.echeances.push({ date, montant, type, paid: date < new Date() });
    }
}

function makeDate(j, m, a) {
    let annee = parseInt(a);
    if (annee < 100) annee += 2000;
    return new Date(annee, parseInt(m) - 1, parseInt(j));
}

function getType(t) {
    if (!t) return 'Pr√©l√®vement';
    t = t.toLowerCase();
    if (t.includes('esp')) return 'Esp√®ces';
    if (t.includes('cb')) return 'CB';
    if (t.includes('chq')) return 'Ch√®que';
    if (t.includes('vrt')) return 'Virement';
    return 'Pr√©l√®vement';
}

function formatDate(date) {
    return date.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short', year: 'numeric' });
}

function previewEcheances(text) {
    const preview = document.getElementById('echeancesPreview');
    const parsed = parseEcheances(text);
    
    if (parsed.echeances.length === 0) {
        preview.style.display = 'none';
        return;
    }
    
    preview.style.display = 'block';
    preview.innerHTML = `
        <div class="echeances-header">
            <strong>Aper√ßu</strong>
            <div class="echeances-stats">
                <div class="stat"><div class="stat-value green">${parsed.paid}‚Ç¨</div><div class="stat-label">Pay√©</div></div>
                <div class="stat"><div class="stat-value orange">${parsed.remaining}‚Ç¨</div><div class="stat-label">Restant</div></div>
                <div class="stat"><div class="stat-value">${parsed.total}‚Ç¨</div><div class="stat-label">Total</div></div>
            </div>
        </div>
        <div class="echeances-list">
            ${parsed.echeances.slice(0, 8).map(e => `
                <div class="echeance-item ${e.paid ? 'paid' : ''}">
                    <div class="echeance-date">${e.label || formatDate(e.date)}</div>
                    <div class="echeance-amount ${e.paid ? 'paid' : ''}">${e.montant.toFixed(0)}‚Ç¨</div>
                    <div class="echeance-type">${e.type}</div>
                </div>
            `).join('')}
            ${parsed.echeances.length > 8 ? `<div style="text-align:center;color:rgba(255,255,255,0.4);padding:8px">... et ${parsed.echeances.length - 8} autres</div>` : ''}
        </div>
    `;
}

// ==========================================
// UTILITAIRES
// ==========================================
function showToast(msg, isError = false) {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.className = 'toast' + (isError ? ' error' : '');
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 3000);
}

function showLoading(show) {
    document.getElementById('loading').classList.toggle('active', show);
}

// ==========================================
// INITIALISATION
// ==========================================
document.addEventListener('DOMContentLoaded', () => {
    const savedUser = localStorage.getItem('user');
    if (savedUser) {
        try {
            currentUser = JSON.parse(savedUser);
            showMainPage();
        } catch(e) {
            localStorage.removeItem('user');
        }
    }
});
</script>
</body>
</html>
