<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Crect width='32' height='32' rx='6' fill='%237c5cfc'/%3E%3Ctext x='16' y='22' text-anchor='middle' font-family='Arial,sans-serif' font-weight='800' font-size='14' fill='white'%3EITIC%3C/text%3E%3C/svg%3E">
<title>Gestion Effectifs ITIC 2025-26</title>
<style>
:root {
    --bg: #0f1117; --surface: #1a1d27; --surface2: #242736; --border: #2e3246;
    --text: #e4e6f0; --text2: #8b8fa8; --primary: #7c5cfc; --primary2: #6344e0;
    --ok: #2ecc71; --warn: #f39c12; --danger: #e74c3c; --info: #3498db;
    --radius: 10px; --shadow: 0 4px 20px rgba(0,0,0,0.3);
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', system-ui, sans-serif; min-height: 100vh; }
a { color: var(--primary); }
.header { background: var(--surface); padding: 16px 24px; border-bottom: 1px solid var(--border); display: flex; align-items: center; flex-wrap: wrap; gap: 12px; }
.header h1 { font-size: 1.3em; flex-shrink: 0; }
.header h1 span { color: var(--primary); }
.header-actions { display: flex; gap: 8px; margin-left: auto; flex-wrap: wrap; align-items: center; }
.header-actions .user-info { color: var(--text2); font-size: 0.85em; margin-right: 8px; }
.btn { padding: 8px 16px; border: none; border-radius: var(--radius); cursor: pointer; font-size: 0.85em; font-weight: 600; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; }
.btn-primary { background: var(--primary); color: white; }
.btn-primary:hover { background: var(--primary2); transform: translateY(-1px); }
.btn-sm { padding: 5px 10px; font-size: 0.78em; }
.btn-success { background: var(--ok); color: white; }
.btn-danger { background: var(--danger); color: white; }
.btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text2); }
.btn-outline:hover { border-color: var(--primary); color: var(--primary); }
.tabs { display: flex; gap: 0; background: var(--surface); border-bottom: 1px solid var(--border); padding: 0 24px; }
.tab-btn { padding: 12px 20px; border: none; background: none; color: var(--text2); cursor: pointer; font-size: 0.9em; font-weight: 600; border-bottom: 3px solid transparent; transition: all 0.2s; }
.tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); }
.tab-btn:hover { color: var(--text); }
.tab-content { display: none; padding: 20px 24px; }
.tab-content.active { display: block; }
.toolbar { display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; align-items: center; }
.search-box { flex: 1; min-width: 200px; padding: 10px 16px; background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text); font-size: 0.9em; }
.search-box:focus { outline: none; border-color: var(--primary); }
.filter-select { padding: 10px 12px; background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius); color: var(--text); font-size: 0.85em; }
.filter-banner { background: var(--primary); color: white; padding: 8px 16px; border-radius: var(--radius); margin-bottom: 12px; display: flex; align-items: center; justify-content: space-between; }
.filter-banner .clear-btn { background: rgba(255,255,255,0.2); border: none; color: white; padding: 4px 10px; border-radius: 6px; cursor: pointer; font-size: 0.85em; }
.global-search { position: sticky; top: 0; z-index: 100; background: var(--bg); padding: 12px 24px 8px; border-bottom: 1px solid var(--border); }
.stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 20px; }
.stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; text-align: center; cursor: pointer; transition: all 0.2s; }
.stat-card:hover { border-color: var(--primary); transform: translateY(-2px); }
.stat-card .number { font-size: 2em; font-weight: 800; }
.stat-card .label { color: var(--text2); font-size: 0.85em; margin-top: 4px; }
.stat-card.ok .number { color: var(--ok); }
.stat-card.warn .number { color: var(--warn); }
.stat-card.danger .number { color: var(--danger); }
.stat-card.info .number { color: var(--info); }
.finance-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 20px; }
.finance-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; }
.finance-card .amount { font-size: 1.4em; font-weight: 700; }
.finance-card .label { color: var(--text2); font-size: 0.8em; }
.student-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 12px; }
.student-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; cursor: pointer; transition: all 0.2s; position: relative; }
.student-card:hover { border-color: var(--primary); transform: translateY(-2px); box-shadow: var(--shadow); }
.student-card .name { font-weight: 700; font-size: 1.05em; margin-bottom: 4px; }
.student-card .meta { color: var(--text2); font-size: 0.82em; display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px; }
.student-card .meta span { background: var(--surface2); padding: 2px 8px; border-radius: 12px; }
.student-card .progress-bar { height: 6px; background: var(--surface2); border-radius: 3px; overflow: hidden; margin-top: 8px; }
.student-card .progress-fill { height: 100%; border-radius: 3px; transition: width 0.3s; }
.student-card .amounts { display: flex; justify-content: space-between; font-size: 0.82em; margin-top: 4px; }
.badge { display: inline-block; padding: 2px 8px; border-radius: 10px; font-size: 0.75em; font-weight: 600; }
.badge-ok { background: rgba(46,204,113,0.15); color: var(--ok); }
.badge-warn { background: rgba(243,156,18,0.15); color: var(--warn); }
.badge-danger { background: rgba(231,76,60,0.15); color: var(--danger); }
.badge-info { background: rgba(52,152,219,0.15); color: var(--info); }
.badge-nvx { background: rgba(124,92,252,0.15); color: var(--primary); }
.late-badge { position: absolute; top: 10px; right: 10px; background: var(--danger); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.72em; font-weight: 700; }
.modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 1000; overflow-y: auto; padding: 20px; }
.modal-overlay.active { display: flex; align-items: flex-start; justify-content: center; }
.modal { background: var(--surface); border-radius: 12px; width: 100%; max-width: 800px; margin: 20px auto; box-shadow: var(--shadow); }
.modal-header { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid var(--border); }
.modal-header h2 { font-size: 1.1em; }
.modal-close { background: none; border: none; color: var(--text2); font-size: 1.5em; cursor: pointer; padding: 0 8px; }
.modal-close:hover { color: var(--text); }
.modal-body { padding: 20px; }
.modal-footer { padding: 16px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 8px; }
.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.form-row-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
.form-group { margin-bottom: 12px; }
.form-group label { display: block; font-size: 0.78em; color: var(--text2); margin-bottom: 4px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
.form-group input, .form-group select, .form-group textarea {
    width: 100%; padding: 8px 12px; background: var(--surface2); border: 1px solid var(--border);
    border-radius: 8px; color: var(--text); font-size: 0.9em; transition: border-color 0.2s;
}
.form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--primary); }
.form-group textarea { min-height: 60px; resize: vertical; font-family: inherit; }
.inline-field { background: transparent; border: none; border-bottom: 1px solid var(--border); border-radius: 0; padding: 4px 2px; color: var(--text); font-size: 0.95em; width: 100%; }
.inline-field:focus { border-bottom-color: var(--primary); outline: none; }
.inline-select { background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; padding: 4px 8px; color: var(--text); font-size: 0.9em; width: 100%; }
.ech-section { margin-top: 16px; border-top: 1px solid var(--border); padding-top: 16px; }
.ech-section h3 { font-size: 0.95em; margin-bottom: 12px; }
.ech-table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
.ech-table th { text-align: left; padding: 6px 8px; color: var(--text2); font-weight: 600; font-size: 0.8em; text-transform: uppercase; border-bottom: 1px solid var(--border); }
.ech-table td { padding: 6px 8px; border-bottom: 1px solid rgba(46,50,70,0.5); }
.ech-table tr:hover td { background: rgba(124,92,252,0.05); }
.ech-table .paid td { opacity: 0.7; }
.ech-table .late td { color: var(--danger); font-weight: 600; }
.ech-editable { cursor: pointer; border-bottom: 1px dashed var(--border); padding: 2px 6px; border-radius: 4px; transition: all 0.2s; position: relative; }
.ech-editable:hover { border-bottom-color: var(--primary); color: var(--primary); background: rgba(124,92,252,0.08); }
.ech-editable:hover::after { content: ' ‚úèÔ∏è'; font-size: 0.75em; }
.ech-add-row { display: flex; gap: 8px; margin-top: 8px; align-items: center; flex-wrap: wrap; }
.ech-add-row input, .ech-add-row select { padding: 6px 10px; background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-size: 0.85em; }
.stats-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
.stats-table th { text-align: left; padding: 8px 12px; color: var(--text2); font-weight: 600; font-size: 0.8em; text-transform: uppercase; border-bottom: 1px solid var(--border); }
.stats-table td { padding: 8px 12px; border-bottom: 1px solid rgba(46,50,70,0.5); }
.stats-table tr { cursor: pointer; transition: background 0.2s; }
.stats-table tr:hover { background: rgba(124,92,252,0.08); }
.mini-bar { height: 8px; background: var(--surface2); border-radius: 4px; overflow: hidden; min-width: 100px; display: inline-block; vertical-align: middle; }
.mini-bar-fill { height: 100%; border-radius: 4px; background: var(--primary); }
.import-preview { max-height: 300px; overflow: auto; font-size: 0.82em; margin: 12px 0; }
.import-preview table { width: 100%; border-collapse: collapse; }
.import-preview th, .import-preview td { padding: 4px 8px; border: 1px solid var(--border); text-align: left; white-space: nowrap; }
.import-preview th { background: var(--surface2); position: sticky; top: 0; }
.toast { position: fixed; bottom: 20px; right: 20px; background: var(--surface); border: 1px solid var(--border); color: var(--text); padding: 12px 20px; border-radius: var(--radius); box-shadow: var(--shadow); z-index: 2000; transform: translateY(100px); opacity: 0; transition: all 0.3s; font-size: 0.9em; }
.toast.show { transform: translateY(0); opacity: 1; }
.toast.error { border-color: var(--danger); }
.loading-overlay { display: none; position: fixed; inset: 0; background: rgba(15,17,23,0.8); z-index: 3000; align-items: center; justify-content: center; }
.loading-overlay.active { display: flex; }
.spinner { width: 40px; height: 40px; border: 4px solid var(--border); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.readonly-banner { background: var(--warn); color: #222; text-align: center; padding: 8px; font-weight: 600; font-size: 0.85em; }
.dashboard { margin-bottom: 20px; }
.dash-metrics { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 16px; }
.dash-metric { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 16px; text-align: center; transition: all 0.2s; cursor: pointer; }
.dash-metric:hover { border-color: var(--primary); transform: translateY(-2px); }
.dash-metric .dash-num { font-size: 1.8em; font-weight: 800; line-height: 1.2; }
.dash-metric .dash-label { color: var(--text2); font-size: 0.8em; margin-top: 4px; }
.dash-metric .dash-sub { font-size: 0.75em; color: var(--text2); margin-top: 2px; }
.dash-alerts { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 16px; overflow: hidden; }
.dash-alerts-header { display: flex; align-items: center; justify-content: space-between; padding: 14px 18px; border-bottom: 1px solid var(--border); }
.dash-alerts-header h3 { font-size: 0.95em; }
.dash-alerts-header .count-badge { background: var(--danger); color: white; padding: 2px 10px; border-radius: 12px; font-size: 0.8em; font-weight: 700; }
.dash-alert-item { display: flex; align-items: center; gap: 12px; padding: 12px 18px; border-bottom: 1px solid rgba(46,50,70,0.4); transition: background 0.2s; cursor: pointer; }
.dash-alert-item:last-child { border-bottom: none; }
.dash-alert-item:hover { background: rgba(124,92,252,0.06); }
.dash-alert-item .alert-severity { font-size: 0.72em; font-weight: 700; padding: 3px 8px; border-radius: 8px; white-space: nowrap; flex-shrink: 0; }
.dash-alert-item .alert-severity.critical { background: rgba(231,76,60,0.2); color: var(--danger); }
.dash-alert-item .alert-severity.warning { background: rgba(243,156,18,0.2); color: var(--warn); }
.dash-alert-item .alert-severity.minor { background: rgba(52,152,219,0.15); color: var(--info); }
.dash-alert-item .alert-name { font-weight: 600; font-size: 0.9em; min-width: 0; }
.dash-alert-item .alert-formation { color: var(--text2); font-size: 0.8em; flex-shrink: 0; }
.dash-alert-item .alert-amount { color: var(--danger); font-weight: 700; font-size: 0.9em; margin-left: auto; white-space: nowrap; flex-shrink: 0; }
.dash-alert-item .alert-actions { display: flex; gap: 4px; flex-shrink: 0; }
.dash-ok { background: var(--surface); border: 1px solid var(--ok); border-radius: var(--radius); padding: 24px; text-align: center; margin-bottom: 16px; }
.dash-ok .ok-icon { font-size: 2.5em; margin-bottom: 8px; }
.dash-ok .ok-text { color: var(--ok); font-weight: 700; font-size: 1.1em; }
.dash-ok .ok-sub { color: var(--text2); font-size: 0.85em; margin-top: 4px; }
.dash-upcoming { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); margin-bottom: 16px; overflow: hidden; }
.dash-upcoming-header { padding: 14px 18px; border-bottom: 1px solid var(--border); }
.dash-upcoming-header h3 { font-size: 0.95em; }
.dash-upcoming-item { display: flex; align-items: center; gap: 12px; padding: 10px 18px; border-bottom: 1px solid rgba(46,50,70,0.4); cursor: pointer; transition: background 0.2s; }
.dash-upcoming-item:last-child { border-bottom: none; }
.dash-upcoming-item:hover { background: rgba(124,92,252,0.06); }
.dash-upcoming-item .upcoming-date { color: var(--text2); font-size: 0.82em; flex-shrink: 0; min-width: 80px; }
.dash-upcoming-item .upcoming-name { font-weight: 600; font-size: 0.88em; }
.dash-upcoming-item .upcoming-amount { margin-left: auto; font-weight: 700; font-size: 0.88em; color: var(--warn); }
.dash-section-toggle { background: none; border: none; color: var(--primary); cursor: pointer; font-size: 0.82em; font-weight: 600; padding: 8px 18px; width: 100%; text-align: center; }
.dash-section-toggle:hover { text-decoration: underline; }
@media (max-width: 900px) { .dash-metrics { grid-template-columns: repeat(2, 1fr); } }
@media (max-width: 600px) { .dash-metrics { grid-template-columns: 1fr 1fr; } }
.contact-bar { display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap; }
.btn-whatsapp { background: #25D366; color: white; }
.btn-whatsapp:hover { background: #1da851; transform: translateY(-1px); }
.btn-email { background: #4285f4; color: white; }
.btn-email:hover { background: #3367d6; transform: translateY(-1px); }
.login-container { display: flex; align-items: center; justify-content: center; min-height: 100vh; }
.login-box { background: var(--surface); padding: 40px; border-radius: 12px; width: 360px; box-shadow: var(--shadow); }
.login-box h2 { text-align: center; margin-bottom: 24px; }
.login-box h2 span { color: var(--primary); }
.login-box .form-group { margin-bottom: 16px; }
.login-box .btn { width: 100%; justify-content: center; padding: 12px; font-size: 1em; }
@media (max-width: 900px) {
    .stats-row { grid-template-columns: repeat(2, 1fr); }
    .finance-row { grid-template-columns: 1fr; }
    .form-row, .form-row-3 { grid-template-columns: 1fr; }
}
@media (max-width: 600px) {
    .stats-row { grid-template-columns: 1fr; }
    .header { flex-direction: column; text-align: center; }
    .header-actions { margin-left: 0; justify-content: center; }
    .student-grid { grid-template-columns: 1fr; }
}
/* Live Import */
.import-live-table-wrap{max-height:45vh;overflow-y:auto;border:1px solid var(--border);border-radius:8px;background:var(--surface);}
.import-live-table{width:100%;border-collapse:collapse;font-size:0.82em;}
.import-live-table thead{position:sticky;top:0;z-index:1;}
.import-live-table th{background:var(--surface2);padding:6px 10px;text-align:left;font-size:0.72em;text-transform:uppercase;letter-spacing:0.5px;color:var(--text2);border-bottom:1px solid var(--border);}
.import-live-table td{padding:5px 10px;border-bottom:1px solid var(--border);}
.import-live-table tr:last-child td{border-bottom:none;}
.import-row-enter{animation:rowSlideIn 0.2s ease-out;}
@keyframes rowSlideIn{from{opacity:0;transform:translateY(-8px);background:rgba(124,92,252,0.12);}50%{background:rgba(124,92,252,0.08);}to{opacity:1;transform:translateY(0);background:transparent;}}
.import-spinner{width:24px;height:24px;border:3px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin 0.7s linear infinite;flex-shrink:0;}
@keyframes spin{to{transform:rotate(360deg);}}
</style>
</head>
<body>

<div id="loginScreen" class="login-container">
    <div class="login-box">
        <h2><span>ITIC</span> Gestion Effectifs</h2>
        <p style="text-align:center;color:var(--text2);margin-bottom:20px;font-size:0.85em;">2025-26</p>
        <div class="form-group"><label>Nom d'utilisateur</label><input type="text" id="loginUser" placeholder="Utilisateur" autofocus></div>
        <div class="form-group"><label>Mot de passe</label><input type="password" id="loginPass" placeholder="Mot de passe"></div>
        <button class="btn btn-primary" onclick="doLogin()" style="width:100%;">Se connecter</button>
        <p id="loginError" style="color:var(--danger);text-align:center;margin-top:12px;font-size:0.85em;display:none;"></p>
        <div id="localModeHint" style="display:none;margin-top:16px;padding:12px;background:var(--surface2);border-radius:var(--radius);border:1px solid var(--border);">
            <p style="color:var(--warn);font-size:0.82em;margin-bottom:8px;">‚ö†Ô∏è Impossible de contacter le serveur. Cela arrive quand le fichier est ouvert en local (<code>file://</code>).</p>
            <p style="color:var(--text2);font-size:0.82em;margin-bottom:10px;">Tu peux utiliser le <strong>mode local</strong> (donn√©es sauv√©es dans le navigateur) ou <a href="#" onclick="window.open(API_URL+'?action=login&user=test&pass=test','_blank');return false;" style="color:var(--primary);">tester l'URL du serveur</a>.</p>
            <button class="btn btn-outline" onclick="startLocalMode()" style="width:100%;">üíª Mode local (hors-ligne)</button>
        </div>
    </div>
</div>

<div id="appScreen" style="display:none;">
    <div id="readonlyBanner" class="readonly-banner" style="display:none;">üîí Mode lecture seule</div>
    <div class="header">
        <h1>üìö <span>ITIC</span> Gestion Effectifs <small style="font-size:0.5em;color:var(--text2);">25-26</small></h1>
        <div class="header-actions">
            <span class="user-info" id="userInfo"></span>
            <button class="btn btn-primary write-only" onclick="openCreateModal()">+ Nouveau</button>
            <button class="btn btn-outline admin-only" onclick="openImportModal()">üì• Importer</button>
            <button class="btn btn-outline admin-only" onclick="exportCSV()">üì§ Exporter</button>
            <button class="btn btn-outline admin-only" onclick="openRestoreModal()">üîÑ Restaurer</button>
            <button class="btn btn-outline" onclick="openHistoryModal()">üìã Historique</button>
            <button class="btn btn-danger btn-sm admin-only" id="btnDeleteAll" onclick="deleteAllStudents()">üóëÔ∏è Tout effacer</button>
            <button class="btn btn-outline" onclick="doLogout()">D√©connexion</button>
        </div>
    </div>
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('home')">üè† Accueil</button>
        <button class="tab-btn" onclick="switchTab('stats')">üìä Statistiques</button>
    </div>
    <div class="global-search">
        <div class="toolbar" style="margin-bottom:0;">
            <input type="text" class="search-box" id="searchBox" placeholder="üîç Rechercher par nom, formation, t√©l√©phone, montant..." oninput="filterStudents()">
            <select class="filter-select" id="filterFormation" onchange="filterStudents()"><option value="">Toutes formations</option></select>
            <select class="filter-select" id="filterStatus" onchange="filterStudents()">
                <option value="">Tous statuts</option><option value="ok">‚úÖ √Ä jour</option><option value="pending">‚è≥ En attente</option><option value="late">‚ö†Ô∏è En retard</option>
            </select>
            <select class="filter-select" id="filterRythme" onchange="filterStudents()">
                <option value="">Tous rythmes</option><option value="IOA">IOA</option><option value="Alternance">Alternance</option><option value="Initiale">Initiale</option><option value="SFP">SFP</option>
            </select>
            <select class="filter-select" id="filterLate" onchange="filterStudents()">
                <option value="">Retard</option><option value="30">+30j</option><option value="60">+60j</option><option value="90">+90j</option>
            </select>
        </div>
        <div id="filterBanner" class="filter-banner" style="display:none;">
            <span id="filterBannerText"></span>
            <button class="clear-btn" onclick="clearAllFilters()">‚úï Tout afficher</button>
        </div>
    </div>
    <div id="tab-home" class="tab-content active">
        <div id="dashboard" class="dashboard"></div>
        <div id="studentListSection">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;"><h3 style="font-size:1em;color:var(--text);">üìã Tous les √©tudiants</h3><span id="studentCount" style="color:var(--text2);font-size:0.82em;"></span></div>
        <div id="studentGrid" class="student-grid"></div>
        </div>
    </div>
    <div id="tab-stats" class="tab-content"><div id="statsContent"></div></div>
</div>

<div id="detailModal" class="modal-overlay"><div class="modal"><div class="modal-header"><h2 id="detailTitle">Fiche √©tudiant</h2><button class="modal-close" onclick="closeModal('detailModal')">&times;</button></div><div class="modal-body" id="detailBody"></div><div class="modal-footer write-only"><button class="btn btn-danger btn-sm" onclick="deleteStudent()" style="margin-right:auto;">üóëÔ∏è Supprimer</button><button class="btn btn-primary" onclick="saveDetailFields()">üíæ Enregistrer & Fermer</button></div></div></div>
<div id="createModal" class="modal-overlay"><div class="modal"><div class="modal-header"><h2>Nouvel √©tudiant</h2><button class="modal-close" onclick="closeModal('createModal')">&times;</button></div><div class="modal-body" id="createBody"></div><div class="modal-footer"><button class="btn btn-outline" onclick="closeModal('createModal')">Annuler</button><button class="btn btn-primary" onclick="createStudent()">Cr√©er</button></div></div></div>
<div id="importModal" class="modal-overlay"><div class="modal" style="max-width:900px;"><div class="modal-header"><h2>üì• Importer des donn√©es</h2><button class="modal-close" onclick="closeModal('importModal')">&times;</button></div><div class="modal-body" id="importBody"></div></div></div>
<div id="historyModal" class="modal-overlay"><div class="modal"><div class="modal-header"><h2>üìã Historique</h2><button class="modal-close" onclick="closeModal('historyModal')">&times;</button></div><div class="modal-body" id="historyBody" style="max-height:500px;overflow-y:auto;"></div></div></div>
<div id="restoreModal" class="modal-overlay"><div class="modal"><div class="modal-header"><h2>üîÑ Restaurer une sauvegarde</h2><button class="modal-close" onclick="closeModal('restoreModal')">&times;</button></div><div class="modal-body" id="restoreBody" style="max-height:500px;overflow-y:auto;"></div></div></div>

<div id="toast" class="toast"></div>
<div id="loading" class="loading-overlay"><div class="spinner"></div></div>

<script>
let API_URL = 'https://script.google.com/macros/s/AKfycbx3AjE7r8v4ZxYdfEsQlGqAc0bbeLa79U1mgi1hyn03PAVuxys15tMC3_XVT2NU4Gd0gw/exec';
const FORMATIONS = ['M1 INFO CS','M2 INFO CS','M1 INFO BD','M2 INFO BD','M1 MSC','M2 MSC','M1 MSFO','M2 MSFO','M1 RH','M2 RH','M1 COM','M2 COM','M1 FSO','M2 FSO','M1 FCA','M2 FCA','M1 MCM','M2 MCM','BTS SIO 1','BTS SIO 2 SLAM','BTS SIO 2 SISR','BTS SIO SISR','BTS SIO SLAM','BTS CG 1','BTS CG 2','BTS COM 1','BTS COM 2','BTS MCO 1','BTS MCO 2','BTS NDRC 1','BTS NDRC 2','BTS SAM 1','BTS CI 1','Bachelor AIS','Bachelor RH','BACH CDA','BACH CDME'];
const RYTHMES = ['IOA','Alternance','Initiale','SFP','SFP - 6 mois'];
const TYPES_PAIEMENT = ['Pr√©l√®vement','Esp√®ces','CB','Ch√®que','Virement','Mensualit√©','Autre'];
let students = [], currentUser = null, currentStudentId = null;

function esc(s) { if(!s) return ''; const d=document.createElement('div'); d.textContent=String(s); return d.innerHTML; }

// AUTH
function doLogin() {
    const u=document.getElementById('loginUser').value.trim(), p=document.getElementById('loginPass').value;
    const errEl=document.getElementById('loginError');
    errEl.style.display='none';
    document.getElementById('localModeHint').style.display='none';
    if(!u){errEl.textContent='Veuillez saisir un nom d\'utilisateur';errEl.style.display='block';return;}
    // Force local mode on file://
    if(window.location.protocol==='file:' || !API_URL) { startLocalMode(u); return; }
    showLoading(true);
    const url=API_URL+'?action=login&user='+encodeURIComponent(u)+'&pass='+encodeURIComponent(p);
    fetch(url,{redirect:'follow'})
        .then(r=>r.text())
        .then(txt=>{
            showLoading(false);
            let d;
            try{d=JSON.parse(txt);}catch(e){
                const m=txt.match(/\{[\s\S]*\}/);
                if(m)try{d=JSON.parse(m[0]);}catch(e2){}
            }
            if(!d){errEl.textContent='R√©ponse invalide du serveur';errEl.style.display='block';document.getElementById('localModeHint').style.display='block';return;}
            if(d.success){
                // Handle user as string, or object with name/username/nom
                if(typeof d.user === 'string') currentUser = {name: d.user, role: d.role || 'admin'};
                else if(d.user && typeof d.user === 'object') currentUser = {name: d.user.name || d.user.username || d.user.nom || u, role: d.user.role || d.role || 'admin'};
                else currentUser = {name: u, role: d.role || 'admin'};
                localStorage.setItem('user',JSON.stringify(currentUser));showApp();}
            else{errEl.textContent=d.error||'Identifiants incorrects';errEl.style.display='block';}
        })
        .catch(e=>{
            showLoading(false);
            errEl.textContent='Connexion impossible: '+e.message;errEl.style.display='block';
            document.getElementById('localModeHint').style.display='block';
        });
}
function startLocalMode(name){
    const u=name||document.getElementById('loginUser').value.trim()||'Admin';
    const p=document.getElementById('loginPass').value||'';
    API_URL='';
    // Local accounts: admin needs password, others are users
    const LOCAL_ADMINS = {'admin':'admin123','Admin':'admin123','ishay':'ishay123'};
    let role='user';
    if(LOCAL_ADMINS[u]!==undefined){
        if(LOCAL_ADMINS[u]===p) role='admin';
        else if(p){
            document.getElementById('loginError').textContent='Mot de passe incorrect pour le compte admin';
            document.getElementById('loginError').style.display='block';
            return;
        }
    }
    currentUser={name:u,role:role};
    localStorage.setItem('user',JSON.stringify(currentUser));
    localStorage.setItem('localMode','1');
    showApp();
    showToast(role==='admin'?'üëë Connect√© en tant qu\'administrateur':'üë§ Connect√© en mode utilisateur');
}
document.getElementById('loginPass').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});
document.getElementById('loginUser').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});
function doLogout(){localStorage.removeItem('user');localStorage.removeItem('localMode');currentUser=null;location.reload();}
function showApp(){
    document.getElementById('loginScreen').style.display='none';document.getElementById('appScreen').style.display='block';
    if(currentUser && !currentUser.name){currentUser.name = currentUser.username || currentUser.nom || 'Utilisateur';}
    document.getElementById('userInfo').textContent='üë§ '+(currentUser&&currentUser.name?currentUser.name:'Utilisateur');
    const isAdmin=currentUser&&currentUser.role==='admin';
    const isReadonly=currentUser&&currentUser.role==='readonly';
    // Hide write-only for readonly
    if(isReadonly){document.getElementById('readonlyBanner').style.display='block';document.querySelectorAll('.write-only').forEach(el=>el.style.display='none');}
    // Hide admin-only for non-admin
    document.querySelectorAll('.admin-only').forEach(el=>el.style.display=isAdmin?'':'none');
    populateFormationFilter(); loadStudents();
}
(function(){
    // Force local mode when opened as file://
    if(window.location.protocol==='file:'){API_URL='';localStorage.setItem('localMode','1');}
    const s=localStorage.getItem('user');
    if(s){
        try{
            const parsed=JSON.parse(s);
            // Normalize: ensure currentUser always has .name
            if(typeof parsed === 'string') currentUser = {name: parsed, role: 'admin'};
            else if(parsed && typeof parsed === 'object'){
                currentUser = parsed;
                if(!currentUser.name) currentUser.name = currentUser.username || currentUser.nom || 'Utilisateur';
            }
            else return;
            localStorage.setItem('user',JSON.stringify(currentUser));
            if(localStorage.getItem('localMode')){API_URL='';}
            showApp();
        }catch(e){}
    }
})();

// API
function showLoading(v){document.getElementById('loading').classList.toggle('active',v);}
function showToast(msg,err){const t=document.getElementById('toast');t.textContent=msg;t.className='toast'+(err?' error':'');setTimeout(()=>t.classList.add('show'),10);setTimeout(()=>t.classList.remove('show'),3000);}
function parseGASResponse(txt){
    try{return JSON.parse(txt);}catch(e){
        const m=txt.match(/\{[\s\S]*\}/);
        if(m)try{return JSON.parse(m[0]);}catch(e2){}
    }
    return null;
}
function apiGet(action,cb){if(!API_URL){cb(getLocalData(action));return;}showLoading(true);fetch(API_URL+'?action='+action,{redirect:'follow'}).then(r=>r.text()).then(txt=>{showLoading(false);const d=parseGASResponse(txt);if(d)cb(d);else showToast('R√©ponse serveur invalide',true);}).catch(e=>{showLoading(false);showToast('Erreur r√©seau: '+e.message,true);});}
function apiPost(action,payload,cb){if(!API_URL){cb(setLocalData(action,payload));return;}showLoading(true);var userName=(currentUser&&currentUser.name)?currentUser.name:(currentUser&&currentUser.username)?currentUser.username:'';var bodyData={action,...payload,user:userName};console.log('[apiPost]',action,JSON.stringify(bodyData).substring(0,200));fetch(API_URL,{method:'POST',redirect:'follow',headers:{'Content-Type':'text/plain'},body:JSON.stringify(bodyData)}).then(r=>r.text()).then(txt=>{showLoading(false);console.log('[apiPost response]',action,txt.substring(0,300));const d=parseGASResponse(txt);if(d){cb(d);}else{showToast('R√©ponse serveur invalide',true);cb({success:false,error:'R√©ponse invalide: '+txt.substring(0,100)});}}).catch(e=>{showLoading(false);console.error('[apiPost error]',action,e);showToast('Erreur r√©seau: '+e.message,true);cb({success:false,error:e.message});});}

function getLocalData(action){
    if(action==='getStudents') return {success:true,students:JSON.parse(localStorage.getItem('students')||'[]')};
    if(action==='getHistory') return {success:true,history:JSON.parse(localStorage.getItem('history')||'[]')};
    return {success:true};
}
function setLocalData(action,payload){
    let list=JSON.parse(localStorage.getItem('students')||'[]');
    let hist=JSON.parse(localStorage.getItem('history')||'[]');
    const now=new Date().toISOString();
    if(action==='saveStudent'){
        const s=payload.student;
        if(!s.id){s.id=Date.now().toString();s.creePar=currentUser?.name||'';s.creeDate=now;list.push(s);hist.push({date:now,user:currentUser?.name,action:'Cr√©ation',nom:s.nom,details:s.formation});}
        else{const idx=list.findIndex(x=>String(x.id)===String(s.id));if(idx>=0){s.modifiePar=currentUser?.name||'';s.modifieDate=now;list[idx]={...list[idx],...s};}hist.push({date:now,user:currentUser?.name,action:'Modification',nom:s.nom,details:''});}
        localStorage.setItem('students',JSON.stringify(list));localStorage.setItem('history',JSON.stringify(hist));return {success:true,student:s};
    }
    if(action==='deleteStudent'){const s=list.find(x=>String(x.id)===String(payload.id));list=list.filter(x=>String(x.id)!==String(payload.id));localStorage.setItem('students',JSON.stringify(list));if(s)hist.push({date:now,user:currentUser?.name,action:'Suppression',nom:s.nom,details:''});localStorage.setItem('history',JSON.stringify(hist));return {success:true};}
    if(action==='deleteAll'){localStorage.setItem('students','[]');hist.push({date:now,user:currentUser?.name,action:'Suppression totale',nom:list.length+' √©tudiants',details:''});localStorage.setItem('history',JSON.stringify(hist));return {success:true};}
    if(action==='importStudents'){
        for(const s of payload.students){
            const sNom=(s.nom||'').toUpperCase().trim();const sPre=(s.prenom||'').toUpperCase().trim();
            const existing=list.findIndex(x=>x.nom&&s.nom&&(x.nom||'').toUpperCase().trim()===sNom&&(x.prenom||'').toUpperCase().trim()===sPre);
            if(existing>=0){list[existing]={...list[existing],...s,modifiePar:currentUser?.name,modifieDate:now};}
            else{s.id=Date.now().toString()+Math.random().toString(36).slice(2,6);s.creePar=currentUser?.name||'';s.creeDate=now;list.push(s);}
        }
        hist.push({date:now,user:currentUser?.name,action:'Import',nom:payload.students.length+' √©tudiants',details:''});
        localStorage.setItem('students',JSON.stringify(list));localStorage.setItem('history',JSON.stringify(hist));return {success:true,count:payload.students.length};
    }
    return {success:true};
}

// STUDENTS
function normalizeStudentFields(s){
    // Map any sheet column name variant to the app's expected field name
    function nk(k){return k.toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^A-Z0-9]/g,'');}
    const map={
        'PR2NOM':'prenom','PRENOM':'prenom','FIRSTNAME':'prenom',
        'NOM':'nom','LASTNAME':'nom',
        'FORMATION':'formation','RYTHME':'rythme',
        'TELEPHONE':'telephone','PHONE':'telephone','TEL':'telephone',
        'BANQUE':'banque','NOTES':'notes',
        'PRELEVEMENT':'prelevement','CAUTION':'caution','CHQ':'chq',
        'TELTUTEUR':'telTuteur','NVXREINS':'nvxReins','NVX':'nvxReins',
        'ECHEANCES':'echeancesRaw','ECHEANCESRAW':'echeancesRaw','ECHEANCESJSON':'echeancesJson',
        'DATEINSCRIPTION':'dateInscription','DATE':'dateInscription',
        'PAID':'paid','TOTAL':'total','BADGES':'badges','CHQMONTANT':'chqMontant',
        'CREEPAR':'creePar','CREEDATE':'creeDate','MODIFIEPAR':'modifiePar','MODIFIEDATE':'modifieDate','ID':'id'
    };
    const n={};
    for(const[k,v] of Object.entries(s)){
        const mapped=map[nk(k)]||k;
        if(n[mapped]===undefined||n[mapped]===null||n[mapped]==='')n[mapped]=v;
    }
    return n;
}
function loadStudents(){apiGet('getStudents',d=>{if(d.success){
    if(d.students&&d.students[0])console.log('[loadStudents] Raw fields:',Object.keys(d.students[0]));
    students=(d.students||[]).map(s=>{
        s=normalizeStudentFields(s);
        if(s.id!==undefined&&s.id!==null)s.id=String(s.id);
        if(s.telephone)s.telephone=normalizePhone(String(s.telephone));
        if(s.telTuteur)s.telTuteur=normalizePhone(String(s.telTuteur));
        return s;
    });
    if(students[0])console.log('[loadStudents] Normalized prenom:',students[0].prenom,'nom:',students[0].nom);
    renderDashboard();renderStudents();renderStats();autoBackupIfNeeded();
}});}
function populateFormationFilter(){document.getElementById('filterFormation').innerHTML='<option value="">Toutes formations</option>'+FORMATIONS.map(f=>`<option>${esc(f)}</option>`).join('');}
function filterStudents(){
    const hasFilter=document.getElementById('searchBox').value.trim()||document.getElementById('filterFormation').value||document.getElementById('filterStatus').value||document.getElementById('filterRythme').value||document.getElementById('filterLate').value;
    if(hasFilter){switchTab('home');}
    document.getElementById('dashboard').style.display=hasFilter?'none':'';
    renderStudents();
}

function getFilteredStudents(){
    const q=document.getElementById('searchBox').value.toLowerCase().trim();
    const ff=document.getElementById('filterFormation').value;
    const fs=document.getElementById('filterStatus').value;
    const fr=document.getElementById('filterRythme').value;
    const fl=parseInt(document.getElementById('filterLate').value)||0;
    return students.filter(s=>{
        if(q){const fields=[s.nom,s.prenom,s.formation,s.telephone,s.banque,s.notes,s.telTuteur,s.nvxReins].map(x=>(x||'').toLowerCase()).join(' ');const totalStr=(s.total||0).toString();if(!fields.includes(q)&&!totalStr.includes(q))return false;}
        if(ff&&s.formation!==ff)return false;
        if(fs){const st=computeStatus(s);if(st!==fs)return false;}
        if(fr&&s.rythme!==fr)return false;
        if(fl){const days=getLateDays(s);if(days<fl)return false;}
        return true;
    });
}

function computeStatus(s){
    const echs=s.echeancesJson||[];
    if(echs.length===0)return 'pending';
    const now=new Date();
    if(echs.some(e=>!e.paid&&new Date(e.date)<now))return 'late';
    return echs.every(e=>e.paid)?'ok':'pending';
}
function getLateDays(s){const echs=s.echeancesJson||[];const now=new Date();let max=0;echs.forEach(e=>{if(!e.paid){const d=new Date(e.date);if(d<now){const diff=Math.floor((now-d)/86400000);if(diff>max)max=diff;}}});return max;}

function renderStudents(){
    const filtered=getFilteredStudents();
    document.getElementById('studentCount').textContent=`${filtered.length} √©tudiant${filtered.length>1?'s':''} sur ${students.length}`;
    document.getElementById('studentGrid').innerHTML=filtered.map(s=>{
        const status=computeStatus(s);const paid=(s.paid||0);const total=(s.total||0);
        const pct=total>0?Math.min(100,Math.round(paid/total*100)):0;
        const lateDays=getLateDays(s);
        const badgeCls=status==='ok'?'badge-ok':status==='late'?'badge-danger':'badge-warn';
        const badgeTxt=status==='ok'?'‚úÖ √Ä jour':status==='late'?'‚ö†Ô∏è En retard':'‚è≥ En attente';
        const barColor=status==='ok'?'var(--ok)':status==='late'?'var(--danger)':'var(--warn)';
        const displayName=s.prenom?`${esc(s.nom)} ${esc(s.prenom)}`:esc(s.nom);
        const nvxBadge=s.nvxReins?`<span class="badge ${s.nvxReins==='Nouveau'?'badge-nvx':'badge-info'}">${esc(s.nvxReins)}</span>`:'';
        const badgesHtml=(s.badges||[]).map(b=>`<span class="badge badge-warn">${esc(b)}</span>`).join('');
        return `<div class="student-card" onclick="openDetailModal('${s.id}')">
            ${lateDays>=30?`<span class="late-badge">${lateDays}j</span>`:''}
            <div class="name">${displayName}</div>
            <div class="meta"><span>${esc(s.formation||'‚Äî')}</span><span>${esc(s.rythme||'‚Äî')}</span>${nvxBadge}${badgesHtml}<span class="badge ${badgeCls}">${badgeTxt}</span></div>
            ${s.telephone?`<div style="color:var(--text2);font-size:0.82em;">üì± ${esc(s.telephone)}</div>`:''}
            <div class="progress-bar"><div class="progress-fill" style="width:${pct}%;background:${barColor};"></div></div>
            <div class="amounts"><span>${paid.toLocaleString('fr')}‚Ç¨ pay√©</span><span style="font-weight:700;color:${pct>=100?'var(--ok)':pct>=50?'var(--warn)':'var(--danger)'};">${pct}%</span><span>${total.toLocaleString('fr')}‚Ç¨ total</span></div>
        </div>`;
    }).join('');
}

// DASHBOARD
function renderDashboard(){
    if(students.length===0){document.getElementById('dashboard').innerHTML='';return;}
    const now=new Date();
    const total=students.length;
    const lateStudents=students.filter(s=>computeStatus(s)==='late').map(s=>{
        const echs=s.echeancesJson||[];
        const lateEchs=echs.filter(e=>!e.paid&&new Date(e.date)<now);
        const lateAmount=lateEchs.reduce((a,e)=>a+e.montant,0);
        const maxDays=getLateDays(s);
        return {...s,lateAmount,maxDays,lateCount:lateEchs.length};
    }).sort((a,b)=>b.maxDays-a.maxDays);
    const okCount=students.filter(s=>computeStatus(s)==='ok').length;
    const pendCount=students.filter(s=>computeStatus(s)==='pending').length;
    const tPaid=students.reduce((a,s)=>a+(s.paid||0),0);
    const tDue=students.reduce((a,s)=>a+(s.total||0),0);
    const tRem=tDue-tPaid;
    const globalPct=tDue>0?Math.round(tPaid/tDue*100):0;
    const totalLateAmount=lateStudents.reduce((a,s)=>a+s.lateAmount,0);
    
    // Upcoming payments (next 30 days)
    const in30=new Date(now.getTime()+30*86400000);
    const upcoming=[];
    students.forEach(s=>{
        (s.echeancesJson||[]).forEach(e=>{
            const d=new Date(e.date);
            if(!e.paid&&d>=now&&d<=in30){
                upcoming.push({student:s,date:d,montant:e.montant,type:e.type});
            }
        });
    });
    upcoming.sort((a,b)=>a.date-b.date);
    
    let h='';
    
    // --- Metrics row ---
    h+=`<div class="dash-metrics">
        <div class="dash-metric" onclick="applyFilter('','','')"><div class="dash-num" style="color:var(--info);">${total}</div><div class="dash-label">√âtudiants</div><div class="dash-sub">${okCount} √† jour ¬∑ ${pendCount} en attente</div></div>
        <div class="dash-metric" onclick="applyFilter('status','late','‚ö†Ô∏è En retard')"><div class="dash-num" style="color:var(--danger);">${lateStudents.length}</div><div class="dash-label">En retard</div><div class="dash-sub">${totalLateAmount.toLocaleString('fr')}‚Ç¨ impay√©s</div></div>
        <div class="dash-metric"><div class="dash-num" style="color:var(--ok);">${tPaid.toLocaleString('fr')}‚Ç¨</div><div class="dash-label">Encaiss√©</div><div class="dash-sub">${globalPct}% du total</div></div>
        <div class="dash-metric"><div class="dash-num" style="color:var(--warn);">${tRem.toLocaleString('fr')}‚Ç¨</div><div class="dash-label">Restant d√ª</div><div class="dash-sub">sur ${tDue.toLocaleString('fr')}‚Ç¨</div></div>
    </div>`;
    
    // --- Global progress bar ---
    h+=`<div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:12px 18px;margin-bottom:16px;">
        <div style="display:flex;justify-content:space-between;font-size:0.82em;color:var(--text2);margin-bottom:6px;"><span>Progression globale des paiements</span><span style="font-weight:700;color:var(--text);">${globalPct}%</span></div>
        <div style="height:10px;background:var(--surface2);border-radius:5px;overflow:hidden;"><div style="height:100%;width:${globalPct}%;background:${globalPct>=80?'var(--ok)':globalPct>=50?'var(--warn)':'var(--danger)'};border-radius:5px;transition:width 0.5s;"></div></div>
    </div>`;
    
    // --- Alerts ---
    if(lateStudents.length>0){
        const showMax=10;
        const displayed=lateStudents.slice(0,showMax);
        h+=`<div class="dash-alerts"><div class="dash-alerts-header"><h3>üö® Relances √† faire</h3><span class="count-badge">${lateStudents.length} √©tudiant${lateStudents.length>1?'s':''}</span></div>`;
        displayed.forEach(s=>{
            const severity=s.maxDays>=90?'critical':s.maxDays>=30?'warning':'minor';
            const sevLabel=s.maxDays>=90?'URGENT':s.maxDays>=30?'+'+s.maxDays+'j':s.maxDays+'j';
            const displayName=s.prenom?`${esc(s.nom)} ${esc(s.prenom)}`:esc(s.nom);
            h+=`<div class="dash-alert-item" onclick="openDetailModal('${s.id}')">
                <span class="alert-severity ${severity}">${sevLabel}</span>
                <span class="alert-name">${displayName}</span>
                <span class="alert-formation">${esc(s.formation||'')}</span>
                <span class="alert-amount">${s.lateAmount.toLocaleString('fr')}‚Ç¨ d√ª</span>
                <div class="alert-actions">
                    ${s.telephone?`<button class="btn btn-whatsapp btn-sm" onclick="event.stopPropagation();quickWhatsApp('${s.id}')" style="padding:3px 8px;font-size:0.72em;" title="WhatsApp">üì±</button>`:''}
                </div>
            </div>`;
        });
        if(lateStudents.length>showMax){
            h+=`<button class="dash-section-toggle" onclick="applyFilter('status','late','‚ö†Ô∏è En retard')">Voir les ${lateStudents.length} √©tudiants en retard ‚Üí</button>`;
        }
        h+=`</div>`;
    } else {
        h+=`<div class="dash-ok"><div class="ok-icon">‚úÖ</div><div class="ok-text">Aucun retard de paiement !</div><div class="ok-sub">Tous les √©tudiants sont √† jour ou en attente d'√©ch√©ances futures.</div></div>`;
    }
    
    // --- Upcoming ---
    if(upcoming.length>0){
        const showUp=Math.min(8,upcoming.length);
        const totalUpcoming=upcoming.reduce((a,u)=>a+u.montant,0);
        h+=`<div class="dash-upcoming"><div class="dash-upcoming-header"><h3>üìÖ Prochaines √©ch√©ances (30j) ‚Äî ${totalUpcoming.toLocaleString('fr')}‚Ç¨ attendus</h3></div>`;
        upcoming.slice(0,showUp).forEach(u=>{
            const displayName=u.student.prenom?`${esc(u.student.nom)} ${esc(u.student.prenom)}`:esc(u.student.nom);
            const daysUntil=Math.ceil((u.date-now)/86400000);
            const dateLabel=daysUntil===0?'Aujourd\'hui':daysUntil===1?'Demain':u.date.toLocaleDateString('fr-FR',{day:'2-digit',month:'short'});
            h+=`<div class="dash-upcoming-item" onclick="openDetailModal('${u.student.id}')">
                <span class="upcoming-date">${dateLabel}</span>
                <span class="upcoming-name">${displayName}</span>
                <span class="upcoming-amount">${u.montant.toLocaleString('fr')}‚Ç¨ ¬∑ ${esc(u.type||'')}</span>
            </div>`;
        });
        if(upcoming.length>showUp){
            h+=`<button class="dash-section-toggle" onclick="applyFilter('status','pending','‚è≥ En attente')">${upcoming.length-showUp} autres √©ch√©ances ‚Üí</button>`;
        }
        h+=`</div>`;
    }
    
    document.getElementById('dashboard').innerHTML=h;
}

function quickWhatsApp(id){
    const s=students.find(x=>String(x.id)===String(id));if(!s||!s.telephone)return;
    const waNum=phoneToWhatsApp(s.telephone);if(!waNum)return;
    currentStudentId=String(id);
    const msg=buildMessage(s);
    window.open(`https://wa.me/${waNum}?text=${encodeURIComponent(msg)}`,'_blank');
}

// PARSER
const MAX_ECHEANCES=120;
function makeDate(d,m,y){
    let yi=parseInt(String(y).trim());
    const ys=String(y).trim();
    // Fix typos: 206->2026, 205->2025, 255->2025, 269->2026, 026->2026
    if(ys.length===3){
        if(yi>=200&&yi<=209)yi=2020+(yi%10);
        else if(yi>=250&&yi<=259)yi=2025+(yi%10);
        else if(yi>=260&&yi<=269)yi=2026;
        else if(yi>=20&&yi<=99)yi=2000+yi;
        else yi=2025;
    }
    else if(yi<100)yi=2000+yi;
    if(yi<2020||yi>2030)yi=2025;
    let di=parseInt(d),mi=parseInt(m);
    // Fix day typos like "300" -> 30
    if(di>31)di=parseInt(String(di).slice(0,2));
    if(mi>12)mi=parseInt(String(mi).slice(0,2));
    if(mi<1||mi>12||di<1||di>31)return null;
    return new Date(yi,mi-1,di);
}

function detectType(text){
    const t=text.toUpperCase();
    if(/\bESP(?:ECE|ECES|√àCES?)?\b|\bESP\b/.test(t))return 'Esp√®ces';
    if(/\bCB\b/.test(t))return 'CB';
    if(/\bCH[E√à]?QU?E?\b|\bCHQ\b/.test(t))return 'Ch√®que';
    if(/\bVIR(?:EMENT|T|MT|EMT|MENT)?\b|\bVRT\b|\bVRMT\b|\bVIR[E√â]S?\b|\bVRT\b/.test(t))return 'Virement';
    if(/\bPVT\b|\bP[VR]T\b|\bPRELEV/i.test(t))return 'Pr√©l√®vement';
    return 'Pr√©l√®vement';
}

function extractBadges(raw){
    const badges=[];
    // (A EU LA REDUCTION DE X‚Ç¨)
    const redMatch=raw.match(/\(A\s+EU\s+LA\s+R[E√â]DUCTION\s+DE\s+(\d[\d\s]*(?:[.,]\d+)?)\s*‚Ç¨?\)/i);
    if(redMatch) badges.push('üè∑Ô∏è R√©duction '+redMatch[1].replace(/\s/g,'')+'‚Ç¨');
    // EARLY BIRDS X‚Ç¨
    const ebMatch=raw.match(/EARLY\s+BIRD?S?\s+(\d[\d\s]*(?:[.,]\d+)?)\s*‚Ç¨?/i);
    if(!ebMatch){const ebMatch2=raw.match(/EARLY\s+BRID[S]?\s+(\d[\d\s]*(?:[.,]\d+)?)\s*‚Ç¨?/i);if(ebMatch2)badges.push('üê¶ Early Birds '+ebMatch2[1].replace(/\s/g,'')+'‚Ç¨');}
    else badges.push('üê¶ Early Birds '+ebMatch[1].replace(/\s/g,'')+'‚Ç¨');
    // ERASMUS
    if(/ERASMUS/i.test(raw)) badges.push('üá™üá∫ Erasmus');
    return badges;
}

function parseEcheances(raw, dateInscription){
    if(!raw||!raw.trim())return {echeances:[],paid:0,total:0,badges:[]};
    const echeances=[];const now=new Date();
    // Date for "no date" payments: use inscription date if available, else today
    let fallbackDate=new Date(now);
    if(dateInscription){
        try{
            let fd;
            if(dateInscription.includes('-'))fd=new Date(dateInscription);
            else if(dateInscription.includes('/')){const p=dateInscription.split('/');let y=parseInt(p[2]);if(y<100)y+=2000;fd=new Date(y,parseInt(p[1])-1,parseInt(p[0]));}
            if(fd&&!isNaN(fd))fallbackDate=fd;
        }catch(e){}
    }
    const badges=extractBadges(raw);
    
    // Normalize text: fix double slashes, typos, extra spaces
    let text=raw
        .replace(/\/\/+/g,'/')          // double slashes
        .replace(/1U\b/gi,'AU')          // typo 1U -> AU
        .replace(/\bPUI\b/gi,'PUIS')     // typo PUI -> PUIS
        .replace(/\bPVRT\b/gi,'PVT')     // typo PVRT -> PVT
        .replace(/\bPVR\b/gi,'PVT')      // typo PVR -> PVT
        .replace(/\bPT\b(?=\s+DE?\s+\d)/gi,'PVT') // PT DE -> PVT DE
        .replace(/(\d)E\b(?!\w)/g,'$1‚Ç¨') // 760E -> 760‚Ç¨
        .replace(/(\d):(?=[a-zA-Z])/g,'$1/')  // 760‚Ç¨:virement -> 760‚Ç¨/virement
        .replace(/\bou\b(?=\s+\d{1,2}\/)/gi,'AU') // typo "ou" -> "AU" before date
        .replace(/\s+/g,' ').trim();
    
    // Remove badge sections from calculation (but keep the rest)
    text=text.replace(/\(A\s+EU\s+LA\s+R[E√â]DUCTION\s+DE\s+\d[\d\s]*(?:[.,]\d+)?\s*‚Ç¨?\)/gi,'');
    text=text.replace(/EARLY\s+BRID?S?\s+\d[\d\s]*(?:[.,]\d+)?\s*‚Ç¨?\s*[-‚Äì]?\s*/gi,'');
    
    const usedIdx=[];
    
    // PASS 1: "du DD/MM/YY au DD/MM/YY" ranges with amounts (allowing words like pvt/mois between amount and du)
    const rangeRe=/(\d[\d\s]*(?:[.,]\d+)?)\s*‚Ç¨?\s*(?:\/mois\s+)?(?:\w+\s+)*?(?:du|DU|DE)\s+(\d{1,3})[\/\-](\d{1,2})[\/\-](\d{2,4})\s*(?:au|AU)\s+(\d{1,3})[\/\-](\d{1,2})[\/\-](\d{2,4})/gi;
    let m;
    while((m=rangeRe.exec(text))!==null){
        const montant=parseFloat(m[1].replace(/\s/g,'').replace(',','.'));
        const dS=makeDate(m[2],m[3],m[4]),dE=makeDate(m[5],m[6],m[7]);
        if(!montant||!dS||!dE||isNaN(dS)||isNaN(dE))continue;
        const ctx=text.substring(Math.max(0,m.index-15),m.index+m[0].length);
        const type=detectType(ctx);
        let d=new Date(dS),cnt=0;
        while(d<=dE&&cnt<MAX_ECHEANCES){echeances.push({date:new Date(d),montant,type,paid:d<now,label:''});d.setMonth(d.getMonth()+1);cnt++;}
        usedIdx.push({s:m.index,e:m.index+m[0].length});
    }
    
    // PASS 1b: "X‚Ç¨ LE DD/MM/YY AU DD/MM/YY" (LE...AU as range, common pattern)
    const leAuRe=/(\d[\d\s]*(?:[.,]\d+)?)\s*‚Ç¨?\s*(?:\/mois\s+)?(?:\w+\s+)*?(?:le|LE)\s+(\d{1,3})[\/\-](\d{1,2})[\/\-](\d{2,4})\s*(?:au|AU)\s+(\d{1,3})[\/\-](\d{1,2})[\/\-](\d{2,4})/gi;
    leAuRe.lastIndex=0;
    while((m=leAuRe.exec(text))!==null){
        if(usedIdx.some(r=>m.index>=r.s&&m.index<r.e))continue;
        const montant=parseFloat(m[1].replace(/\s/g,'').replace(',','.'));
        const dS=makeDate(m[2],m[3],m[4]),dE=makeDate(m[5],m[6],m[7]);
        if(!montant||!dS||!dE||isNaN(dS)||isNaN(dE))continue;
        const ctx=text.substring(Math.max(0,m.index-15),m.index+m[0].length);
        const type=detectType(ctx);
        let d=new Date(dS),cnt=0;
        while(d<=dE&&cnt<MAX_ECHEANCES){echeances.push({date:new Date(d),montant,type,paid:d<now,label:''});d.setMonth(d.getMonth()+1);cnt++;}
        usedIdx.push({s:m.index,e:m.index+m[0].length});
    }
    
    // PASS 2: Single dated payments "X‚Ç¨ ... le DD/MM/YY" (‚Ç¨ optional)
    const singleRe=/(\d[\d\s]*(?:[.,]\d+)?)\s*‚Ç¨?[^‚Ç¨\d]{0,50}?\ble\s+(\d{1,2})[\/\-](\d{1,2})(?:[\/\-](\d{2,4}))?/gi;
    singleRe.lastIndex=0;
    while((m=singleRe.exec(text))!==null){
        if(usedIdx.some(r=>m.index>=r.s&&m.index<r.e))continue;
        const after=text.substring(m.index+m[0].length,m.index+m[0].length+30);
        if(/^\s*(?:au|AU)\s+\d/.test(after))continue;
        const montant=parseFloat(m[1].replace(/\s/g,'').replace(',','.'));
        if(!montant||montant<5)continue;
        let d;
        if(m[4])d=makeDate(m[2],m[3],m[4]);
        else{const mo=parseInt(m[3]);d=makeDate(m[2],m[3],mo>=8?'25':'26');}
        if(!d||isNaN(d))continue;
        const ctx=text.substring(Math.max(0,m.index-30),m.index+m[0].length+20);
        if(!echeances.some(e=>Math.abs(e.date-d)<864e5&&Math.abs(e.montant-montant)<0.01))
            echeances.push({date:d,montant,type:detectType(ctx),paid:d<now,label:''});
        usedIdx.push({s:m.index,e:m.index+m[0].length});
    }
    
    // PASS 3: "pvt X‚Ç¨ LE DD/MM/YY"
    const pvtRe=/(?:pvt?|pt|p[vr]t)\s+(?:de\s+)?(\d[\d\s]*(?:[.,]\d+)?)\s*‚Ç¨?\s*(?:le|LE)\s+(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/gi;
    pvtRe.lastIndex=0;
    while((m=pvtRe.exec(text))!==null){
        if(usedIdx.some(r=>m.index>=r.s&&m.index<r.e))continue;
        const after=text.substring(m.index+m[0].length,m.index+m[0].length+30);
        if(/^\s*(?:au|AU)\s+\d/.test(after))continue;
        const montant=parseFloat(m[1].replace(/\s/g,'').replace(',','.'));
        const d=makeDate(m[2],m[3],m[4]);
        if(!montant||!d||isNaN(d))continue;
        if(!echeances.some(e=>Math.abs(e.date-d)<864e5&&Math.abs(e.montant-montant)<0.01))
            echeances.push({date:d,montant,type:'Pr√©l√®vement',paid:d<now,label:''});
    }
    
    // PASS 3b: "pvt X‚Ç¨ DD/MM/YY" (without "le")
    const pvtNoLeRe=/(?:pvt?|p[vr]t)\s+(?:de\s+)?(\d[\d\s]*(?:[.,]\d+)?)\s*‚Ç¨?\s+(\d{1,2})[\/\-](\d{1,2})[\/\-]?(\d{2,4})?/gi;
    pvtNoLeRe.lastIndex=0;
    while((m=pvtNoLeRe.exec(text))!==null){
        if(usedIdx.some(r=>m.index>=r.s&&m.index<r.e))continue;
        const montant=parseFloat(m[1].replace(/\s/g,'').replace(',','.'));
        if(!montant||montant<5)continue;
        let d;
        if(m[4])d=makeDate(m[2],m[3],m[4]);
        else{const mo=parseInt(m[3]);d=makeDate(m[2],m[3],mo>=8?'25':'26');}
        if(!d||isNaN(d))continue;
        if(!echeances.some(e=>Math.abs(e.date-d)<864e5&&Math.abs(e.montant-montant)<0.01))
            echeances.push({date:d,montant,type:'Pr√©l√®vement',paid:d<now,label:''});
    }
    
    // PASS 4: Dash/ET separated single amounts with dates: "X‚Ç¨ LE DD/MM/YY - X‚Ç¨ LE DD/MM/YY" or "ET X‚Ç¨ LE DD/MM"
    const dashRe=/(\d[\d\s]*(?:[.,]\d+)?)\s*‚Ç¨?\s*(?:le|LE)\s+(\d{1,2})[\/\-](\d{1,2})(?:[\/\-](\d{2,4}))?/gi;
    dashRe.lastIndex=0;
    while((m=dashRe.exec(text))!==null){
        if(usedIdx.some(r=>m.index>=r.s&&m.index<r.e))continue;
        const after=text.substring(m.index+m[0].length,m.index+m[0].length+30);
        if(/^\s*(?:au|AU)\s+\d/.test(after))continue;
        const montant=parseFloat(m[1].replace(/\s/g,'').replace(',','.'));
        if(!montant||montant<5)continue;
        let d;
        if(m[4])d=makeDate(m[2],m[3],m[4]);
        else{const mo=parseInt(m[3]);d=makeDate(m[2],m[3],mo>=8?'25':'26');}
        if(!d||isNaN(d))continue;
        if(!echeances.some(e=>Math.abs(e.date-d)<864e5&&Math.abs(e.montant-montant)<0.01))
            echeances.push({date:d,montant,type:detectType(text.substring(Math.max(0,m.index-30),m.index+m[0].length+20)),paid:d<now,label:''});
    }
    
    // PASS 5: "√† SM" payments (paid to SM, no date)
    const smRe=/(?:a\s+)?(?:r[e√©√®]gl[e√©√®][crd]?\s+)?(\d[\d\s]*(?:[.,]\d+)?)\s*‚Ç¨?\s*(?:√†|a)\s+SM/gi;
    smRe.lastIndex=0;
    while((m=smRe.exec(text))!==null){
        const montant=parseFloat(m[1].replace(/\s/g,'').replace(',','.'));
        if(!montant)continue;
        if(!echeances.some(e=>Math.abs(e.montant-montant)<0.01&&e.label==='Paiement SM'))
            echeances.push({date:new Date(fallbackDate),montant,type:'Autre',paid:true,label:'Paiement SM'});
    }
    
    // PASS 5b: "SM- X‚Ç¨ r√©gl√©s" (SM at beginning)
    const smStartRe=/SM\s*[-‚Äì:]\s*(\d[\d\s]*(?:[.,]\d+)?)\s*‚Ç¨?\s*(?:r[e√©√®]gl|pay)/gi;
    smStartRe.lastIndex=0;
    while((m=smStartRe.exec(text))!==null){
        const montant=parseFloat(m[1].replace(/\s/g,'').replace(',','.'));
        if(!montant)continue;
        if(!echeances.some(e=>Math.abs(e.montant-montant)<0.01&&e.label==='Paiement SM'))
            echeances.push({date:new Date(fallbackDate),montant,type:'Autre',paid:true,label:'Paiement SM'});
    }
    
    // PASS 6: "r√©gl√© X‚Ç¨" without date (already paid, no date found)
    const noDateRe=/(?:a\s+)?(?:r[e√©√®]gl[e√©√®][crd]?\s+)(\d[\d\s]*(?:[.,]\d+)?)\s*‚Ç¨?\s*(?:[\/:\s]*(?:CB|ESP(?:ECE|ECES)?|VIREMENT|VRT|VRMT|CHQ|en\s+\w+))?(?!\s*(?:le|LE|du|DU)\s+\d)/gi;
    noDateRe.lastIndex=0;
    while((m=noDateRe.exec(text))!==null){
        if(usedIdx.some(r=>m.index>=r.s&&m.index<r.e))continue;
        const montant=parseFloat(m[1].replace(/\s/g,'').replace(',','.'));
        if(!montant||montant<5)continue;
        // Check if this "r√©gl√©" already has a date captured
        const nearby=text.substring(m.index,m.index+m[0].length+40);
        if(/\ble\s+\d{1,2}[\/\-]\d/i.test(nearby))continue;
        const ctx=text.substring(Math.max(0,m.index-20),m.index+m[0].length+20);
        if(!echeances.some(e=>Math.abs(e.montant-montant)<0.01&&e.paid))
            echeances.push({date:new Date(fallbackDate),montant,type:detectType(ctx),paid:true,label:'Sans date'});
    }
    
    // PASS 6b: "Acompte X‚Ç¨" or "X‚Ç¨ conserv√©s" or "R√©gl√© par chq X‚Ç¨"
    const acompteRe=/(?:acompte|conserv[e√©]s?)\s*(\d[\d\s]*(?:[.,]\d+)?)\s*‚Ç¨?/gi;
    acompteRe.lastIndex=0;
    while((m=acompteRe.exec(text))!==null){
        const montant=parseFloat(m[1].replace(/\s/g,'').replace(',','.'));
        if(!montant)continue;
        if(!echeances.some(e=>Math.abs(e.montant-montant)<0.01&&e.paid))
            echeances.push({date:new Date(fallbackDate),montant,type:'Autre',paid:true,label:'Acompte'});
    }
    
    // PASS 6c: "R√©gl√© par chq X‚Ç¨ et X‚Ç¨" 
    const chqRe=/r[e√©√®]gl[e√©√®][crd]?\s+par\s+ch[qe]\w*\s+(\d[\d\s]*(?:[.,]\d+)?)\s*‚Ç¨?\s*(?:et\s+(\d[\d\s]*(?:[.,]\d+)?)\s*‚Ç¨?)?/gi;
    chqRe.lastIndex=0;
    while((m=chqRe.exec(text))!==null){
        const montant1=parseFloat(m[1].replace(/\s/g,'').replace(',','.'));
        if(montant1&&!echeances.some(e=>Math.abs(e.montant-montant1)<0.01&&e.paid))
            echeances.push({date:new Date(fallbackDate),montant:montant1,type:'Ch√®que',paid:true,label:'Ch√®que'});
        if(m[2]){
            const montant2=parseFloat(m[2].replace(/\s/g,'').replace(',','.'));
            if(montant2&&!echeances.some(e=>Math.abs(e.montant-montant2)<0.01&&e.paid))
                echeances.push({date:new Date(fallbackDate),montant:montant2,type:'Ch√®que',paid:true,label:'Ch√®que'});
        }
    }
    
    // PASS 7: catch remaining "amount + date" patterns (‚Ç¨ optional)
    const catchAllRe=/(\d[\d\s]*(?:[.,]\d+)?)\s*‚Ç¨?\s*[^a-zA-Z√Ä-√∫]*?(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/gi;
    catchAllRe.lastIndex=0;
    while((m=catchAllRe.exec(text))!==null){
        if(usedIdx.some(r=>m.index>=r.s&&m.index<r.e))continue;
        const montant=parseFloat(m[1].replace(/\s/g,'').replace(',','.'));
        const d=makeDate(m[2],m[3],m[4]);
        if(!montant||!d||isNaN(d)||montant<10)continue;
        if(!echeances.some(e=>Math.abs(e.date-d)<864e5*2&&Math.abs(e.montant-montant)<0.01)){
            const ctx=text.substring(Math.max(0,m.index-30),m.index+m[0].length+20);
            echeances.push({date:d,montant,type:detectType(ctx),paid:d<now,label:''});
        }
    }
    
    // Sort + deduplicate
    echeances.sort((a,b)=>a.date-b.date);
    const unique=[];
    for(const e of echeances){if(!unique.some(u=>Math.abs(u.date.getTime()-e.date.getTime())<864e5&&Math.abs(u.montant-e.montant)<0.01))unique.push(e);}
    
    let paidTotal=0,grandTotal=0;
    unique.forEach(e=>{grandTotal+=e.montant;if(e.paid)paidTotal+=e.montant;});
    return {echeances:unique,paid:Math.round(paidTotal*100)/100,total:Math.round(grandTotal*100)/100,badges};
}

// DETAIL MODAL
function openDetailModal(id){
    currentStudentId=String(id);const s=students.find(x=>String(x.id)===String(id));if(!s)return;
    document.getElementById('detailTitle').textContent=s.prenom?`${s.nom} ${s.prenom}`:s.nom;
    const fOpts=FORMATIONS.map(f=>`<option ${f===s.formation?'selected':''}>${esc(f)}</option>`).join('');
    const rOpts=RYTHMES.map(r=>`<option ${r===s.rythme?'selected':''}>${esc(r)}</option>`).join('');
    const nOpts=['','Nouveau','R√©inscription'].map(v=>`<option value="${v}" ${v===(s.nvxReins||'')?'selected':''}>${v||'‚Äî'}</option>`).join('');
    const status=computeStatus(s);
    const sBadge=status==='ok'?'<span class="badge badge-ok">‚úÖ √Ä jour</span>':status==='late'?'<span class="badge badge-danger">‚ö†Ô∏è En retard</span>':'<span class="badge badge-warn">‚è≥ En attente</span>';
    const detailBadges=(s.badges||[]).map(b=>`<span class="badge badge-warn">${esc(b)}</span>`).join('');
    
    let html=`<div style="display:flex;gap:12px;align-items:center;margin-bottom:16px;flex-wrap:wrap;">${sBadge}${detailBadges}${s.dateInscription?`<span style="color:var(--text2);font-size:0.82em;">üìÖ Inscrit le ${esc(s.dateInscription)}</span>`:''}
    <div style="margin-left:auto;display:flex;gap:6px;">
        ${s.telephone?`<button class="btn btn-whatsapp btn-sm" onclick="sendWhatsApp('student')" title="WhatsApp √©tudiant">üì± WhatsApp</button>`:''}
        ${s.telTuteur?`<button class="btn btn-whatsapp btn-sm" onclick="sendWhatsApp('tuteur')" title="WhatsApp tuteur" style="background:#128C7E;">üì± Tuteur</button>`:''}
        <button class="btn btn-email btn-sm" onclick="sendEmail()">‚úâÔ∏è Email</button>
    </div></div>
    <div class="form-row"><div class="form-group"><label>Nom</label><input class="inline-field" id="editNom" value="${esc(s.nom||'')}"></div><div class="form-group"><label>Pr√©nom</label><input class="inline-field" id="editPrenom" value="${esc(s.prenom||'')}"></div></div>
    <div class="form-row"><div class="form-group"><label>T√©l√©phone</label><input type="tel" class="inline-field" id="editPhone" value="${esc(s.telephone||'')}"></div><div class="form-group"><label>T√©l. Tuteur/Contact</label><input type="tel" class="inline-field" id="editTelTuteur" value="${esc(s.telTuteur||'')}"></div></div>
    <div class="form-row-3"><div class="form-group"><label>Formation</label><select class="inline-select" id="editFormation">${fOpts}</select></div><div class="form-group"><label>Rythme</label><select class="inline-select" id="editRythme">${rOpts}</select></div><div class="form-group"><label>Nvx/R√©inscription</label><select class="inline-select" id="editNvxReins">${nOpts}</select></div></div>
    <div class="form-row-3"><div class="form-group"><label>Pr√©l√®vement</label><select class="inline-select" id="editPrelevement"><option value="" ${!s.prelevement?'selected':''}>‚Äî</option><option value="OUI" ${s.prelevement==='OUI'?'selected':''}>OUI</option><option value="NON" ${s.prelevement==='NON'?'selected':''}>NON</option></select></div><div class="form-group"><label>Caution</label><select class="inline-select" id="editChq" onchange="toggleChqFields()"><option value="false" ${!s.chq?'selected':''}>Non</option><option value="true" ${s.chq?'selected':''}>Oui</option></select></div><div class="form-group"><label>Banque</label><input class="inline-field" id="editBanque" value="${esc(s.banque||'')}"></div></div>
    <div class="form-row" id="chqMontantGroup" style="${s.chq?'':'display:none'}"><div class="form-group"><label>Montant ch√®que caution</label><input type="number" class="inline-field" id="editChqMontant" value="${s.chqMontant||''}"></div><div></div></div>
    <div class="form-group"><label>Notes</label><textarea class="inline-field" id="editNotes" rows="2">${esc(s.notes||'')}</textarea></div>
    <div class="form-group"><label>Date d'inscription</label><input type="date" class="inline-field" id="editDateInscription" value="${dateToInput(s.dateInscription)}"></div>`;
    
    html+=buildEcheancierHtml(s);
    if(s.creePar||s.modifiePar){html+=`<div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border);color:var(--text2);font-size:0.78em;">`;if(s.creePar)html+=`Cr√©√© par ${esc(s.creePar)} le ${fmtDate(s.creeDate)}<br>`;if(s.modifiePar)html+=`Modifi√© par ${esc(s.modifiePar)} le ${fmtDate(s.modifieDate)}`;html+=`</div>`;}
    document.getElementById('detailBody').innerHTML=html;document.getElementById('detailModal').classList.add('active');
}

function toggleChqFields(){const show=document.getElementById('editChq').value==='true';document.getElementById('chqMontantGroup').style.display=show?'':'none';}
function dateToInput(ds){if(!ds)return '';if(ds.includes('-')&&ds.length===10)return ds;const p=ds.split('/');if(p.length<3)return '';let y=parseInt(p[2]);if(y<100)y+=2000;return `${y}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`;}
function inputToDate(v){if(!v)return '';const p=v.split('-');return `${p[2]}/${p[1]}/${p[0]}`;}

function buildEcheancierHtml(s){
    const echs=s.echeancesJson||[];
    let h=`<div class="ech-section"><h3>üìÖ √âch√©ancier (${echs.length} √©ch√©ances)</h3>`;
    if(echs.length>0){
        const paid=echs.filter(e=>e.paid).reduce((a,e)=>a+e.montant,0);const total=echs.reduce((a,e)=>a+e.montant,0);const rem=total-paid;const pct=total>0?Math.round(paid/total*100):0;
        h+=`<div style="display:flex;gap:16px;margin-bottom:8px;font-size:0.85em;flex-wrap:wrap;"><span style="color:var(--ok);">‚úÖ Pay√©: ${paid.toLocaleString('fr')}‚Ç¨</span><span style="color:var(--warn);">‚è≥ Restant: ${rem.toLocaleString('fr')}‚Ç¨</span><span>Total: ${total.toLocaleString('fr')}‚Ç¨ (${pct}%)</span></div>`;
        h+=`<p style="color:var(--text2);font-size:0.75em;margin-bottom:8px;">üí° Cliquez sur une date, un montant ou un type pour le modifier directement</p>`;
        h+=`<table class="ech-table"><thead><tr><th></th><th>Date</th><th>Montant</th><th>Type</th><th>Statut</th><th class="write-only"></th></tr></thead><tbody>`;
        echs.forEach((e,i)=>{
            const d=new Date(e.date);const isLate=!e.paid&&d<new Date();const cls=e.paid?'paid':isLate?'late':'';
            h+=`<tr class="${cls}"><td><input type="checkbox" ${e.paid?'checked':''} onchange="togglePaid(${i},this.checked)" class="write-only"></td><td><span class="ech-editable" onclick="editEchDate(${i},this)">${d.toLocaleDateString('fr-FR')}</span></td><td><span class="ech-editable" onclick="editEchAmount(${i},this)">${e.montant.toLocaleString('fr')}‚Ç¨</span></td><td><span class="ech-editable" onclick="editEchType(${i},this)">${esc(e.type||'Pr√©l√®vement')}</span></td><td>${e.paid?'‚úÖ':isLate?'‚ö†Ô∏è Retard':'‚è≥'}</td><td class="write-only"><button class="btn btn-danger btn-sm" onclick="deleteEch(${i})" style="padding:2px 6px;font-size:0.75em;">‚úï</button></td></tr>`;
        });
        h+=`</tbody></table>`;
    }
    h+=`<div class="ech-add-row write-only"><input type="date" id="newEchDate"><input type="number" id="newEchAmount" placeholder="Montant" step="0.01" style="width:100px;"><select id="newEchType">${TYPES_PAIEMENT.map(t=>`<option>${t}</option>`).join('')}</select><button class="btn btn-primary btn-sm" onclick="addEcheance()">+ Ajouter</button></div>`;
    h+=`<div style="margin-top:12px;padding-top:12px;border-top:1px dashed var(--border);"><div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;"><label style="font-size:0.78em;color:var(--text2);font-weight:600;text-transform:uppercase;letter-spacing:0.5px;">Texte brut des √©ch√©ances</label><button class="btn btn-primary btn-sm" onclick="reparseEcheances()">üîÑ Recalculer</button></div><textarea id="editEcheances" rows="3" style="width:100%;padding:8px;background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:inherit;font-size:0.85em;">${esc(s.echeancesRaw||'')}</textarea></div></div>`;
    return h;
}

// ECH EDITING
function getEcheances(){const s=students.find(x=>String(x.id)===String(currentStudentId));return s?(s.echeancesJson||[]):[];}
function saveEch(echs){
    const s=students.find(x=>String(x.id)===String(currentStudentId));if(!s)return;
    s.echeancesJson=echs;
    s.paid=Math.round(echs.filter(e=>e.paid).reduce((a,e)=>a+e.montant,0)*100)/100;
    s.total=Math.round(echs.reduce((a,e)=>a+e.montant,0)*100)/100;
    // Refresh UI IMMEDIATELY with local data (no server wait)
    openDetailModal(currentStudentId);
    renderStudents();
    renderDashboard();
    // Save to server in background
    apiPost('saveStudent',{student:s},d=>{
        if(!d.success)showToast('‚ùå Erreur sauvegarde: '+(d.error||''),true);
    });
}
function togglePaid(i,v){const e=getEcheances();if(e[i]){e[i].paid=v;saveEch(e);}}
function deleteEch(i){const e=getEcheances();e.splice(i,1);saveEch(e);}
function addEcheance(){const dv=document.getElementById('newEchDate').value,amt=parseFloat(document.getElementById('newEchAmount').value),tp=document.getElementById('newEchType').value;if(!dv||!amt){showToast('Date et montant requis',true);return;}const d=new Date(dv);const e=getEcheances();e.push({date:d.toISOString(),montant:amt,type:tp,paid:d<new Date(),label:''});e.sort((a,b)=>new Date(a.date)-new Date(b.date));showToast(`‚úÖ √âch√©ance de ${amt}‚Ç¨ ajout√©e`);saveEch(e);}

function editEchDate(i,el){const e=getEcheances();if(!e[i])return;const d=new Date(e[i].date);const inp=document.createElement('input');inp.type='date';inp.value=d.toISOString().slice(0,10);inp.style.cssText='background:var(--surface2);border:1px solid var(--primary);border-radius:4px;color:var(--text);padding:2px 6px;';el.replaceWith(inp);inp.focus();const save=()=>{const nd=new Date(inp.value);if(!isNaN(nd)){e[i].date=nd.toISOString();e[i].paid=nd<new Date();saveEch(e);}else openDetailModal(currentStudentId);};inp.addEventListener('change',save);inp.addEventListener('blur',save);inp.addEventListener('keydown',ev=>{if(ev.key==='Escape')openDetailModal(currentStudentId);});}
function editEchAmount(i,el){const e=getEcheances();if(!e[i])return;const inp=document.createElement('input');inp.type='number';inp.step='0.01';inp.value=e[i].montant;inp.style.cssText='background:var(--surface2);border:1px solid var(--primary);border-radius:4px;color:var(--text);padding:2px 6px;width:100px;';el.replaceWith(inp);inp.focus();inp.select();const save=()=>{const v=parseFloat(inp.value);if(v>0){e[i].montant=v;saveEch(e);}else openDetailModal(currentStudentId);};inp.addEventListener('blur',save);inp.addEventListener('keydown',ev=>{if(ev.key==='Enter')save();if(ev.key==='Escape')openDetailModal(currentStudentId);});}
function editEchType(i,el){const e=getEcheances();if(!e[i])return;const sel=document.createElement('select');sel.style.cssText='background:var(--surface2);border:1px solid var(--primary);border-radius:4px;color:var(--text);padding:2px 6px;';TYPES_PAIEMENT.forEach(t=>{const o=document.createElement('option');o.value=t;o.textContent=t;if(t===e[i].type)o.selected=true;sel.appendChild(o);});el.replaceWith(sel);sel.focus();const save=()=>{e[i].type=sel.value;saveEch(e);};sel.addEventListener('change',save);sel.addEventListener('blur',save);}

function reparseEcheances(){
    const raw=document.getElementById('editEcheances').value.trim();
    const s=students.find(x=>String(x.id)===String(currentStudentId));if(!s)return;
    s.echeancesRaw=raw;
    if(raw){
        const p=parseEcheances(raw, s.dateInscription);
        s.echeancesJson=p.echeances.map(e=>({date:e.date.toISOString(),montant:e.montant,type:e.type,paid:e.paid,label:e.label||''}));
        s.paid=p.paid;s.total=p.total;s.badges=p.badges||[];
    } else {
        s.echeancesJson=[];s.paid=0;s.total=0;s.badges=[];
    }
    // Refresh UI immediately
    showToast('‚úÖ √âch√©ancier recalcul√© ‚Äî '+((s.echeancesJson||[]).length)+' √©ch√©ances');
    openDetailModal(currentStudentId);
    renderStudents();
    renderDashboard();
    // Save to server in background
    apiPost('saveStudent',{student:s},d=>{
        if(!d.success)showToast('‚ùå Erreur sauvegarde: '+(d.error||''),true);
    });
}

// SAVE DETAIL
// CONTACT
function phoneToWhatsApp(phone){
    if(!phone)return '';
    let n=phone.replace(/[^0-9]/g,'');
    if(n.startsWith('0'))n='33'+n.slice(1);
    else if(!n.startsWith('33'))n='33'+n;
    return n;
}
function buildMessage(s){
    const echs=s.echeancesJson||[];const now=new Date();
    const lateEchs=echs.filter(e=>!e.paid&&new Date(e.date)<now);
    const prenom=s.prenom||'';const nom=s.nom||'';
    const displayName=prenom?(prenom+' '+nom):nom;
    let msg='';
    if(lateEchs.length>0){
        const totalLate=lateEchs.reduce((a,e)=>a+e.montant,0);
        msg=`Bonjour ${prenom||nom},\n\nNous vous contactons concernant votre dossier √† l'√©cole.\n\n`;
        msg+=`Nous constatons que ${lateEchs.length===1?'un paiement est':'des paiements sont'} en attente :\n\n`;
        lateEchs.forEach(e=>{
            const d=new Date(e.date);
            msg+=`‚Ä¢ ${e.montant.toLocaleString('fr')}‚Ç¨ ‚Äî √©ch√©ance du ${d.toLocaleDateString('fr-FR')}`;
            const days=Math.floor((now-d)/86400000);
            msg+=` (${days} jours de retard)\n`;
        });
        msg+=`\nMontant total en retard : ${totalLate.toLocaleString('fr')}‚Ç¨\n\n`;
        msg+=`Merci de bien vouloir proc√©der √† la r√©gularisation dans les meilleurs d√©lais.\n\n`;
        msg+=`Pour toute question ou difficult√©, n'h√©sitez pas √† nous contacter.\n\nCordialement,\nService scolarit√©`;
    } else {
        const remaining=echs.filter(e=>!e.paid);
        const totalRem=remaining.reduce((a,e)=>a+e.montant,0);
        msg=`Bonjour ${prenom||nom},\n\nNous vous contactons concernant votre dossier √† l'√©cole.\n\n`;
        if(remaining.length>0){
            const next=remaining[0];const nd=new Date(next.date);
            msg+=`Pour information, votre prochaine √©ch√©ance est de ${next.montant.toLocaleString('fr')}‚Ç¨ le ${nd.toLocaleDateString('fr-FR')}.\n`;
            msg+=`Restant d√ª : ${totalRem.toLocaleString('fr')}‚Ç¨ (${remaining.length} √©ch√©ance${remaining.length>1?'s':''}).\n\n`;
        } else {
            msg+=`Votre dossier de paiement est √† jour. Merci !\n\n`;
        }
        msg+=`Pour toute question, n'h√©sitez pas √† nous contacter.\n\nCordialement,\nService scolarit√©`;
    }
    return msg;
}
function buildSubject(s){
    const echs=s.echeancesJson||[];const now=new Date();
    const lateEchs=echs.filter(e=>!e.paid&&new Date(e.date)<now);
    const displayName=s.prenom?`${s.nom} ${s.prenom}`:s.nom;
    if(lateEchs.length>0) return `Rappel paiement ‚Äî ${displayName} ‚Äî ${s.formation||''}`;
    return `Information scolarit√© ‚Äî ${displayName} ‚Äî ${s.formation||''}`;
}
function sendWhatsApp(target){
    const s=students.find(x=>String(x.id)===String(currentStudentId));if(!s)return;
    const phone=target==='tuteur'?s.telTuteur:s.telephone;
    const waNum=phoneToWhatsApp(phone);
    if(!waNum){showToast('Pas de num√©ro de t√©l√©phone',true);return;}
    const msg=buildMessage(s);
    window.open(`https://wa.me/${waNum}?text=${encodeURIComponent(msg)}`,'_blank');
}
function sendEmail(){
    const s=students.find(x=>String(x.id)===String(currentStudentId));if(!s)return;
    const msg=buildMessage(s);
    const subject=buildSubject(s);
    window.open(`mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(msg)}`,'_blank');
}

function saveDetailFields(){
    const s=students.find(x=>String(x.id)===String(currentStudentId));if(!s)return;
    s.nom=document.getElementById('editNom').value.trim();s.prenom=document.getElementById('editPrenom').value.trim();
    s.telephone=normalizePhone(document.getElementById('editPhone').value.trim());s.telTuteur=normalizePhone(document.getElementById('editTelTuteur').value.trim());
    s.formation=document.getElementById('editFormation').value;s.rythme=document.getElementById('editRythme').value;
    s.nvxReins=document.getElementById('editNvxReins').value;s.prelevement=document.getElementById('editPrelevement').value;
    s.caution=document.getElementById('editChq').value==='true'?'OUI':'NON';s.banque=document.getElementById('editBanque').value.trim();
    s.chq=document.getElementById('editChq').value==='true';s.chqMontant=s.chq?parseFloat(document.getElementById('editChqMontant').value)||0:0;
    s.notes=document.getElementById('editNotes').value.trim();s.dateInscription=inputToDate(document.getElementById('editDateInscription').value);
    apiPost('saveStudent',{student:s},d=>{if(d.success){loadStudents();closeModal('detailModal');showToast('‚úÖ Modifications enregistr√©es');}else showToast('Erreur: '+(d.error||''),true);});
}
function deleteStudent(){if(!confirm('Supprimer cet √©tudiant ?'))return;apiPost('deleteStudent',{id:currentStudentId},d=>{if(d.success){loadStudents();closeModal('detailModal');showToast('üóëÔ∏è √âtudiant supprim√©');}else{showToast('‚ùå Erreur suppression: '+(d.error||'√©chec serveur'),true);}});}
function deleteAllStudents(){
    if(!currentUser||currentUser.role!=='admin'){showToast('Seul un administrateur peut tout effacer',true);return;}
    const n=students.length;if(n===0){showToast('Aucun √©tudiant √† supprimer',true);return;}
    if(!confirm('Supprimer les ' + n + ' fiches ? Cette action est irreversible !'))return;
    // Backup before delete
    createBackup('Avant suppression totale de '+n+' fiches');
    // Local mode: direct clear
    if(!API_URL){
        localStorage.setItem('students','[]');
        const hist=JSON.parse(localStorage.getItem('history')||'[]');
        hist.push({date:new Date().toISOString(),user:currentUser?.name,action:'Suppression totale',nom:n+' √©tudiants',details:''});
        localStorage.setItem('history',JSON.stringify(hist));
        students=[];renderDashboard();renderStudents();renderStats();showToast(n+' fiches supprimees');return;
    }
    // Server mode: delete one by one using apiPost
    const ids=students.map(s=>String(s.id));
    let deleted=0,errors=0;
    function deleteNext(){
        if(ids.length===0){
            loadStudents();
            renderStats();
            if(errors>0)showToast(deleted+' supprimees, '+errors+' erreurs',true);
            else showToast(deleted+' fiches supprimees');
            return;
        }
        const id=ids.shift();
        apiPost('deleteStudent',{id:id},function(d){
            if(d&&d.success)deleted++;else errors++;
            deleteNext();
        });
    }
    deleteNext();
}

// CREATE
function openCreateModal(){
    const fO=FORMATIONS.map(f=>`<option>${esc(f)}</option>`).join('');const rO=RYTHMES.map(r=>`<option>${esc(r)}</option>`).join('');
    document.getElementById('createBody').innerHTML=`
    <div class="form-row"><div class="form-group"><label>Nom *</label><input id="createNom" placeholder="NOM"></div><div class="form-group"><label>Pr√©nom</label><input id="createPrenom" placeholder="Pr√©nom"></div></div>
    <div class="form-row"><div class="form-group"><label>T√©l√©phone</label><input type="tel" id="createPhone" placeholder="0600000000"></div><div class="form-group"><label>T√©l. Tuteur</label><input type="tel" id="createTelTuteur"></div></div>
    <div class="form-row-3"><div class="form-group"><label>Formation *</label><select id="createFormation">${fO}</select></div><div class="form-group"><label>Rythme</label><select id="createRythme">${rO}</select></div><div class="form-group"><label>Nvx/R√©ins</label><select id="createNvxReins"><option value="">‚Äî</option><option>Nouveau</option><option>R√©inscription</option></select></div></div>
    <div class="form-row-3"><div class="form-group"><label>Pr√©l√®vement</label><select id="createPrelevement"><option value="">‚Äî</option><option>OUI</option><option>NON</option></select></div><div class="form-group"><label>Caution</label><select id="createCaution"><option value="false">Non</option><option value="true">Oui</option></select></div><div class="form-group"><label>Banque</label><input id="createBanque"></div></div>
    <div class="form-group"><label>√âch√©ancier (texte brut)</label><textarea id="createEcheances" rows="3" placeholder="Ex: 760‚Ç¨ PVT LE 30/09/25 PUIS PVT DE 323‚Ç¨ DU 30/10/25 AU 30/07/26"></textarea></div>
    <div class="form-group"><label>Notes</label><textarea id="createNotes" rows="2"></textarea></div>`;
    document.getElementById('createModal').classList.add('active');
}
function createStudent(){
    const nom=document.getElementById('createNom').value.trim();if(!nom){showToast('Le nom est obligatoire',true);return;}
    const raw=document.getElementById('createEcheances').value.trim();const parsed=raw?parseEcheances(raw):{echeances:[],paid:0,total:0,badges:[]};
    const chqVal=document.getElementById('createCaution').value==='true';
    const s={nom,prenom:document.getElementById('createPrenom').value.trim(),formation:document.getElementById('createFormation').value,rythme:document.getElementById('createRythme').value,telephone:normalizePhone(document.getElementById('createPhone').value),telTuteur:document.getElementById('createTelTuteur').value.trim(),nvxReins:document.getElementById('createNvxReins').value,prelevement:document.getElementById('createPrelevement').value,caution:chqVal?'OUI':'NON',chq:chqVal,banque:document.getElementById('createBanque').value.trim(),notes:document.getElementById('createNotes').value.trim(),echeancesRaw:raw,echeancesJson:parsed.echeances.map(e=>({date:e.date.toISOString(),montant:e.montant,type:e.type,paid:e.paid,label:e.label||''})),paid:parsed.paid,total:parsed.total,badges:parsed.badges||[],chqMontant:0,dateInscription:new Date().toLocaleDateString('fr-FR')};
    apiPost('saveStudent',{student:s},d=>{if(d.success){loadStudents();closeModal('createModal');showToast('‚úÖ √âtudiant cr√©√©');}else{showToast('‚ùå Erreur cr√©ation: '+(d.error||'√©chec serveur'),true);}});
}

// IMPORT
function openImportModal(){
    if(!currentUser||currentUser.role!=='admin'){showToast('R√©serv√© aux administrateurs',true);return;}
    document.getElementById('importBody').innerHTML=`<p style="margin-bottom:12px;color:var(--text2);font-size:0.85em;">Collez vos donn√©es (TSV/CSV) ou choisissez un fichier. Colonnes auto-d√©tect√©es: NOM, PR2NOM/PRENOM, FORMATION, RYTHME, TELEPHONE, NVX/REINS, PRELEVEMENT, CAUTION, BANQUE, ECHEANCES, TEL TUTEUR, DATE.</p>
    <div class="form-group"><textarea id="importText" rows="8" placeholder="Collez ici votre tableau (copi√© depuis Excel/Sheets)..."></textarea></div>
    <div style="display:flex;gap:8px;align-items:center;"><input type="file" id="importFile" accept=".csv,.tsv,.txt" onchange="loadImportFile(this)" style="display:none;"><label for="importFile" class="btn btn-outline" style="cursor:pointer;">üìÅ Choisir un fichier</label><span id="importFileName" style="color:var(--text2);font-size:0.82em;"></span><button class="btn btn-primary" onclick="previewImport()">Pr√©visualiser</button></div>
    <div id="importPreview"></div>`;
    document.getElementById('importModal').classList.add('active');
}
function loadImportFile(input){const f=input.files[0];if(!f)return;document.getElementById('importFileName').textContent=f.name;const r=new FileReader();r.onload=e=>{document.getElementById('importText').value=e.target.result;};r.readAsText(f,'UTF-8');}
function normalizePhone(p){if(!p)return '';let s=p.replace(/[^\d+]/g,'');if(s.startsWith('33')&&s.length>=11)s='0'+s.slice(2);else if(s.startsWith('+33'))s='0'+s.slice(3);if(s.length===9&&!s.startsWith('0'))s='0'+s;if(s.length===10)s=s.replace(/(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/,'$1 $2 $3 $4 $5');return s;}
function normalizeHeader(h){return h.toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/[^A-Z0-9]/g,'');}

function parseCSVLine(line,sep){
    const fields=[];let field='',inQuotes=false;
    for(let i=0;i<line.length;i++){
        const c=line[i];
        if(inQuotes){
            if(c==='"'){if(i+1<line.length&&line[i+1]==='"'){field+='"';i++;}else inQuotes=false;}
            else field+=c;
        }else{
            if(c==='"')inQuotes=true;
            else if(c===sep){fields.push(field.trim());field='';}
            else field+=c;
        }
    }
    fields.push(field.trim());
    return fields;
}
function previewImport(){
    const text=document.getElementById('importText').value.trim();if(!text)return;
    const rawLines=text.split(/\r?\n/);const firstLine=rawLines[0];let sep='\t';
    if(firstLine.split('\t').length<3){
        // Count separators outside quotes
        let sc=0,cc=0,inQ=false;
        for(const ch of firstLine){if(ch==='"')inQ=!inQ;else if(!inQ){if(ch===';')sc++;if(ch===',')cc++;}}
        sep=sc>cc?';':',';
    }
    const lines=rawLines.map(l=>parseCSVLine(l,sep));if(lines.length<2)return;
    const headers=lines[0].map(normalizeHeader);let rows=lines.slice(1).filter(r=>r.some(c=>c));
    const colMap={};
    headers.forEach((h,i)=>{
        if(/^(NOM|NAME)$/.test(h))colMap.nom=i;
        else if(/^(PR2?E?NOM|PRENOM|FIRSTNAME)$/.test(h))colMap.prenom=i;
        else if(/^(FORMATION|FILIERE)$/.test(h))colMap.formation=i;
        else if(/^(RYTHME)$/.test(h))colMap.rythme=i;
        else if(/^(TELEPHONE|TEL|PHONE)$/.test(h))colMap.telephone=i;
        else if(/^(BANQUE|BANK)$/.test(h))colMap.banque=i;
        else if(/^(ECHEANCES|ECHEANCIER)$/.test(h))colMap.echeances=i;
        else if(/^(NVXREINS|NVXREINS)$/.test(h)||h==='NVXREINS')colMap.nvxReins=i;
        else if(/^(PRELEVEMENT|PRELEV)$/.test(h))colMap.prelevement=i;
        else if(/^(CAUTION)$/.test(h))colMap.caution=i;
        else if(/^(DATE|DATEINSCRIPTION)$/.test(h))colMap.dateInscription=i;
        else if(/^(TELTUTEUR|TELEPHONETUTEUR)$/.test(h)||h.includes('TUTEUR'))colMap.telTuteur=i;
    });
    if(colMap.nom!==undefined)rows=rows.filter(r=>(r[colMap.nom]||'').trim()!=='');
    if(colMap.nom!==undefined)rows.sort((a,b)=>(a[colMap.nom]||'').localeCompare(b[colMap.nom]||'','fr',{sensitivity:'base'}));
    let preview=`<div class="import-preview"><p style="margin:8px 0;font-size:0.82em;color:var(--text2);">${rows.length} lignes (tri√©es A‚ÜíZ). Colonnes: ${Object.keys(colMap).join(', ')}</p><table><thead><tr>${headers.map(h=>`<th>${esc(h)}</th>`).join('')}</tr></thead><tbody>`;
    rows.slice(0,10).forEach(r=>{preview+=`<tr>${r.map(c=>`<td>${esc(c)}</td>`).join('')}</tr>`;});
    if(rows.length>10)preview+=`<tr><td colspan="${headers.length}" style="text-align:center;color:var(--text2);">... et ${rows.length-10} autres</td></tr>`;
    preview+=`</tbody></table></div><button class="btn btn-success" onclick="doImport()" style="margin-top:12px;">‚úÖ Importer ${rows.length} √©tudiants</button>`;
    document.getElementById('importPreview').innerHTML=preview;
    window._importData={rows,colMap};
}

function doImport(){
    const {rows,colMap}=window._importData||{};if(!rows)return;
    const imp=rows.map(r=>{
        const raw=colMap.echeances!==undefined?r[colMap.echeances]||'':'';
        const dateInsc=colMap.dateInscription!==undefined?(r[colMap.dateInscription]||'').trim():'';
        const parsed=raw?parseEcheances(raw, dateInsc):{echeances:[],paid:0,total:0,badges:[]};
        return {
            nom:colMap.nom!==undefined?(r[colMap.nom]||'').trim():'',
            prenom:colMap.prenom!==undefined?(r[colMap.prenom]||'').trim():'',
            formation:colMap.formation!==undefined?(r[colMap.formation]||'').trim():'',
            rythme:colMap.rythme!==undefined?(r[colMap.rythme]||'').trim():'',
            telephone:normalizePhone(colMap.telephone!==undefined?r[colMap.telephone]||'':''),
            banque:colMap.banque!==undefined?(r[colMap.banque]||'').trim():'',
            echeancesRaw:raw,
            echeancesJson:parsed.echeances.map(e=>({date:e.date.toISOString(),montant:e.montant,type:e.type,paid:e.paid,label:e.label||''})),
            paid:parsed.paid,total:parsed.total,badges:parsed.badges||[],
            nvxReins:colMap.nvxReins!==undefined?(r[colMap.nvxReins]||'').trim():'',
            prelevement:colMap.prelevement!==undefined?(r[colMap.prelevement]||'').trim():'',
            caution:colMap.caution!==undefined?(r[colMap.caution]||'').trim():'',
            chq:colMap.caution!==undefined&&/^oui/i.test((r[colMap.caution]||'').trim()),
            dateInscription:dateInsc,
            telTuteur:normalizePhone(colMap.telTuteur!==undefined?r[colMap.telTuteur]||'':'')
        };
    }).filter(s=>s.nom);
    imp.sort((a,b)=>(a.nom||'').localeCompare(b.nom||'','fr',{sensitivity:'base'}));
    createBackup('Avant import de '+imp.length+' √©tudiants');
    
    // Replace modal content with live progress UI
    const body=document.getElementById('importBody');
    body.innerHTML=`
        <div class="import-live">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px;">
                <div class="import-spinner"></div>
                <div style="flex:1;">
                    <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
                        <span id="importStatus" style="font-weight:600;">Import en cours...</span>
                        <span id="importCounter" style="color:var(--primary);font-weight:700;">0 / ${imp.length}</span>
                    </div>
                    <div style="height:8px;background:var(--surface2);border-radius:4px;overflow:hidden;">
                        <div id="importProgressBar" style="height:100%;width:0%;background:var(--primary);border-radius:4px;transition:width 0.15s;"></div>
                    </div>
                </div>
            </div>
            <div id="importErrors" style="display:none;margin-bottom:8px;padding:8px 12px;background:rgba(239,68,68,0.1);border:1px solid var(--danger);border-radius:6px;color:var(--danger);font-size:0.82em;"></div>
            <div style="display:flex;gap:16px;margin-bottom:8px;font-size:0.75em;color:var(--text2);">
                <span>üÜï Nouveau</span><span>üîÑ Modifi√©</span><span>‚è≠Ô∏è Inchang√© (ignor√©)</span><span>‚ùå Erreur</span>
            </div>
            <div class="import-live-table-wrap">
                <table class="import-live-table">
                    <thead><tr><th style="width:28px;">#</th><th>NOM</th><th>PR√âNOM</th><th>FORMATION</th><th>PAY√â</th><th>TOTAL</th><th>√âCH.</th><th style="width:40px;" title="üÜï Nouveau ¬∑ üîÑ Modifi√© ¬∑ ‚è≠Ô∏è Inchang√©">√âTAT</th></tr></thead>
                    <tbody id="importLiveRows"></tbody>
                </table>
            </div>
        </div>`;
    { const _p = document.getElementById('importPreview'); if (_p) _p.innerHTML=''; }
    // Local mode: batch with smart skip display
    if(!API_URL){
        let i=0,localSkipped=0;
        function animateLocal(){
            if(i<imp.length){
                const st=imp[i];
                const existing=students.find(x=>x.nom&&st.nom&&(x.nom||'').toUpperCase().trim()===(st.nom||'').toUpperCase().trim()&&(x.prenom||'').toUpperCase().trim()===(st.prenom||'').toUpperCase().trim());
                let mode='new';
                if(existing){
                    st.id=existing.id;
                    mode=studentChanged(existing,st)?'update':'skip';
                    if(mode==='skip')localSkipped++;
                }
                addImportRow(st,i+1,true,mode);
                updateImportProgress(i+1,imp.length,0,localSkipped);
                i++;
                requestAnimationFrame(animateLocal);
            } else {
                apiPost('importStudents',{students:imp},d=>{
                    if(d.success){loadStudents();finishImport(imp.length-localSkipped,0,localSkipped);}
                    else{showToast('Erreur import: '+(d.error||''),true);}
                });
            }
        }
        animateLocal();
        return;
    }
    
    // Server mode: save one by one with live display, skip unchanged
    let imported=0,errors=0,skipped=0;const queue=imp.slice();
    function importNext(){
        if(queue.length===0){
            loadStudents();
            finishImport(imported,errors,skipped);
            return;
        }
        const idx=imp.length-queue.length;
        const st=queue.shift();
        const existing=students.find(x=>x.nom&&st.nom&&(x.nom||'').toUpperCase().trim()===(st.nom||'').toUpperCase().trim()&&(x.prenom||'').toUpperCase().trim()===(st.prenom||'').toUpperCase().trim());
        if(existing){
            st.id=existing.id;
            // Check if data actually changed
            if(!studentChanged(existing,st)){
                skipped++;
                addImportRow(st,idx+1,true,'skip');
                updateImportProgress(idx+1,imp.length,errors,skipped);
                setTimeout(importNext,0);
                return;
            }
        }
        apiPost('saveStudent',{student:st},d=>{
            const ok=d&&d.success;
            if(ok)imported++;else errors++;
            addImportRow(st,idx+1,ok,existing?'update':'new');
            updateImportProgress(idx+1,imp.length,errors,skipped);
            importNext();
        });
    }
    importNext();
}

function studentChanged(existing, incoming){
    // Compare key fields to detect if data actually changed
    const fields=['formation','rythme','telephone','banque','echeancesRaw','nvxReins','prelevement','caution','telTuteur','dateInscription'];
    for(const f of fields){
        const a=(existing[f]||'').toString().trim();
        const b=(incoming[f]||'').toString().trim();
        if(a!==b)return true;
    }
    // Compare totals (covers echeances changes)
    if(Math.abs((existing.total||0)-(incoming.total||0))>0.01)return true;
    if(Math.abs((existing.paid||0)-(incoming.paid||0))>0.01)return true;
    return false;
}

function addImportRow(s,num,ok,mode){
    const tbody=document.getElementById('importLiveRows');if(!tbody)return;
    const echCount=(s.echeancesJson||[]).length;
    const paidStr=s.paid?s.paid.toLocaleString('fr',{maximumFractionDigits:0})+'‚Ç¨':'‚Äî';
    const totalStr=s.total?s.total.toLocaleString('fr',{maximumFractionDigits:0})+'‚Ç¨':'‚Äî';
    const tr=document.createElement('tr');
    tr.className='import-row-enter';
    const modeIcon=mode==='skip'?'‚è≠Ô∏è':mode==='update'?'üîÑ':mode==='new'?'üÜï':'‚úÖ';
    const modeStyle=mode==='skip'?'opacity:0.5;':'';
    tr.style.cssText=modeStyle;
    tr.innerHTML=`<td style="color:var(--text2);font-size:0.78em;">${num}</td><td style="font-weight:600;">${esc(s.nom||'')}</td><td>${esc(s.prenom||'')}</td><td><span style="font-size:0.82em;color:var(--text2);">${esc(s.formation||'')}</span></td><td style="color:var(--ok);font-weight:500;">${paidStr}</td><td style="font-weight:500;">${totalStr}</td><td style="text-align:center;font-size:0.82em;">${echCount||'‚Äî'}</td><td style="text-align:center;">${ok?modeIcon:'‚ùå'}</td>`;
    tbody.appendChild(tr);
    // Auto-scroll to bottom
    const wrap=tbody.closest('.import-live-table-wrap');
    if(wrap)wrap.scrollTop=wrap.scrollHeight;
}

function updateImportProgress(current,total,errors,skipped){
    const pct=Math.round(current/total*100);
    const bar=document.getElementById('importProgressBar');if(bar)bar.style.width=pct+'%';
    const counter=document.getElementById('importCounter');
    if(counter){
        let txt=current+' / '+total;
        if(skipped>0)txt+=' ('+skipped+' ‚è≠Ô∏è)';
        counter.textContent=txt;
    }
    const errDiv=document.getElementById('importErrors');
    if(errDiv&&errors>0){errDiv.style.display='block';errDiv.textContent='‚ö†Ô∏è '+errors+' erreur'+(errors>1?'s':'');}
}

function finishImport(imported,errors,skipped){
    const status=document.getElementById('importStatus');
    const spinner=document.querySelector('.import-spinner');
    if(spinner)spinner.style.display='none';
    if(status){
        let msg='';
        if(skipped>0&&imported===0)msg=`‚úÖ Aucun changement d√©tect√© ‚Äî ${skipped} √©tudiants identiques`;
        else{
            const parts=[];
            if(imported>0)parts.push(imported+' import√©'+(imported>1?'s':''));
            if(skipped>0)parts.push(skipped+' inchang√©'+(skipped>1?'s':''));
            if(errors>0)parts.push(errors+' erreur'+(errors>1?'s':''));
            msg=(errors>0?'‚ö†Ô∏è ':'‚úÖ ')+parts.join(', ');
        }
        status.textContent=msg;
        status.style.color=errors>0?'var(--warn)':'var(--ok)';
    }
    const bar=document.getElementById('importProgressBar');
    if(bar)bar.style.background=errors>0?'var(--warn)':'var(--ok)';
    // Add close button
    const wrap=document.querySelector('.import-live');
    if(wrap){
        const btn=document.createElement('button');
        btn.className='btn btn-primary';btn.style.marginTop='12px';btn.textContent='Fermer';
        btn.onclick=()=>closeModal('importModal');
        wrap.appendChild(btn);
    }
    renderDashboard();
}

// EXPORT
function exportCSV(){
    if(!currentUser||currentUser.role!=='admin'){showToast('R√©serv√© aux administrateurs',true);return;}
    const BOM='\uFEFF',sep=';';
    const hdr=['Nom','Pr√©nom','Formation','Rythme','T√©l√©phone','T√©l Tuteur','Nvx/R√©ins','Pr√©l√®vement','Caution','Montant Caution','Banque','Statut','Pay√©','Total','Restant','Notes','√âch√©ances','Date inscription','Cr√©√© par','Date cr√©ation','Modifi√© par','Date modification'];
    const rows=students.map(s=>{const st=computeStatus(s);const sl=st==='ok'?'√Ä jour':st==='late'?'En retard':'En attente';return [s.nom,s.prenom,s.formation,s.rythme,s.telephone,s.telTuteur,s.nvxReins,s.prelevement,s.chq?'Oui':'Non',s.chqMontant||'',s.banque,sl,s.paid,s.total,(s.total||0)-(s.paid||0),s.notes,s.echeancesRaw,s.dateInscription,s.creePar,s.creeDate,s.modifiePar,s.modifieDate].map(v=>`"${String(v||'').replace(/"/g,'""')}"`);});
    const csv=BOM+[hdr.join(sep),...rows.map(r=>r.join(sep))].join('\n');
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`effectifs-${new Date().toISOString().slice(0,10)}.csv`;a.click();
}

// HISTORY
function openHistoryModal(){
    apiGet('getHistory',d=>{
        const hist=(d.history||[]).reverse().slice(0,100);
        let h=hist.length===0?'<p style="color:var(--text2);">Aucun historique</p>':'<table style="width:100%;font-size:0.85em;border-collapse:collapse;"><thead><tr><th style="text-align:left;padding:6px;">Date</th><th style="text-align:left;padding:6px;">Utilisateur</th><th style="text-align:left;padding:6px;">Action</th><th style="text-align:left;padding:6px;">√âtudiant</th></tr></thead><tbody>';
        if(hist.length>0){hist.forEach(x=>{h+=`<tr><td style="padding:6px;border-top:1px solid var(--border);">${fmtDate(x.date)}</td><td style="padding:6px;border-top:1px solid var(--border);">${esc(x.user)}</td><td style="padding:6px;border-top:1px solid var(--border);">${esc(x.action)}</td><td style="padding:6px;border-top:1px solid var(--border);">${esc(x.nom)}</td></tr>`;});h+='</tbody></table>';}
        document.getElementById('historyBody').innerHTML=h;document.getElementById('historyModal').classList.add('active');
    });
}

// BACKUP & RESTORE
const MAX_BACKUPS = 5;
function getBackups(){
    try{return JSON.parse(localStorage.getItem('backups')||'[]');}catch(e){return [];}
}
function createBackup(reason){
    const backups=getBackups();
    const backup={
        date: new Date().toISOString(),
        user: (currentUser&&currentUser.name)||'?',
        reason: reason||'Sauvegarde manuelle',
        count: students.length,
        data: JSON.parse(JSON.stringify(students))
    };
    backups.unshift(backup);
    while(backups.length>MAX_BACKUPS) backups.pop();
    localStorage.setItem('backups',JSON.stringify(backups));
}
function autoBackupIfNeeded(){
    if(students.length===0)return;
    const backups=getBackups();
    const now=Date.now();
    // Auto-backup max once per hour
    if(backups.length>0){
        const lastDate=new Date(backups[0].date).getTime();
        if(now-lastDate<3600000)return;
    }
    createBackup('Sauvegarde automatique');
}
function manualBackup(){
    if(students.length===0){showToast('Aucune donn√©e √† sauvegarder',true);return;}
    createBackup('Sauvegarde manuelle');
    showToast('‚úÖ Sauvegarde cr√©√©e ('+students.length+' fiches)');
    openRestoreModal();
}
function openRestoreModal(){
    if(!currentUser||currentUser.role!=='admin'){showToast('R√©serv√© aux administrateurs',true);return;}
    const backups=getBackups();
    let h='<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;"><p style="color:var(--text2);font-size:0.85em;">Les sauvegardes sont cr√©√©es automatiquement toutes les heures et avant chaque op√©ration critique.</p><button class="btn btn-primary btn-sm" onclick="manualBackup()">üíæ Sauvegarder maintenant</button></div>';
    if(backups.length===0){
        h+='<p style="color:var(--text2);text-align:center;padding:20px;">Aucune sauvegarde disponible.</p>';
    } else {
        h='<p style="color:var(--text2);font-size:0.85em;margin-bottom:16px;">S√©lectionnez une sauvegarde √† restaurer. Les donn√©es actuelles seront remplac√©es.</p>';
        h+='<table style="width:100%;font-size:0.85em;border-collapse:collapse;">';
        h+='<thead><tr><th style="text-align:left;padding:8px;">Date</th><th style="text-align:left;padding:8px;">Par</th><th style="text-align:left;padding:8px;">Raison</th><th style="text-align:left;padding:8px;">Fiches</th><th style="padding:8px;"></th></tr></thead><tbody>';
        backups.forEach(function(b,i){
            var d='';
            try{d=new Date(b.date).toLocaleDateString('fr-FR',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});}catch(e){d=b.date;}
            h+='<tr style="border-top:1px solid var(--border);">';
            h+='<td style="padding:8px;">'+esc(d)+'</td>';
            h+='<td style="padding:8px;">'+esc(b.user)+'</td>';
            h+='<td style="padding:8px;">'+esc(b.reason)+'</td>';
            h+='<td style="padding:8px;font-weight:700;">'+b.count+'</td>';
            h+='<td style="padding:8px;"><button class="btn btn-primary btn-sm" onclick="restoreBackup('+i+')">Restaurer</button></td>';
            h+='</tr>';
        });
        h+='</tbody></table>';
    }
    document.getElementById('restoreBody').innerHTML=h;
    document.getElementById('restoreModal').classList.add('active');
}
function restoreBackup(index){
    if(!currentUser||currentUser.role!=='admin'){showToast('R√©serv√© aux administrateurs',true);return;}
    const backups=getBackups();
    if(!backups[index]){showToast('Sauvegarde introuvable',true);return;}
    var b=backups[index];
    var d='';
    try{d=new Date(b.date).toLocaleDateString('fr-FR',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});}catch(e){d=b.date;}
    if(!confirm('Restaurer la sauvegarde du '+d+' ('+b.count+' fiches) ?\n\nLes donn√©es actuelles seront remplac√©es.'))return;
    // Backup current state before restore
    createBackup('Avant restauration du '+d);
    var restoredStudents=b.data;
    if(!API_URL){
        localStorage.setItem('students',JSON.stringify(restoredStudents));
        students=restoredStudents;
        renderDashboard();renderStudents();renderStats();
        closeModal('restoreModal');
        showToast('‚úÖ '+restoredStudents.length+' fiches restaur√©es');
        return;
    }
    // Server mode: delete all then re-import one by one via apiPost
    var ids=students.map(function(s){return String(s.id);});
    function deleteNextForRestore(){
        if(ids.length===0){
            // Then save restored data one by one
            var queue=restoredStudents.slice();
            var restored=0;
            function saveNextForRestore(){
                if(queue.length===0){
                    loadStudents();
                    closeModal('restoreModal');
                    showToast(restored+' fiches restaur√©es');
                    return;
                }
                var st=queue.shift();
                delete st.id;
                apiPost('saveStudent',{student:st},function(d2){
                    if(d2&&d2.success) restored++;
                    saveNextForRestore();
                });
            }
            saveNextForRestore();
            return;
        }
        var id=ids.shift();
        apiPost('deleteStudent',{id:id},function(){
            deleteNextForRestore();
        });
    }
    deleteNextForRestore();
}

// STATS
function renderStats(){
    const total=students.length;const okC=students.filter(s=>computeStatus(s)==='ok').length;const pendC=students.filter(s=>computeStatus(s)==='pending').length;const lateC=students.filter(s=>computeStatus(s)==='late').length;
    const tPaid=students.reduce((a,s)=>a+(s.paid||0),0);const tDue=students.reduce((a,s)=>a+(s.total||0),0);const tRem=tDue-tPaid;
    let h=`<div class="stats-row"><div class="stat-card info" onclick="applyFilter('','','')"><div class="number">${total}</div><div class="label">Total √©tudiants</div></div><div class="stat-card ok" onclick="applyFilter('status','ok','‚úÖ √Ä jour')"><div class="number">${okC}</div><div class="label">‚úÖ √Ä jour</div></div><div class="stat-card warn" onclick="applyFilter('status','pending','‚è≥ En attente')"><div class="number">${pendC}</div><div class="label">‚è≥ En attente</div></div><div class="stat-card danger" onclick="applyFilter('status','late','‚ö†Ô∏è En retard')"><div class="number">${lateC}</div><div class="label">‚ö†Ô∏è En retard</div></div></div>
    <div class="finance-row"><div class="finance-card"><div class="label">üí∞ Total encaiss√©</div><div class="amount" style="color:var(--ok);">${tPaid.toLocaleString('fr')}‚Ç¨</div></div><div class="finance-card"><div class="label">‚è≥ Restant √† percevoir</div><div class="amount" style="color:var(--warn);">${tRem.toLocaleString('fr')}‚Ç¨</div></div><div class="finance-card"><div class="label">üìä Total d√ª</div><div class="amount">${tDue.toLocaleString('fr')}‚Ç¨</div></div></div>`;
    h+=buildStatsTable('Par formation',groupBy('formation'),'formation');
    h+=buildStatsTable('Par rythme',groupBy('rythme'),'rythme');
    h+=buildStatsTable('Nouveau / R√©inscription',groupBy('nvxReins'),'nvxReins');
    // Status
    const sg={};students.forEach(s=>{const st=computeStatus(s);const l=st==='ok'?'‚úÖ √Ä jour':st==='late'?'‚ö†Ô∏è En retard':'‚è≥ En attente';if(!sg[l])sg[l]={count:0,paid:0,total:0};sg[l].count++;sg[l].paid+=(s.paid||0);sg[l].total+=(s.total||0);});
    h+=`<h3 style="margin:16px 0 8px;">Par statut</h3><table class="stats-table"><thead><tr><th>Statut</th><th>√âtudiants</th><th>Encaiss√©</th><th>Total</th><th>Progression</th></tr></thead><tbody>`;
    Object.entries(sg).forEach(([l,g])=>{const p=g.total>0?Math.round(g.paid/g.total*100):0;h+=`<tr><td>${l}</td><td>${g.count}</td><td>${g.paid.toLocaleString('fr')}‚Ç¨</td><td>${g.total.toLocaleString('fr')}‚Ç¨</td><td><div class="mini-bar"><div class="mini-bar-fill" style="width:${p}%;"></div></div> ${p}%</td></tr>`;});
    h+=`</tbody></table>`;
    document.getElementById('statsContent').innerHTML=h;
}
function groupBy(field){const g={};students.forEach(s=>{const k=s[field]||'(non renseign√©)';if(!g[k])g[k]={count:0,paid:0,total:0};g[k].count++;g[k].paid+=(s.paid||0);g[k].total+=(s.total||0);});return g;}
function buildStatsTable(title,groups,filterField){
    let h=`<h3 style="margin:16px 0 8px;">${title}</h3><table class="stats-table"><thead><tr><th>${title}</th><th>√âtudiants</th><th>Encaiss√©</th><th>Total</th><th>Progression</th></tr></thead><tbody>`;
    Object.entries(groups).sort((a,b)=>b[1].count-a[1].count).forEach(([k,g])=>{const p=g.total>0?Math.round(g.paid/g.total*100):0;h+=`<tr onclick="applyFilter('${filterField}','${esc(k).replace(/'/g,"\\'")}','${esc(k).replace(/'/g,"\\'")}')"><td>${esc(k)}</td><td>${g.count}</td><td>${g.paid.toLocaleString('fr')}‚Ç¨</td><td>${g.total.toLocaleString('fr')}‚Ç¨</td><td><div class="mini-bar"><div class="mini-bar-fill" style="width:${p}%;"></div></div> ${p}%</td></tr>`;});
    h+=`</tbody></table>`;return h;
}
function applyFilter(field,value,label){
    clearAllFilters();
    if(field==='status')document.getElementById('filterStatus').value=value;
    else if(field==='formation')document.getElementById('filterFormation').value=value;
    else if(field==='rythme')document.getElementById('filterRythme').value=value;
    else if(field&&value)document.getElementById('searchBox').value=value;
    if(label){document.getElementById('filterBanner').style.display='flex';document.getElementById('filterBannerText').textContent='üîç Filtre: '+label;}
    switchTab('home');filterStudents();
}
function clearAllFilters(){document.getElementById('searchBox').value='';document.getElementById('filterFormation').value='';document.getElementById('filterStatus').value='';document.getElementById('filterRythme').value='';document.getElementById('filterLate').value='';document.getElementById('filterBanner').style.display='none';document.getElementById('dashboard').style.display='';filterStudents();}

// TABS & UTIL
function switchTab(tab){document.querySelectorAll('.tab-btn').forEach((b,i)=>b.classList.toggle('active',i===(tab==='home'?0:1)));document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));document.getElementById('tab-'+tab).classList.add('active');if(tab==='stats')renderStats();}
function closeModal(id){document.getElementById(id).classList.remove('active');}
function fmtDate(d){if(!d)return '';try{return new Date(d).toLocaleDateString('fr-FR',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});}catch(e){return d;}}
document.querySelectorAll('.modal-overlay').forEach(m=>{m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('active');});});
</script>
</body>
</html>
