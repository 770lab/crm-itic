<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestion Effectifs 2024-25</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:system-ui,-apple-system,sans-serif;background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%);min-height:100vh;color:#fff}
.app{max-width:1400px;margin:0 auto;padding:20px}
.header{display:flex;justify-content:space-between;align-items:center;padding:20px;background:rgba(255,255,255,0.05);border-radius:16px;margin-bottom:24px;backdrop-filter:blur(10px)}
.logo{display:flex;align-items:center;gap:12px}
.logo span{font-size:32px}
.logo h1{font-size:22px;font-weight:600}
.btn{padding:12px 24px;border:none;border-radius:12px;font-size:14px;font-weight:600;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;gap:8px}
.btn-primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(102,126,234,0.4)}
.btn-secondary{background:rgba(255,255,255,0.1);color:#fff}
.btn-secondary:hover{background:rgba(255,255,255,0.15)}
.btn-danger{background:rgba(255,71,87,0.2);color:#ff4757}
.btn-danger:hover{background:rgba(255,71,87,0.3)}
.btn-sm{padding:6px 12px;font-size:12px;border-radius:8px}
.dashboard{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;margin-bottom:24px}
.stat-card{background:rgba(255,255,255,0.05);border-radius:16px;padding:24px;display:flex;align-items:center;gap:16px;border:1px solid rgba(255,255,255,0.1);transition:all 0.3s}
.stat-card:hover{transform:translateY(-4px);border-color:rgba(255,255,255,0.2)}
.stat-icon{width:56px;height:56px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px}
.stat-icon.blue{background:rgba(102,126,234,0.2)}
.stat-icon.green{background:rgba(46,213,115,0.2)}
.stat-icon.orange{background:rgba(255,159,67,0.2)}
.stat-icon.red{background:rgba(255,71,87,0.2)}
.stat-value{font-size:28px;font-weight:700;display:block}
.stat-label{font-size:14px;color:rgba(255,255,255,0.6)}
.filters{display:flex;gap:16px;margin-bottom:24px;flex-wrap:wrap;align-items:center}
.search-box{flex:1;min-width:250px;display:flex;align-items:center;background:rgba(255,255,255,0.05);border-radius:12px;padding:0 16px;border:1px solid rgba(255,255,255,0.1)}
.search-box input{flex:1;background:none;border:none;padding:14px;color:#fff;font-size:14px;outline:none}
.search-box input::placeholder{color:rgba(255,255,255,0.4)}
.filters select{padding:14px 20px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:12px;color:#fff;font-size:14px;cursor:pointer}
.filters select option{background:#1a1a2e}
.students-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:20px}
.student-card{background:rgba(255,255,255,0.05);border-radius:16px;padding:24px;border:1px solid rgba(255,255,255,0.1);transition:all 0.3s;cursor:pointer}
.student-card:hover{transform:translateY(-5px);border-color:rgba(102,126,234,0.5);box-shadow:0 20px 40px rgba(0,0,0,0.3)}
.student-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px}
.student-name{font-size:18px;font-weight:600;margin-bottom:6px}
.student-formation{font-size:12px;color:rgba(255,255,255,0.7);background:rgba(102,126,234,0.2);padding:4px 10px;border-radius:20px;display:inline-block}
.status-badge{padding:6px 12px;border-radius:20px;font-size:11px;font-weight:600}
.status-badge.ok{background:rgba(46,213,115,0.2);color:#2ed573}
.status-badge.pending{background:rgba(255,159,67,0.2);color:#ff9f43}
.status-badge.late{background:rgba(255,71,87,0.2);color:#ff4757}
.student-details{margin-bottom:16px}
.detail-row{display:flex;align-items:center;gap:8px;font-size:14px;color:rgba(255,255,255,0.7);margin-bottom:8px}
.payment-progress{background:rgba(255,255,255,0.1);height:8px;border-radius:4px;overflow:hidden}
.payment-bar{height:100%;border-radius:4px;transition:width 0.5s}
.payment-bar.ok{background:linear-gradient(90deg,#2ed573,#7bed9f)}
.payment-bar.pending{background:linear-gradient(90deg,#ff9f43,#ffc048)}
.payment-bar.late{background:linear-gradient(90deg,#ff4757,#ff6b81)}
.payment-info{display:flex;justify-content:space-between;margin-top:10px;font-size:13px;color:rgba(255,255,255,0.6)}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:none;justify-content:center;align-items:center;z-index:1000;backdrop-filter:blur(5px)}
.modal-overlay.active{display:flex}
.modal{background:linear-gradient(135deg,#1a1a2e,#16213e);border-radius:20px;width:90%;max-width:600px;max-height:90vh;overflow-y:auto;border:1px solid rgba(255,255,255,0.1)}
.modal-header{display:flex;justify-content:space-between;align-items:center;padding:24px;border-bottom:1px solid rgba(255,255,255,0.1)}
.modal-header h2{font-size:20px;font-weight:600}
.close-btn{width:36px;height:36px;border:none;background:rgba(255,255,255,0.1);color:#fff;border-radius:50%;font-size:24px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.close-btn:hover{background:rgba(255,255,255,0.2)}
.modal-body{padding:24px}
.form-group{margin-bottom:20px}
.form-group label{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;font-size:14px;font-weight:500}
.hint{font-size:12px;color:#667eea;font-weight:400}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:14px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:12px;color:#fff;font-size:14px;outline:none;transition:border-color 0.3s}
.form-group input:focus,.form-group textarea:focus{border-color:#667eea}
.form-group textarea{min-height:100px;resize:vertical;font-family:inherit}
.payment-preview{background:rgba(102,126,234,0.1);border-radius:12px;border:1px solid rgba(102,126,234,0.3);overflow:hidden;margin-top:10px}
.preview-header{display:flex;justify-content:space-between;padding:14px 16px;background:rgba(102,126,234,0.2);font-size:14px;font-weight:500}
#previewTotal{color:#2ed573;font-weight:600}
#previewTimeline{padding:16px;max-height:220px;overflow-y:auto}
.empty{color:rgba(255,255,255,0.4);font-style:italic;text-align:center;padding:20px 0}
.timeline-item{display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid rgba(255,255,255,0.05)}
.timeline-item:last-child{border-bottom:none}
.timeline-dot{width:10px;height:10px;border-radius:50%;background:#667eea;flex-shrink:0}
.timeline-dot.paid{background:#2ed573}
.timeline-date{font-size:13px;color:rgba(255,255,255,0.6);min-width:100px}
.timeline-amount{font-weight:600;color:#2ed573;min-width:70px}
.timeline-type{font-size:12px;color:rgba(255,255,255,0.4);flex:1}
.modal-footer{padding:24px;border-top:1px solid rgba(255,255,255,0.1);display:flex;justify-content:flex-end;gap:12px}
.detail-modal .modal{max-width:650px}
.student-profile{text-align:center;padding-bottom:20px;border-bottom:1px solid rgba(255,255,255,0.1);margin-bottom:20px}
.student-avatar{width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);display:flex;align-items:center;justify-content:center;font-size:32px;margin:0 auto 16px;font-weight:700}
.student-profile h3{font-size:24px;font-weight:600;margin-bottom:8px}
.student-profile .student-formation{font-size:14px;padding:6px 16px}
.info-section{margin-bottom:24px}
.info-section h4{font-size:14px;color:rgba(255,255,255,0.5);text-transform:uppercase;letter-spacing:1px;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.info-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.info-item{background:rgba(255,255,255,0.03);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.05)}
.info-item.full{grid-column:1/-1}
.info-label{font-size:12px;color:rgba(255,255,255,0.5);margin-bottom:6px}
.info-value{font-size:15px;font-weight:500}
.info-value a{color:#667eea;text-decoration:none}
.info-value a:hover{text-decoration:underline}
.payment-detail{margin-top:8px}
.payment-detail .payment-progress{height:12px;margin-bottom:12px}
.payment-stats{display:flex;justify-content:space-between;font-size:14px}
.payment-stats .paid{color:#2ed573}
.payment-stats .remaining{color:#ff9f43}
.status-section{display:flex;align-items:center;justify-content:center;gap:12px;padding:16px;background:rgba(255,255,255,0.03);border-radius:12px;margin-bottom:20px}
.status-section .status-badge{font-size:14px;padding:8px 20px}
.notes-section textarea{width:100%;min-height:80px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:12px;color:#fff;padding:14px;font-size:14px;resize:vertical;font-family:inherit}
.notes-section textarea:focus{outline:none;border-color:#667eea}
.edit-input{width:100%;padding:12px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:10px;color:#fff;font-size:14px;margin-top:6px;transition:all 0.3s}
.edit-input:focus{outline:none;border-color:#667eea;background:rgba(255,255,255,0.12)}
.echeances-list{background:rgba(255,255,255,0.03);border-radius:12px;border:1px solid rgba(255,255,255,0.05);max-height:300px;overflow-y:auto}
.echeance-item{display:flex;align-items:center;gap:12px;padding:12px 16px;border-bottom:1px solid rgba(255,255,255,0.05);transition:background 0.2s}
.echeance-item:last-child{border-bottom:none}
.echeance-item:hover{background:rgba(255,255,255,0.03)}
.echeance-item.is-paid{opacity:0.6}
.echeance-check{width:22px;height:22px;border-radius:6px;border:2px solid rgba(255,255,255,0.3);cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s;flex-shrink:0}
.echeance-check:hover{border-color:#667eea}
.echeance-check.checked{background:#2ed573;border-color:#2ed573}
.echeance-check.checked::after{content:"‚úì";color:#fff;font-size:14px;font-weight:bold}
.echeance-info{flex:1;display:flex;align-items:center;gap:10px}
.echeance-date{font-size:14px;font-weight:500}
.echeance-type{font-size:12px;color:rgba(255,255,255,0.5)}
.echeance-amount{font-size:16px;font-weight:600;color:#2ed573}
.echeance-amount.unpaid{color:#ff9f43}
.echeance-actions{display:flex;gap:6px}
.echeance-edit-btn,.echeance-delete-btn{width:28px;height:28px;border:none;border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;transition:all 0.2s}
.echeance-edit-btn{background:rgba(102,126,234,0.2);color:#667eea}
.echeance-edit-btn:hover{background:rgba(102,126,234,0.4)}
.echeance-delete-btn{background:rgba(255,71,87,0.2);color:#ff4757}
.echeance-delete-btn:hover{background:rgba(255,71,87,0.4)}
.echeance-edit-row{display:flex;gap:8px;align-items:center;flex:1}
.echeance-edit-row input{padding:8px 10px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:6px;color:#fff;font-size:13px;width:auto}
.echeance-edit-row input[type="date"]{width:140px}
.echeance-edit-row input[type="number"]{width:80px}
.echeance-edit-row select{padding:8px 10px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:6px;color:#fff;font-size:13px}
.echeance-save-btn,.echeance-cancel-btn{padding:6px 10px;border:none;border-radius:6px;cursor:pointer;font-size:12px;font-weight:500}
.echeance-save-btn{background:#2ed573;color:#fff}
.echeance-cancel-btn{background:rgba(255,255,255,0.1);color:#fff}
.add-echeance-btn{width:100%;padding:12px;margin-top:10px;background:rgba(102,126,234,0.1);border:2px dashed rgba(102,126,234,0.3);border-radius:10px;color:#667eea;font-size:14px;font-weight:500;cursor:pointer;transition:all 0.2s}
.add-echeance-btn:hover{background:rgba(102,126,234,0.2);border-color:rgba(102,126,234,0.5)}
.section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.section-header h4{margin-bottom:0}
@media(max-width:900px){.dashboard{grid-template-columns:repeat(2,1fr)}.info-grid{grid-template-columns:1fr}}
@media(max-width:600px){.dashboard{grid-template-columns:1fr}.header{flex-direction:column;gap:16px;text-align:center}.echeance-edit-row{flex-wrap:wrap}}
</style>
</head>
<body>
<div class="app">
<header class="header">
<div class="logo"><span>üéì</span><h1>Gestion Effectifs 2024-25</h1></div>
<button class="btn btn-primary" onclick="openModal()">+ Nouvel √©tudiant</button>
</header>
<div class="dashboard">
<div class="stat-card"><div class="stat-icon blue">üë•</div><div><span class="stat-value" id="totalCount">0</span><span class="stat-label">√âtudiants</span></div></div>
<div class="stat-card"><div class="stat-icon green">‚úÖ</div><div><span class="stat-value" id="okCount">0</span><span class="stat-label">√Ä jour</span></div></div>
<div class="stat-card"><div class="stat-icon orange">‚è≥</div><div><span class="stat-value" id="pendingCount">0</span><span class="stat-label">En attente</span></div></div>
<div class="stat-card"><div class="stat-icon red">‚ö†Ô∏è</div><div><span class="stat-value" id="lateCount">0</span><span class="stat-label">Retard</span></div></div>
</div>
<div class="filters">
<div class="search-box"><span>üîç</span><input type="text" id="searchInput" placeholder="Rechercher un √©tudiant..." oninput="filterStudents()"></div>
<select id="formationFilter" onchange="filterStudents()"><option value="">Toutes les formations</option><option value="M1 RH">M1 RH</option><option value="M1 INFO CS">M1 INFO CS</option><option value="M2 INFO BD">M2 INFO BD</option><option value="M2 MSC">M2 MSC</option><option value="BTS SIO 2 SLAM">BTS SIO 2 SLAM</option><option value="BTS SIO 2 SISR">BTS SIO 2 SISR</option><option value="BTS CG 2">BTS CG 2</option></select>
<select id="statusFilter" onchange="filterStudents()"><option value="">Tous les statuts</option><option value="ok">‚úÖ √Ä jour</option><option value="pending">‚è≥ En attente</option><option value="late">‚ö†Ô∏è En retard</option></select>
</div>
<div class="students-grid" id="studentsGrid"></div>
</div>
<div class="modal-overlay" id="modalOverlay" onclick="closeModal()">
<div class="modal" onclick="event.stopPropagation()">
<div class="modal-header"><h2>üìù Nouvel √©tudiant</h2><button class="close-btn" onclick="closeModal()">√ó</button></div>
<div class="modal-body">
<div class="form-group"><label>Nom complet</label><input type="text" id="studentName" placeholder="Ex: DUPONT Marie"></div>
<div class="form-group"><label>T√©l√©phone</label><input type="text" id="studentPhone" placeholder="Ex: 0612345678"></div>
<div class="form-group"><label>Formation</label><select id="studentFormation"><option value="M1 RH">M1 RH</option><option value="M1 INFO CS">M1 INFO CS</option><option value="M2 INFO BD">M2 INFO BD</option><option value="M2 MSC">M2 MSC</option><option value="BTS SIO 2 SLAM">BTS SIO 2 SLAM</option><option value="BTS SIO 2 SISR">BTS SIO 2 SISR</option><option value="BTS CG 2">BTS CG 2</option></select></div>
<div class="form-group"><label>Rythme</label><select id="studentRythme"><option value="IOA">IOA</option><option value="Initiale">Initiale</option><option value="Alternance">Alternance</option></select></div>
<div class="form-group"><label>Banque</label><input type="text" id="studentBank" placeholder="Ex: BNP, LCL, SG..."></div>
<div class="form-group"><label>√âch√©ances de paiement <span class="hint">Format intelligent</span></label><textarea id="paymentInput" placeholder="Ex: 760‚Ç¨ pvt le 20/08/2025 puis 260‚Ç¨ tous les 5 du mois jusqu'au 20/07/2026" oninput="parsePayment()"></textarea></div>
<div class="payment-preview"><div class="preview-header"><span>üìÖ Aper√ßu des √©ch√©ances</span><span id="previewTotal">Total: 0‚Ç¨</span></div><div id="previewTimeline"><p class="empty">Saisissez une formule ci-dessus pour voir l'aper√ßu...</p></div></div>
</div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal()">Annuler</button><button class="btn btn-primary" onclick="saveStudent()">üíæ Enregistrer</button></div>
</div>
</div>
<div class="modal-overlay detail-modal" id="detailModal" onclick="closeDetailModal()">
<div class="modal" onclick="event.stopPropagation()">
<div class="modal-header"><h2>üë§ Fiche √©tudiant</h2><button class="close-btn" onclick="closeDetailModal()">√ó</button></div>
<div class="modal-body" id="detailContent"></div>
<div class="modal-footer" id="detailFooter"><button class="btn btn-danger" onclick="deleteStudent()">üóëÔ∏è Supprimer</button><button class="btn btn-secondary" onclick="closeDetailModal()">Fermer</button><button class="btn btn-primary" onclick="editStudent()">‚úèÔ∏è Modifier</button></div>
</div>
</div>
<script>
let students=[
{id:1,name:"ESSAGA Flora",formation:"M1 RH",rythme:"IOA",phone:"0744139534",status:"ok",paid:2280,total:3690,bank:"BANQUE POSTALE",email:"",notes:"",echeances:[{date:"2024-09-01",amount:760,type:"Pr√©l√®vement",paid:true},{date:"2024-10-05",amount:380,type:"Mensualit√©",paid:true},{date:"2024-11-05",amount:380,type:"Mensualit√©",paid:true},{date:"2024-12-05",amount:380,type:"Mensualit√©",paid:true},{date:"2025-01-05",amount:380,type:"Mensualit√©",paid:true},{date:"2025-02-05",amount:380,type:"Mensualit√©",paid:false}]},
{id:2,name:"MOUNGUERI Rich",formation:"M1 INFO CS",rythme:"IOA",phone:"0758779884",status:"ok",paid:1507,total:3690,bank:"LCL",email:"",notes:"",echeances:[]},
{id:3,name:"ANANI Koffi",formation:"M1 INFO CS",rythme:"IOA",phone:"0759367370",status:"pending",paid:760,total:3690,bank:"",email:"",notes:"En attente de justificatif",echeances:[]},
{id:4,name:"SOGBOSSI Max",formation:"M1 INFO CS",rythme:"IOA",phone:"0743307010",status:"pending",paid:760,total:3690,bank:"",email:"",notes:"",echeances:[]},
{id:5,name:"TCHINDA Lo√Øc",formation:"M1 INFO CS",rythme:"IOA",phone:"0764844814",status:"ok",paid:1836,total:3690,bank:"",email:"",notes:"",echeances:[]},
{id:6,name:"SOUMAHORO Hafsoitou",formation:"M2 MSC",rythme:"IOA",phone:"0753594359",status:"ok",paid:2329,total:3690,bank:"BOURSOBANK",email:"",notes:"",echeances:[]},
{id:7,name:"TRAORE Diarah",formation:"BTS SIO 2 SLAM",rythme:"IOA",phone:"0753291991",status:"ok",paid:1083,total:3690,bank:"BQ POPULAIRE",email:"",notes:"",echeances:[]},
{id:8,name:"KAM KEFUYANTSAP Eve",formation:"BTS SIO 2 SISR",rythme:"Initiale",phone:"0613198352",status:"pending",paid:3000,total:4990,bank:"",email:"",notes:"Formation initiale",echeances:[]},
{id:9,name:"BOUDRAA Adam",formation:"BTS SIO 2 SISR",rythme:"Initiale",phone:"0769853540",status:"ok",paid:3990,total:4990,bank:"CIC",email:"",notes:"",echeances:[]},
{id:10,name:"KEITA Siriman",formation:"BTS CG 2",rythme:"Alternance",phone:"0621083426",status:"late",paid:323,total:3690,bank:"LCL",email:"",notes:"Relance effectu√©e le 15/01",echeances:[]},
{id:11,name:"LANGLOIS L√©o",formation:"M2 INFO BD",rythme:"IOA",phone:"0783389741",status:"ok",paid:1507,total:3690,bank:"SG",email:"",notes:"",echeances:[]},
{id:12,name:"FOMO Oc√©ane",formation:"BTS CG 2",rythme:"Alternance",phone:"0759575007",status:"ok",paid:1406,total:3690,bank:"SG",email:"",notes:"",echeances:[]}
];
let currentStudentId=null,tempPayments=[],editingEcheanceIndex=null;

function sortStudentsAlphabetically(){students.sort((a,b)=>a.name.localeCompare(b.name,'fr',{sensitivity:'base'}))}
function updateStats(){document.getElementById("totalCount").textContent=students.length;document.getElementById("okCount").textContent=students.filter(s=>s.status==="ok").length;document.getElementById("pendingCount").textContent=students.filter(s=>s.status==="pending").length;document.getElementById("lateCount").textContent=students.filter(s=>s.status==="late").length}
function renderStudents(data){data=data||students;data=[...data].sort((a,b)=>a.name.localeCompare(b.name,'fr',{sensitivity:'base'}));let html="";for(let i=0;i<data.length;i++){const s=data[i];const st=s.status==="ok"?"‚úÖ √Ä jour":s.status==="pending"?"‚è≥ En attente":"‚ö†Ô∏è Retard";const pct=Math.round(s.paid/s.total*100);html+='<div class="student-card" onclick="openDetailModal('+s.id+')"><div class="student-header"><div><div class="student-name">'+s.name+'</div><span class="student-formation">'+s.formation+'</span></div><span class="status-badge '+s.status+'">'+st+'</span></div><div class="student-details"><div class="detail-row">üìû '+s.phone+'</div><div class="detail-row">üìö '+s.rythme+'</div>'+(s.bank?'<div class="detail-row">üè¶ '+s.bank+'</div>':'')+'</div><div class="payment-progress"><div class="payment-bar '+s.status+'" style="width:'+pct+'%"></div></div><div class="payment-info"><span>'+s.paid+'‚Ç¨ pay√©s</span><span>'+s.total+'‚Ç¨ total</span></div></div>'}document.getElementById("studentsGrid").innerHTML=html}
function filterStudents(){const search=document.getElementById("searchInput").value.toLowerCase();const formation=document.getElementById("formationFilter").value;const status=document.getElementById("statusFilter").value;const filtered=students.filter(s=>{const matchSearch=s.name.toLowerCase().includes(search);const matchFormation=!formation||s.formation===formation;const matchStatus=!status||s.status===status;return matchSearch&&matchFormation&&matchStatus});renderStudents(filtered)}
function openModal(){document.getElementById("modalOverlay").classList.add("active");tempPayments=[]}
function closeModal(){document.getElementById("modalOverlay").classList.remove("active");document.getElementById("paymentInput").value="";document.getElementById("studentName").value="";document.getElementById("studentPhone").value="";document.getElementById("studentBank").value="";document.getElementById("previewTimeline").innerHTML='<p class="empty">Saisissez une formule ci-dessus...</p>';document.getElementById("previewTotal").textContent="Total: 0‚Ç¨";tempPayments=[]}

function recalculateStudentPayments(s){
    if(s.echeances&&s.echeances.length>0){
        s.paid=s.echeances.filter(e=>e.paid).reduce((sum,e)=>sum+e.amount,0);
        s.total=s.echeances.reduce((sum,e)=>sum+e.amount,0);
    }
    updateStudentStatus(s);
}

function openDetailModal(id){
    currentStudentId=id;
    editingEcheanceIndex=null;
    const s=students.find(st=>st.id===id);
    if(!s)return;
    const pct=s.total>0?Math.round(s.paid/s.total*100):0;
    const remaining=s.total-s.paid;
    const statusText=s.status==="ok"?"‚úÖ √Ä jour":s.status==="pending"?"‚è≥ En attente":"‚ö†Ô∏è En retard";
    const initials=s.name.split(' ').map(n=>n[0]).join('').substring(0,2);
    
    let echeancesHtml='';
    if(s.echeances&&s.echeances.length>0){
        echeancesHtml='<div class="echeances-list">';
        for(let i=0;i<s.echeances.length;i++){
            const e=s.echeances[i];
            const dateObj=new Date(e.date);
            const dateStr=dateObj.toLocaleDateString('fr-FR',{day:'numeric',month:'short',year:'numeric'});
            echeancesHtml+='<div class="echeance-item '+(e.paid?'is-paid':'')+'" id="echeance-'+i+'">';
            echeancesHtml+='<div class="echeance-check '+(e.paid?'checked':'')+'" onclick="toggleEcheance('+s.id+','+i+',event)"></div>';
            echeancesHtml+='<div class="echeance-info"><div class="echeance-date">'+dateStr+'</div><div class="echeance-type">'+e.type+'</div></div>';
            echeancesHtml+='<div class="echeance-amount '+(e.paid?'':'unpaid')+'">'+e.amount+'‚Ç¨</div>';
            echeancesHtml+='<div class="echeance-actions">';
            echeancesHtml+='<button class="echeance-edit-btn" onclick="startEditEcheance('+i+',event)" title="Modifier">‚úèÔ∏è</button>';
            echeancesHtml+='<button class="echeance-delete-btn" onclick="deleteEcheance('+i+',event)" title="Supprimer">üóëÔ∏è</button>';
            echeancesHtml+='</div></div>';
        }
        echeancesHtml+='</div>';
    }else{
        echeancesHtml='<p class="empty">Aucune √©ch√©ance d√©finie</p>';
    }
    echeancesHtml+='<button class="add-echeance-btn" onclick="addNewEcheance()">+ Ajouter une √©ch√©ance</button>';
    
    const html='<div class="student-profile"><div class="student-avatar">'+initials+'</div><h3>'+s.name+'</h3><span class="student-formation">'+s.formation+'</span></div><div class="status-section"><span>Statut:</span><span class="status-badge '+s.status+'">'+statusText+'</span></div><div class="info-section"><h4>üìã Informations</h4><div class="info-grid"><div class="info-item"><div class="info-label">T√©l√©phone</div><div class="info-value"><a href="tel:'+s.phone+'">'+s.phone+'</a></div></div><div class="info-item"><div class="info-label">Rythme</div><div class="info-value">'+s.rythme+'</div></div><div class="info-item"><div class="info-label">Banque</div><div class="info-value">'+(s.bank||'Non renseign√©e')+'</div></div><div class="info-item"><div class="info-label">Email</div><div class="info-value">'+(s.email||'Non renseign√©')+'</div></div></div></div><div class="info-section"><h4>üí≥ Situation financi√®re</h4><div class="info-grid"><div class="info-item full"><div class="payment-detail"><div class="payment-progress"><div class="payment-bar '+s.status+'" style="width:'+pct+'%"></div></div><div class="payment-stats"><span class="paid">'+s.paid+'‚Ç¨ pay√©s ('+pct+'%)</span><span class="remaining">'+remaining+'‚Ç¨ restant</span></div></div></div></div></div><div class="info-section"><div class="section-header"><h4>üìÖ √âch√©ances</h4></div>'+echeancesHtml+'</div><div class="info-section notes-section"><h4>üìù Notes</h4><textarea id="studentNotes" placeholder="Ajouter des notes...">'+(s.notes||'')+'</textarea></div>';
    
    document.getElementById("detailContent").innerHTML=html;
    document.getElementById("detailFooter").innerHTML='<button class="btn btn-danger" onclick="deleteStudent()">üóëÔ∏è Supprimer</button><button class="btn btn-secondary" onclick="closeDetailModal()">Fermer</button><button class="btn btn-primary" onclick="editStudent()">‚úèÔ∏è Modifier</button>';
    document.getElementById("detailModal").classList.add("active");
}

function startEditEcheance(index,event){
    event.stopPropagation();
    const s=students.find(st=>st.id===currentStudentId);
    if(!s||!s.echeances||!s.echeances[index])return;
    const e=s.echeances[index];
    const item=document.getElementById('echeance-'+index);
    if(!item)return;
    
    item.innerHTML=`
        <div class="echeance-check ${e.paid?'checked':''}" onclick="toggleEcheance(${s.id},${index},event)"></div>
        <div class="echeance-edit-row">
            <input type="date" id="editEcheanceDate-${index}" value="${e.date}">
            <input type="number" id="editEcheanceAmount-${index}" value="${e.amount}" min="0" style="width:80px">
            <select id="editEcheanceType-${index}">
                <option value="Paiement" ${e.type==='Paiement'?'selected':''}>Paiement</option>
                <option value="Pr√©l√®vement" ${e.type==='Pr√©l√®vement'?'selected':''}>Pr√©l√®vement</option>
                <option value="Mensualit√©" ${e.type==='Mensualit√©'?'selected':''}>Mensualit√©</option>
                <option value="Virement" ${e.type==='Virement'?'selected':''}>Virement</option>
                <option value="Ch√®que" ${e.type==='Ch√®que'?'selected':''}>Ch√®que</option>
                <option value="Esp√®ces" ${e.type==='Esp√®ces'?'selected':''}>Esp√®ces</option>
                <option value="Carte" ${e.type==='Carte'?'selected':''}>Carte</option>
            </select>
            <button class="echeance-save-btn" onclick="saveEcheanceEdit(${index},event)">‚úì</button>
            <button class="echeance-cancel-btn" onclick="openDetailModal(${currentStudentId})">‚úï</button>
        </div>
    `;
}

function saveEcheanceEdit(index,event){
    event.stopPropagation();
    const s=students.find(st=>st.id===currentStudentId);
    if(!s||!s.echeances||!s.echeances[index])return;
    
    const newDate=document.getElementById('editEcheanceDate-'+index).value;
    const newAmount=parseInt(document.getElementById('editEcheanceAmount-'+index).value)||0;
    const newType=document.getElementById('editEcheanceType-'+index).value;
    
    if(!newDate||newAmount<=0){
        alert('Veuillez remplir une date et un montant valide');
        return;
    }
    
    s.echeances[index].date=newDate;
    s.echeances[index].amount=newAmount;
    s.echeances[index].type=newType;
    
    // Trier les √©ch√©ances par date
    s.echeances.sort((a,b)=>new Date(a.date)-new Date(b.date));
    
    recalculateStudentPayments(s);
    updateStats();
    renderStudents();
    openDetailModal(currentStudentId);
}

function deleteEcheance(index,event){
    event.stopPropagation();
    const s=students.find(st=>st.id===currentStudentId);
    if(!s||!s.echeances)return;
    
    if(confirm('Supprimer cette √©ch√©ance ?')){
        s.echeances.splice(index,1);
        recalculateStudentPayments(s);
        updateStats();
        renderStudents();
        openDetailModal(currentStudentId);
    }
}

function addNewEcheance(){
    const s=students.find(st=>st.id===currentStudentId);
    if(!s)return;
    if(!s.echeances)s.echeances=[];
    
    // Date par d√©faut: aujourd'hui
    const today=new Date().toISOString().split('T')[0];
    s.echeances.push({
        date:today,
        amount:0,
        type:'Mensualit√©',
        paid:false
    });
    
    // Trier par date
    s.echeances.sort((a,b)=>new Date(a.date)-new Date(b.date));
    
    recalculateStudentPayments(s);
    openDetailModal(currentStudentId);
    
    // Trouver l'index de la nouvelle √©ch√©ance et l'√©diter
    const newIndex=s.echeances.findIndex(e=>e.amount===0);
    if(newIndex>=0){
        setTimeout(()=>startEditEcheance(newIndex,{stopPropagation:()=>{}}),100);
    }
}

function toggleEcheance(studentId,echeanceIndex,event){
    event.stopPropagation();
    const s=students.find(st=>st.id===studentId);
    if(!s||!s.echeances||!s.echeances[echeanceIndex])return;
    s.echeances[echeanceIndex].paid=!s.echeances[echeanceIndex].paid;
    recalculateStudentPayments(s);
    updateStats();
    renderStudents();
    openDetailModal(studentId);
}

function updateStudentStatus(s){
    if(!s.echeances||s.echeances.length===0)return;
    const now=new Date();
    const unpaidPastDue=s.echeances.some(e=>!e.paid&&new Date(e.date)<now);
    const allPaid=s.echeances.every(e=>e.paid);
    if(allPaid||s.paid>=s.total){s.status="ok"}
    else if(unpaidPastDue){
        const oldestUnpaid=s.echeances.filter(e=>!e.paid&&new Date(e.date)<now).sort((a,b)=>new Date(a.date)-new Date(b.date))[0];
        if(oldestUnpaid){
            const daysDiff=Math.floor((now-new Date(oldestUnpaid.date))/(1000*60*60*24));
            s.status=daysDiff>15?"late":"pending";
        }
    }else{s.status="ok"}
}

function closeDetailModal(){
    if(currentStudentId){
        const notesEl=document.getElementById("studentNotes");
        if(notesEl){
            const s=students.find(st=>st.id===currentStudentId);
            if(s)s.notes=notesEl.value;
        }
    }
    document.getElementById("detailModal").classList.remove("active");
    currentStudentId=null;
}

function editStudent(){
    const s=students.find(st=>st.id===currentStudentId);
    if(!s)return;
    const statusOptions='<option value="ok" '+(s.status==='ok'?'selected':'')+'>‚úÖ √Ä jour</option><option value="pending" '+(s.status==='pending'?'selected':'')+'>‚è≥ En attente</option><option value="late" '+(s.status==='late'?'selected':'')+'>‚ö†Ô∏è En retard</option>';
    const formationOptions=['M1 RH','M1 INFO CS','M2 INFO BD','M2 MSC','BTS SIO 2 SLAM','BTS SIO 2 SISR','BTS CG 2'].map(f=>'<option value="'+f+'" '+(s.formation===f?'selected':'')+'>'+f+'</option>').join('');
    const rythmeOptions=['IOA','Initiale','Alternance'].map(r=>'<option value="'+r+'" '+(s.rythme===r?'selected':'')+'>'+r+'</option>').join('');
    const initials=s.name.split(' ').map(n=>n[0]).join('').substring(0,2);
    const html='<div class="student-profile"><div class="student-avatar">'+initials+'</div></div><div class="info-section"><h4>üìã Informations</h4><div class="info-grid"><div class="info-item full"><div class="info-label">Nom complet</div><input type="text" id="editName" class="edit-input" value="'+s.name+'"></div><div class="info-item"><div class="info-label">T√©l√©phone</div><input type="text" id="editPhone" class="edit-input" value="'+s.phone+'"></div><div class="info-item"><div class="info-label">Email</div><input type="email" id="editEmail" class="edit-input" value="'+(s.email||'')+'"></div><div class="info-item"><div class="info-label">Formation</div><select id="editFormation" class="edit-input">'+formationOptions+'</select></div><div class="info-item"><div class="info-label">Rythme</div><select id="editRythme" class="edit-input">'+rythmeOptions+'</select></div><div class="info-item full"><div class="info-label">Banque</div><input type="text" id="editBank" class="edit-input" value="'+(s.bank||'')+'"></div></div></div><div class="info-section"><h4>üí≥ Statut</h4><div class="info-grid"><div class="info-item full"><div class="info-label">Statut de paiement</div><select id="editStatus" class="edit-input">'+statusOptions+'</select></div></div></div><div class="info-section notes-section"><h4>üìù Notes</h4><textarea id="editNotes" placeholder="Notes...">'+(s.notes||'')+'</textarea></div>';
    document.getElementById("detailContent").innerHTML=html;
    document.getElementById("detailFooter").innerHTML='<button class="btn btn-secondary" onclick="cancelEdit()">Annuler</button><button class="btn btn-primary" onclick="saveEdit()">üíæ Enregistrer</button>';
}

function cancelEdit(){openDetailModal(currentStudentId)}

function saveEdit(){
    const s=students.find(st=>st.id===currentStudentId);
    if(!s)return;
    const name=document.getElementById("editName").value.trim();
    const phone=document.getElementById("editPhone").value.trim();
    if(!name||!phone){alert("Le nom et le t√©l√©phone sont obligatoires.");return}
    s.name=name;
    s.phone=phone;
    s.email=document.getElementById("editEmail").value.trim();
    s.formation=document.getElementById("editFormation").value;
    s.rythme=document.getElementById("editRythme").value;
    s.bank=document.getElementById("editBank").value.trim();
    s.status=document.getElementById("editStatus").value;
    s.notes=document.getElementById("editNotes").value;
    sortStudentsAlphabetically();
    updateStats();
    renderStudents();
    openDetailModal(currentStudentId);
}

function deleteStudent(){
    if(!currentStudentId)return;
    const s=students.find(st=>st.id===currentStudentId);
    if(confirm('Supprimer '+s.name+' ?')){
        students=students.filter(st=>st.id!==currentStudentId);
        closeDetailModal();
        updateStats();
        renderStudents();
    }
}

function parsePayment(){
    const input=document.getElementById("paymentInput").value;
    const timeline=document.getElementById("previewTimeline");
    const totalEl=document.getElementById("previewTotal");
    if(!input.trim()){timeline.innerHTML='<p class="empty">Saisissez une formule ci-dessus...</p>';totalEl.textContent="Total: 0‚Ç¨";tempPayments=[];return}
    const payments=parsePaymentString(input);
    if(!payments.length){timeline.innerHTML='<p class="empty">Format non reconnu</p>';tempPayments=[];return}
    tempPayments=payments;
    let total=0,html="";
    for(let i=0;i<payments.length;i++){
        const p=payments[i];total+=p.amount;
        const isPast=new Date(p.rawDate)<new Date();
        html+='<div class="timeline-item"><div class="timeline-dot '+(isPast?'paid':'')+'"></div><span class="timeline-date">'+p.date+'</span><span class="timeline-amount">'+p.amount+'‚Ç¨</span><span class="timeline-type">'+p.type+'</span></div>';
    }
    timeline.innerHTML=html;
    totalEl.textContent="Total: "+total+"‚Ç¨";
}

function parsePaymentString(str){
    const payments=[];
    const parts=str.split(/\s+puis\s+|\s+et\s+|\s*\+\s*/i);
    for(let i=0;i<parts.length;i++){
        let part=parts[i].trim();
        const monthlyMatch=part.match(/(\d+(?:[.,]\d+)?)\s*‚Ç¨?\s*\/\s*mois\s+du\s+(\d{1,2}\/\d{1,2}\/\d{2,4})\s+au\s+(\d{1,2}\/\d{1,2}\/\d{2,4})/i);
        if(monthlyMatch){
            const amt=parseFloat(monthlyMatch[1].replace(",","."));
            const startDate=parseDate(monthlyMatch[2]);
            const endDate=parseDate(monthlyMatch[3]);
            let cur=new Date(startDate);
            while(cur<=endDate){payments.push({amount:amt,date:formatDate(cur),rawDate:cur.toISOString().split('T')[0],type:"Mensualit√©"});cur.setMonth(cur.getMonth()+1)}
            continue;
        }
        const everyMonthMatch=part.match(/(\d+(?:[.,]\d+)?)\s*‚Ç¨?\s*tous\s+les\s+(\d{1,2})\s+(?:du\s+mois\s+)?(?:a\s+partir\s+du\s+(\d{1,2}\/\d{1,2}\/\d{2,4})\s+)?jusqu['\u2019]?\s*au\s+(\d{1,2}\/\d{1,2}\/\d{2,4})/i);
        if(everyMonthMatch){
            const amt=parseFloat(everyMonthMatch[1].replace(",","."));
            const dayOfMonth=parseInt(everyMonthMatch[2]);
            const startDate=everyMonthMatch[3]?parseDate(everyMonthMatch[3]):new Date();
            const endDate=parseDate(everyMonthMatch[4]);
            let cur=new Date(startDate.getFullYear(),startDate.getMonth(),dayOfMonth);
            if(cur<startDate)cur.setMonth(cur.getMonth()+1);
            while(cur<=endDate){payments.push({amount:amt,date:formatDate(cur),rawDate:cur.toISOString().split('T')[0],type:"Mensualit√©"});cur.setMonth(cur.getMonth()+1)}
            continue;
        }
        const everyMonthFromTo=part.match(/(\d+(?:[.,]\d+)?)\s*‚Ç¨?\s*tous\s+les\s+(\d{1,2})\s+(?:du\s+mois\s+)?du\s+(\d{1,2}\/\d{1,2}\/\d{2,4})\s+au\s+(\d{1,2}\/\d{1,2}\/\d{2,4})/i);
        if(everyMonthFromTo){
            const amt=parseFloat(everyMonthFromTo[1].replace(",","."));
            const dayOfMonth=parseInt(everyMonthFromTo[2]);
            const startDate=parseDate(everyMonthFromTo[3]);
            const endDate=parseDate(everyMonthFromTo[4]);
            let cur=new Date(startDate.getFullYear(),startDate.getMonth(),dayOfMonth);
            if(cur<startDate)cur.setMonth(cur.getMonth()+1);
            while(cur<=endDate){payments.push({amount:amt,date:formatDate(cur),rawDate:cur.toISOString().split('T')[0],type:"Mensualit√©"});cur.setMonth(cur.getMonth()+1)}
            continue;
        }
        const singleMatch=part.match(/(\d+(?:[.,]\d+)?)\s*‚Ç¨?\s*(?:pvt|PVT|prelevement|pr√©l√®vement|espece|esp√®ce|cb|CB|chq|ch√®que|virement)?\s*(?:le|LE)?\s*(\d{1,2}\/\d{1,2}\/\d{2,4})/i);
        if(singleMatch){
            const dateObj=parseDate(singleMatch[2]);
            payments.push({amount:parseFloat(singleMatch[1].replace(",",".")),date:formatDate(dateObj),rawDate:dateObj.toISOString().split('T')[0],type:getType(part)});
        }
    }
    return payments;
}

function getType(s){s=s.toLowerCase();if(s.includes("pvt")||s.includes("pr√©l√®vement")||s.includes("prelevement"))return"Pr√©l√®vement";if(s.includes("espece")||s.includes("esp√®ce"))return"Esp√®ces";if(s.includes("cb"))return"Carte";if(s.includes("chq")||s.includes("ch√®que"))return"Ch√®que";if(s.includes("virement"))return"Virement";return"Paiement"}
function parseDate(d){const p=d.split("/");let y=parseInt(p[2]);if(y<100)y+=2000;return new Date(y,parseInt(p[1])-1,parseInt(p[0]))}
function formatDate(d){const m=["Jan","F√©v","Mar","Avr","Mai","Juin","Juil","Ao√ªt","Sep","Oct","Nov","D√©c"];return d.getDate()+" "+m[d.getMonth()]+" "+d.getFullYear()}

function saveStudent(){
    const name=document.getElementById("studentName").value.trim();
    const phone=document.getElementById("studentPhone").value.trim();
    const formation=document.getElementById("studentFormation").value;
    const rythme=document.getElementById("studentRythme").value;
    const bank=document.getElementById("studentBank").value.trim();
    if(!name||!phone){alert("Veuillez remplir le nom et le t√©l√©phone.");return}
    const echeances=tempPayments.map(p=>({date:p.rawDate,amount:p.amount,type:p.type,paid:new Date(p.rawDate)<new Date()}));
    const total=echeances.reduce((sum,e)=>sum+e.amount,0)||3690;
    const paid=echeances.filter(e=>e.paid).reduce((sum,e)=>sum+e.amount,0);
    let status="ok";
    if(paid<total){const hasUnpaidPastDue=echeances.some(e=>!e.paid&&new Date(e.date)<new Date());status=hasUnpaidPastDue?"pending":"ok"}
    const newStudent={id:Date.now(),name:name,formation:formation,rythme:rythme,phone:phone,status:status,paid:paid,total:total,bank:bank,email:"",notes:"",echeances:echeances};
    students.push(newStudent);
    sortStudentsAlphabetically();
    updateStats();
    renderStudents();
    closeModal();
    alert("‚úÖ "+name+" enregistr√©!\n\nüí∞ Total: "+total+"‚Ç¨\n‚úÖ D√©j√† pay√©: "+paid+"‚Ç¨\nüìÖ "+echeances.length+" √©ch√©ances");
}

sortStudentsAlphabetically();
updateStats();
renderStudents();
</script>
</body>
</html>
