<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestion Effectifs 2025-26</title>
<link rel="manifest" href="data:application/json,%7B%22name%22%3A%22Gestion%20Effectifs%22%2C%22short_name%22%3A%22Effectifs%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%231a1a2e%22%2C%22theme_color%22%3A%22%23667eea%22%7D">
<meta name="theme-color" content="#667eea">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:system-ui,-apple-system,sans-serif;background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%);min-height:100vh;color:#fff}
.app{max-width:1400px;margin:0 auto;padding:20px}
.header{display:flex;justify-content:space-between;align-items:center;padding:20px;background:rgba(255,255,255,0.05);border-radius:16px;margin-bottom:24px;backdrop-filter:blur(10px);flex-wrap:wrap;gap:12px}
.logo{display:flex;align-items:center;gap:12px}
.logo span{font-size:32px}
.logo h1{font-size:22px;font-weight:600}
.header-buttons{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.user-info{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,0.1);padding:8px 16px;border-radius:20px;font-size:14px}
.user-info span{color:#2ed573}
.btn{padding:12px 24px;border:none;border-radius:12px;font-size:14px;font-weight:600;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;gap:8px}
.btn-primary{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff}
.btn-primary:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(102,126,234,0.4)}
.btn-secondary{background:rgba(255,255,255,0.1);color:#fff}
.btn-secondary:hover{background:rgba(255,255,255,0.15)}
.btn-success{background:linear-gradient(135deg,#2ed573 0%,#7bed9f 100%);color:#1a1a2e}
.btn-success:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(46,213,115,0.4)}
.btn-warning{background:linear-gradient(135deg,#ff9f43 0%,#ffc048 100%);color:#1a1a2e}
.btn-warning:hover{transform:translateY(-2px);box-shadow:0 10px 30px rgba(255,159,67,0.4)}
.btn-danger{background:rgba(255,71,87,0.2);color:#ff4757}
.btn-danger:hover{background:rgba(255,71,87,0.3)}
.btn-sm{padding:8px 16px;font-size:13px}
.btn:disabled{opacity:0.5;cursor:not-allowed;transform:none!important}
.btn.loading{pointer-events:none;opacity:0.7}
.btn.loading::after{content:'';position:absolute;width:16px;height:16px;border:2px solid transparent;border-top-color:currentColor;border-radius:50%;animation:spin 0.6s linear infinite;right:10px}
.btn{position:relative}
.alert-badge{position:relative}
.alert-badge .badge{position:absolute;top:-6px;right:-6px;background:#ff4757;color:#fff;font-size:10px;font-weight:700;min-width:18px;height:18px;border-radius:9px;display:flex;align-items:center;justify-content:center;padding:0 5px;animation:pulse-badge 2s infinite}
@keyframes pulse-badge{0%,100%{transform:scale(1)}50%{transform:scale(1.15)}}
.readonly-banner{background:rgba(255,159,67,0.15);border:1px solid rgba(255,159,67,0.3);color:#ff9f43;padding:10px 20px;border-radius:12px;margin-bottom:20px;font-size:13px;display:flex;align-items:center;gap:10px}
.view-toggle{display:flex;gap:2px;background:rgba(255,255,255,0.05);border-radius:10px;padding:3px;border:1px solid rgba(255,255,255,0.08)}
.view-toggle button{padding:8px 14px;border:none;background:none;color:rgba(255,255,255,0.4);cursor:pointer;border-radius:8px;font-size:16px;transition:all 0.2s}
.view-toggle button.active{background:rgba(102,126,234,0.3);color:#fff}
.view-toggle button:hover{color:#fff}
.students-grid.list-view{grid-template-columns:1fr;gap:8px}
.students-grid.list-view .student-card{display:grid;grid-template-columns:1fr auto 200px 120px;align-items:center;padding:16px 24px;gap:20px}
.students-grid.list-view .student-header{margin-bottom:0}
.students-grid.list-view .student-details{margin-bottom:0;display:flex;gap:16px}
.students-grid.list-view .payment-progress{width:200px}
.students-grid.list-view .payment-info{margin-top:4px;font-size:12px}
.students-grid.list-view .student-card:hover{transform:none;border-color:rgba(102,126,234,0.5)}
.empty-state{grid-column:1/-1;text-align:center;padding:80px 40px;background:rgba(255,255,255,0.02);border-radius:20px;border:2px dashed rgba(255,255,255,0.1)}
.empty-state .empty-icon{font-size:72px;display:block;margin-bottom:20px;opacity:0.8}
.empty-state h3{font-size:20px;margin-bottom:12px;color:rgba(255,255,255,0.8)}
.empty-state p{color:rgba(255,255,255,0.4);font-size:15px;margin-bottom:24px;max-width:400px;margin-left:auto;margin-right:auto}
.relance-preview{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:20px;font-size:14px;line-height:1.6;color:rgba(255,255,255,0.8);white-space:pre-wrap;margin-bottom:16px}
.relance-actions{display:flex;gap:10px;flex-wrap:wrap}
.dashboard{display:grid;grid-template-columns:repeat(4,1fr);gap:20px;margin-bottom:24px}
.stat-card{background:rgba(255,255,255,0.05);border-radius:16px;padding:24px;display:flex;align-items:center;gap:16px;border:1px solid rgba(255,255,255,0.1);transition:all 0.3s;cursor:pointer}
.stat-card:hover{transform:translateY(-4px);border-color:rgba(255,255,255,0.2)}
.stat-icon{width:56px;height:56px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px}
.stat-icon.blue{background:rgba(102,126,234,0.2)}
.stat-icon.green{background:rgba(46,213,115,0.2)}
.stat-icon.orange{background:rgba(255,159,67,0.2)}
.stat-icon.red{background:rgba(255,71,87,0.2)}
.stat-value{font-size:28px;font-weight:700;display:block}
.stat-label{font-size:14px;color:rgba(255,255,255,0.6)}

/* Onglets */
.tabs{display:flex;gap:4px;margin-bottom:24px;background:rgba(255,255,255,0.05);border-radius:14px;padding:4px;border:1px solid rgba(255,255,255,0.08)}
.tab{padding:12px 28px;border:none;background:none;color:rgba(255,255,255,0.5);font-size:14px;font-weight:600;cursor:pointer;border-radius:10px;transition:all 0.25s;display:flex;align-items:center;gap:8px}
.tab:hover{color:#fff;background:rgba(255,255,255,0.05)}
.tab.active{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;box-shadow:0 4px 15px rgba(102,126,234,0.3)}
.tab-content{display:none}
.tab-content.active{display:block}

/* Stats page */
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px}
.stats-panel{background:rgba(255,255,255,0.05);border-radius:16px;padding:24px;border:1px solid rgba(255,255,255,0.08)}
.stats-panel.full{grid-column:1/-1}
.stats-panel h3{font-size:16px;font-weight:600;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.stats-table{width:100%;border-collapse:collapse}
.stats-table th{text-align:left;font-size:12px;color:rgba(255,255,255,0.4);text-transform:uppercase;letter-spacing:0.5px;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,0.1)}
.stats-table td{padding:10px 12px;font-size:14px;border-bottom:1px solid rgba(255,255,255,0.05)}
.stats-table tr{cursor:pointer;transition:background 0.2s}
.stats-table tr:hover td{background:rgba(102,126,234,0.1)}
.stats-table .count{font-weight:700;color:#667eea;text-align:right}
.stats-table .bar-cell{width:40%}
.stats-bar{height:8px;background:rgba(255,255,255,0.1);border-radius:4px;overflow:hidden}
.stats-bar-fill{height:100%;border-radius:4px;background:linear-gradient(90deg,#667eea,#764ba2);transition:width 0.5s}
.stats-back-btn{margin-bottom:20px}
.financial-summary{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:20px}
.financial-card{background:rgba(255,255,255,0.03);border-radius:12px;padding:20px;text-align:center;border:1px solid rgba(255,255,255,0.05)}
.financial-card .big{font-size:24px;font-weight:700;display:block;margin-bottom:4px}
.financial-card .big.green{color:#2ed573}
.financial-card .big.orange{color:#ff9f43}
.financial-card .big.blue{color:#667eea}
.financial-card .small{font-size:12px;color:rgba(255,255,255,0.5)}
@media(max-width:700px){.stats-grid{grid-template-columns:1fr}.financial-summary{grid-template-columns:1fr}}
.filters{display:flex;gap:16px;margin-bottom:24px;flex-wrap:wrap;align-items:center}
.search-box{flex:1;min-width:250px;display:flex;align-items:center;background:rgba(255,255,255,0.05);border-radius:12px;padding:0 16px;border:1px solid rgba(255,255,255,0.1)}
.search-box input{flex:1;background:none;border:none;padding:14px;color:#fff;font-size:14px;outline:none}
.search-box input::placeholder{color:rgba(255,255,255,0.4)}
.filters select{padding:14px 20px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:12px;color:#fff;font-size:14px;cursor:pointer}
.filters select option{background:#1a1a2e}
.students-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:20px}
.student-card{background:rgba(255,255,255,0.05);border-radius:16px;padding:24px;border:1px solid rgba(255,255,255,0.1);transition:all 0.3s;cursor:pointer}
.student-card:hover{transform:translateY(-5px);border-color:rgba(102,126,234,0.5);box-shadow:0 20px 40px rgba(0,0,0,0.3)}
.student-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px}
.student-name{font-size:18px;font-weight:600;margin-bottom:6px}
.student-formation{font-size:12px;color:rgba(255,255,255,0.7);background:rgba(102,126,234,0.2);padding:4px 10px;border-radius:20px;display:inline-block}
.status-badge{padding:6px 12px;border-radius:20px;font-size:11px;font-weight:600}
.status-badge.ok{background:rgba(46,213,115,0.2);color:#2ed573}
.status-badge.pending{background:rgba(255,159,67,0.2);color:#ff9f43}
.status-badge.late{background:rgba(255,71,87,0.2);color:#ff4757}
.student-details{margin-bottom:16px}
.detail-row{display:flex;align-items:center;gap:8px;font-size:14px;color:rgba(255,255,255,0.7);margin-bottom:8px}
.payment-progress{background:rgba(255,255,255,0.1);height:8px;border-radius:4px;overflow:hidden}
.payment-bar{height:100%;border-radius:4px;transition:width 0.5s}
.payment-bar.ok{background:linear-gradient(90deg,#2ed573,#7bed9f)}
.payment-bar.pending{background:linear-gradient(90deg,#ff9f43,#ffc048)}
.payment-bar.late{background:linear-gradient(90deg,#ff4757,#ff6b81)}
.payment-info{display:flex;justify-content:space-between;margin-top:10px;font-size:13px;color:rgba(255,255,255,0.6)}

/* Login */
.login-container{display:flex;justify-content:center;align-items:center;min-height:100vh;padding:20px}
.login-box{background:rgba(255,255,255,0.05);border-radius:20px;padding:40px;width:100%;max-width:400px;border:1px solid rgba(255,255,255,0.1)}
.login-box h1{text-align:center;margin-bottom:10px;font-size:28px}
.login-box .subtitle{text-align:center;color:rgba(255,255,255,0.6);margin-bottom:30px}
.login-box .form-group{margin-bottom:20px}
.login-box label{display:block;margin-bottom:8px;font-size:14px;font-weight:500}
.login-box input{width:100%;padding:14px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:12px;color:#fff;font-size:15px}
.login-box input:focus{outline:none;border-color:#667eea}
.login-box .btn{width:100%;justify-content:center;padding:16px}
.login-error{background:rgba(255,71,87,0.2);color:#ff4757;padding:12px;border-radius:10px;margin-bottom:20px;text-align:center;display:none}
.login-footer{text-align:center;margin-top:30px;color:rgba(255,255,255,0.4);font-size:13px}
.login-footer a{color:#667eea;text-decoration:none}

/* Modal */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.8);display:none;justify-content:center;align-items:center;z-index:1000;backdrop-filter:blur(5px);padding:20px}
.modal-overlay.active{display:flex}
.modal{background:linear-gradient(135deg,#1a1a2e,#16213e);border-radius:20px;width:100%;max-width:700px;max-height:90vh;overflow-y:auto;border:1px solid rgba(255,255,255,0.1)}
.modal-header{display:flex;justify-content:space-between;align-items:center;padding:24px;border-bottom:1px solid rgba(255,255,255,0.1)}
.modal-header h2{font-size:20px;font-weight:600}
.close-btn{width:36px;height:36px;border:none;background:rgba(255,255,255,0.1);color:#fff;border-radius:50%;font-size:24px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.close-btn:hover{background:rgba(255,255,255,0.2)}
.modal-body{padding:24px}
.form-group{margin-bottom:20px}
.form-group label{display:block;margin-bottom:10px;font-size:14px;font-weight:500}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:14px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:12px;color:#fff;font-size:14px;outline:none;transition:border-color 0.3s}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:#667eea}
.form-group select option{background:#1a1a2e;color:#fff}
.form-group textarea{min-height:80px;resize:vertical;font-family:inherit}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.modal-footer{padding:24px;border-top:1px solid rgba(255,255,255,0.1);display:flex;justify-content:flex-end;gap:12px}

/* D√©tail √©tudiant */
.student-profile{text-align:center;padding-bottom:20px;border-bottom:1px solid rgba(255,255,255,0.1);margin-bottom:20px}
.student-avatar{width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);display:flex;align-items:center;justify-content:center;font-size:32px;margin:0 auto 16px;font-weight:700}
.student-profile h3{font-size:24px;font-weight:600;margin-bottom:8px}
.info-section{margin-bottom:24px}
.info-section h4{font-size:14px;color:rgba(255,255,255,0.5);text-transform:uppercase;letter-spacing:1px;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.info-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.info-item{background:rgba(255,255,255,0.03);padding:16px;border-radius:12px;border:1px solid rgba(255,255,255,0.05)}
.info-item.full{grid-column:1/-1}
.info-label{font-size:12px;color:rgba(255,255,255,0.5);margin-bottom:6px}
.info-value{font-size:15px;font-weight:500}
.info-value a{color:#667eea;text-decoration:none}
.inline-edit{width:100%;padding:8px 0;background:none;border:none;border-bottom:1px solid rgba(255,255,255,0.15);color:#fff;font-size:15px;font-weight:500;font-family:inherit;outline:none;transition:border-color 0.3s}
.inline-edit:focus{border-bottom-color:#667eea}
.inline-edit::placeholder{color:rgba(255,255,255,0.3)}
select.inline-edit{cursor:pointer;appearance:auto;padding:8px 4px;border-radius:6px;background:rgba(255,255,255,0.05)}
select.inline-edit option{background:#1a1a2e;color:#fff}
textarea.inline-edit{border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:10px;min-height:60px;resize:vertical;background:rgba(255,255,255,0.03)}
.payment-detail .payment-progress{height:12px;margin-bottom:12px}
.payment-stats{display:flex;justify-content:space-between;font-size:14px}
.payment-stats .paid{color:#2ed573}
.payment-stats .remaining{color:#ff9f43}
.status-section{display:flex;align-items:center;justify-content:center;gap:12px;padding:16px;background:rgba(255,255,255,0.03);border-radius:12px;margin-bottom:20px}
.status-section .status-badge{font-size:14px;padding:8px 20px}
.meta-info{font-size:12px;color:rgba(255,255,255,0.4);text-align:center;margin-top:20px;padding-top:20px;border-top:1px solid rgba(255,255,255,0.1)}
.notes-section textarea{width:100%;min-height:80px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:12px;color:#fff;padding:14px;font-size:14px;resize:vertical;font-family:inherit}
.edit-input{width:100%;padding:12px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:10px;color:#fff;font-size:14px;margin-top:6px}
.edit-input:focus{outline:none;border-color:#667eea}

/* ============================================ */
/* √âCH√âANCIER INTERACTIF                        */
/* ============================================ */
.echeancier-section{background:rgba(255,255,255,0.03);border-radius:12px;padding:20px;margin-top:12px}
.echeancier-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:10px}
.echeancier-stats{display:flex;gap:20px}
.echeancier-stats .stat{text-align:center}
.echeancier-stats .stat-value{font-size:20px;font-weight:700}
.echeancier-stats .stat-value.green{color:#2ed573}
.echeancier-stats .stat-value.orange{color:#ff9f43}
.echeancier-stats .stat-value.total-val{color:#667eea}
.echeancier-stats .stat-label{font-size:10px;color:rgba(255,255,255,0.5);text-transform:uppercase;letter-spacing:0.5px}

.echeance-list{max-height:350px;overflow-y:auto;margin-bottom:16px}
.echeance-item{display:flex;align-items:center;gap:12px;padding:12px 14px;background:rgba(255,255,255,0.02);border-radius:10px;margin-bottom:6px;border:1px solid rgba(255,255,255,0.05);transition:all 0.2s}
.echeance-item:hover{background:rgba(255,255,255,0.05);border-color:rgba(255,255,255,0.1)}
.echeance-item.is-paid{opacity:0.55}
.echeance-item.is-late{border-color:rgba(255,71,87,0.3);background:rgba(255,71,87,0.05)}

.ech-check{width:24px;height:24px;border-radius:6px;border:2px solid rgba(255,255,255,0.3);cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all 0.2s}
.ech-check:hover{border-color:#2ed573;background:rgba(46,213,115,0.1)}
.ech-check.checked{background:#2ed573;border-color:#2ed573}
.ech-check.checked::after{content:"‚úì";color:#fff;font-size:14px;font-weight:700}

.ech-date{font-size:13px;min-width:100px;color:rgba(255,255,255,0.8)}
.ech-amount{font-weight:700;min-width:80px;font-size:15px}
.ech-amount.unpaid{color:#ff9f43}
.ech-amount.paid{color:#2ed573}
.ech-type{font-size:11px;color:rgba(255,255,255,0.4);padding:3px 8px;background:rgba(255,255,255,0.05);border-radius:6px}
.ech-delete{width:28px;height:28px;border:none;background:rgba(255,71,87,0.15);color:#ff4757;border-radius:6px;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center;margin-left:auto;opacity:0;transition:opacity 0.2s}
.echeance-item:hover .ech-delete{opacity:1}
.ech-delete:hover{background:rgba(255,71,87,0.3)}

/* √âdition inline √©ch√©ance */
.ech-date.editable,.ech-amount.editable{cursor:pointer;border-radius:6px;padding:2px 6px;margin:-2px -6px;transition:background 0.2s}
.ech-date.editable:hover,.ech-amount.editable:hover{background:rgba(102,126,234,0.15)}
.ech-edit-input{background:rgba(255,255,255,0.1);border:1px solid #667eea;border-radius:6px;color:#fff;font-size:inherit;font-weight:inherit;font-family:inherit;padding:4px 8px;outline:none;width:100%}
.ech-edit-input:focus{box-shadow:0 0 0 2px rgba(102,126,234,0.3)}
.ech-date-wrap{min-width:120px;position:relative}
.ech-amount-wrap{min-width:90px}
.ech-edit-input[type="date"]{color-scheme:dark;min-width:130px}
.ech-type.editable{cursor:pointer;transition:background 0.2s}
.ech-type.editable:hover{background:rgba(102,126,234,0.2)}
.ech-type-select{background:rgba(255,255,255,0.1);border:1px solid #667eea;border-radius:6px;color:#fff;font-size:11px;padding:3px 6px;outline:none;cursor:pointer}
.ech-type-select option{background:#1a1a2e;color:#fff}

/* Formulaire ajout √©ch√©ance */
.add-echeance-form{display:grid;grid-template-columns:1fr 100px 120px auto;gap:10px;align-items:end;padding:16px;background:rgba(102,126,234,0.08);border-radius:10px;border:1px solid rgba(102,126,234,0.2)}
.add-echeance-form .field{display:flex;flex-direction:column;gap:4px}
.add-echeance-form .field label{font-size:11px;color:rgba(255,255,255,0.5);text-transform:uppercase;letter-spacing:0.5px}
.add-echeance-form input,.add-echeance-form select{padding:10px;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:8px;color:#fff;font-size:13px}
.add-echeance-form input:focus,.add-echeance-form select:focus{outline:none;border-color:#667eea}
.btn-add-ech{padding:10px 16px;background:linear-gradient(135deg,#667eea,#764ba2);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;white-space:nowrap}
.btn-add-ech:hover{transform:translateY(-1px);box-shadow:0 4px 15px rgba(102,126,234,0.4)}

/* Texte brut fallback */
.echeances-raw{background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;font-size:13px;color:rgba(255,255,255,0.7);white-space:pre-wrap;word-break:break-word;margin-bottom:12px;border:1px solid rgba(255,255,255,0.05)}
.btn-parse-raw{font-size:12px;padding:6px 14px;background:rgba(102,126,234,0.2);color:#667eea;border:1px solid rgba(102,126,234,0.3);border-radius:8px;cursor:pointer;margin-top:8px}
.btn-parse-raw:hover{background:rgba(102,126,234,0.3)}

/* Import */
.import-zone{border:2px dashed rgba(102,126,234,0.4);border-radius:16px;padding:40px;text-align:center;margin-bottom:20px;transition:all 0.3s;cursor:pointer}
.import-zone:hover,.import-zone.dragover{border-color:#667eea;background:rgba(102,126,234,0.1)}
.import-zone input{display:none}
.import-stats{display:flex;gap:20px;justify-content:center;margin:20px 0}
.import-stat{background:rgba(255,255,255,0.05);padding:12px 24px;border-radius:10px;text-align:center}
.import-stat-value{font-size:24px;font-weight:700;color:#667eea}
.import-stat-label{font-size:12px;color:rgba(255,255,255,0.5)}
.import-preview{background:rgba(255,255,255,0.03);border-radius:12px;padding:16px;max-height:200px;overflow-y:auto}
.import-preview table{width:100%;font-size:12px;border-collapse:collapse}
.import-preview th,.import-preview td{padding:8px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.1)}

/* Historique */
.history-list{max-height:400px;overflow-y:auto}
.history-item{display:flex;gap:16px;padding:12px 0;border-bottom:1px solid rgba(255,255,255,0.05)}
.history-item:last-child{border-bottom:none}
.history-date{font-size:12px;color:rgba(255,255,255,0.4);min-width:130px}
.history-user{font-size:13px;color:#667eea;min-width:80px}
.history-action{font-size:13px;font-weight:500;min-width:100px}
.history-action.creation,.history-action.Cr√©ation{color:#2ed573}
.history-action.modification,.history-action.Modification{color:#ff9f43}
.history-action.suppression,.history-action.Suppression{color:#ff4757}
.history-action.import,.history-action.Import{color:#667eea}
.history-details{font-size:13px;color:rgba(255,255,255,0.6)}

/* Toast */
.toast{position:fixed;bottom:30px;right:30px;background:#2ed573;color:#1a1a2e;padding:16px 24px;border-radius:12px;font-weight:600;transform:translateY(100px);opacity:0;transition:all 0.3s;z-index:2000}
.toast.show{transform:translateY(0);opacity:1}
.toast.error{background:#ff4757;color:#fff}

/* Loading */
.loading{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);justify-content:center;align-items:center;z-index:3000}
.loading.active{display:flex}
.spinner{width:50px;height:50px;border:4px solid rgba(255,255,255,0.1);border-top-color:#667eea;border-radius:50%;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Footer */
.footer{text-align:center;padding:20px;color:rgba(255,255,255,0.4);font-size:13px}
.footer a{color:#667eea;text-decoration:none;font-weight:600}

@media(max-width:900px){
  .btn.loading{pointer-events:none;opacity:0.7}
.btn.loading::after{content:'';position:absolute;width:16px;height:16px;border:2px solid transparent;border-top-color:currentColor;border-radius:50%;animation:spin 0.6s linear infinite;right:10px}
.btn{position:relative}
.alert-badge{position:relative}
.alert-badge .badge{position:absolute;top:-6px;right:-6px;background:#ff4757;color:#fff;font-size:10px;font-weight:700;min-width:18px;height:18px;border-radius:9px;display:flex;align-items:center;justify-content:center;padding:0 5px;animation:pulse-badge 2s infinite}
@keyframes pulse-badge{0%,100%{transform:scale(1)}50%{transform:scale(1.15)}}
.readonly-banner{background:rgba(255,159,67,0.15);border:1px solid rgba(255,159,67,0.3);color:#ff9f43;padding:10px 20px;border-radius:12px;margin-bottom:20px;font-size:13px;display:flex;align-items:center;gap:10px}
.view-toggle{display:flex;gap:2px;background:rgba(255,255,255,0.05);border-radius:10px;padding:3px;border:1px solid rgba(255,255,255,0.08)}
.view-toggle button{padding:8px 14px;border:none;background:none;color:rgba(255,255,255,0.4);cursor:pointer;border-radius:8px;font-size:16px;transition:all 0.2s}
.view-toggle button.active{background:rgba(102,126,234,0.3);color:#fff}
.view-toggle button:hover{color:#fff}
.students-grid.list-view{grid-template-columns:1fr;gap:8px}
.students-grid.list-view .student-card{display:grid;grid-template-columns:1fr auto 200px 120px;align-items:center;padding:16px 24px;gap:20px}
.students-grid.list-view .student-header{margin-bottom:0}
.students-grid.list-view .student-details{margin-bottom:0;display:flex;gap:16px}
.students-grid.list-view .payment-progress{width:200px}
.students-grid.list-view .payment-info{margin-top:4px;font-size:12px}
.students-grid.list-view .student-card:hover{transform:none;border-color:rgba(102,126,234,0.5)}
.empty-state{grid-column:1/-1;text-align:center;padding:80px 40px;background:rgba(255,255,255,0.02);border-radius:20px;border:2px dashed rgba(255,255,255,0.1)}
.empty-state .empty-icon{font-size:72px;display:block;margin-bottom:20px;opacity:0.8}
.empty-state h3{font-size:20px;margin-bottom:12px;color:rgba(255,255,255,0.8)}
.empty-state p{color:rgba(255,255,255,0.4);font-size:15px;margin-bottom:24px;max-width:400px;margin-left:auto;margin-right:auto}
.relance-preview{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:20px;font-size:14px;line-height:1.6;color:rgba(255,255,255,0.8);white-space:pre-wrap;margin-bottom:16px}
.relance-actions{display:flex;gap:10px;flex-wrap:wrap}
.dashboard{grid-template-columns:repeat(2,1fr)}
  .info-grid{grid-template-columns:1fr}
  .form-row{grid-template-columns:1fr}
  .add-echeance-form{grid-template-columns:1fr 1fr;gap:8px}
}
@media(max-width:600px){
  .btn.loading{pointer-events:none;opacity:0.7}
.btn.loading::after{content:'';position:absolute;width:16px;height:16px;border:2px solid transparent;border-top-color:currentColor;border-radius:50%;animation:spin 0.6s linear infinite;right:10px}
.btn{position:relative}
.alert-badge{position:relative}
.alert-badge .badge{position:absolute;top:-6px;right:-6px;background:#ff4757;color:#fff;font-size:10px;font-weight:700;min-width:18px;height:18px;border-radius:9px;display:flex;align-items:center;justify-content:center;padding:0 5px;animation:pulse-badge 2s infinite}
@keyframes pulse-badge{0%,100%{transform:scale(1)}50%{transform:scale(1.15)}}
.readonly-banner{background:rgba(255,159,67,0.15);border:1px solid rgba(255,159,67,0.3);color:#ff9f43;padding:10px 20px;border-radius:12px;margin-bottom:20px;font-size:13px;display:flex;align-items:center;gap:10px}
.view-toggle{display:flex;gap:2px;background:rgba(255,255,255,0.05);border-radius:10px;padding:3px;border:1px solid rgba(255,255,255,0.08)}
.view-toggle button{padding:8px 14px;border:none;background:none;color:rgba(255,255,255,0.4);cursor:pointer;border-radius:8px;font-size:16px;transition:all 0.2s}
.view-toggle button.active{background:rgba(102,126,234,0.3);color:#fff}
.view-toggle button:hover{color:#fff}
.students-grid.list-view{grid-template-columns:1fr;gap:8px}
.students-grid.list-view .student-card{display:grid;grid-template-columns:1fr auto 200px 120px;align-items:center;padding:16px 24px;gap:20px}
.students-grid.list-view .student-header{margin-bottom:0}
.students-grid.list-view .student-details{margin-bottom:0;display:flex;gap:16px}
.students-grid.list-view .payment-progress{width:200px}
.students-grid.list-view .payment-info{margin-top:4px;font-size:12px}
.students-grid.list-view .student-card:hover{transform:none;border-color:rgba(102,126,234,0.5)}
.empty-state{grid-column:1/-1;text-align:center;padding:80px 40px;background:rgba(255,255,255,0.02);border-radius:20px;border:2px dashed rgba(255,255,255,0.1)}
.empty-state .empty-icon{font-size:72px;display:block;margin-bottom:20px;opacity:0.8}
.empty-state h3{font-size:20px;margin-bottom:12px;color:rgba(255,255,255,0.8)}
.empty-state p{color:rgba(255,255,255,0.4);font-size:15px;margin-bottom:24px;max-width:400px;margin-left:auto;margin-right:auto}
.relance-preview{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:20px;font-size:14px;line-height:1.6;color:rgba(255,255,255,0.8);white-space:pre-wrap;margin-bottom:16px}
.relance-actions{display:flex;gap:10px;flex-wrap:wrap}
.dashboard{grid-template-columns:1fr}
  .header{flex-direction:column;text-align:center}
  .header-buttons{justify-content:center}
  .add-echeance-form{grid-template-columns:1fr}
}
</style>
</head>
<body>

<!-- PAGE LOGIN -->
<div id="loginPage" class="login-container">
    <div class="login-box">
        <h1>üéì Gestion Effectifs</h1>
        <p class="subtitle">2025-26</p>
        <div class="login-error" id="loginError">Identifiants incorrects</div>
        <div class="form-group">
            <label>Nom d'utilisateur</label>
            <input type="text" id="loginUsername" placeholder="Votre identifiant">
        </div>
        <div class="form-group">
            <label>Mot de passe</label>
            <input type="password" id="loginPassword" placeholder="Votre mot de passe" onkeypress="if(event.key==='Enter')login()">
        </div>
        <button class="btn btn-primary" onclick="login()" id="loginBtn">üîê Se connecter</button>
        <div class="login-footer">Propuls√© par <a href="https://770lab.com" target="_blank">770 Lab</a></div>
    </div>
</div>

<!-- PAGE PRINCIPALE -->
<div id="mainPage" class="app" style="display:none">
    <div id="readonlyBanner" class="readonly-banner" style="display:none">üîí Mode lecture seule ‚Äî Vous ne pouvez pas modifier les donn√©es</div>
    <header class="header">
        <div class="logo"><span>üéì</span><h1>Gestion Effectifs 2025-26</h1></div>
        <div class="header-buttons">
            <div class="user-info">üë§ <span id="currentUser">-</span> <span id="userRole" style="font-size:11px;opacity:0.6"></span></div>
            <div class="alert-badge" id="alertBadgeWrap" style="display:none">
                <button class="btn btn-danger btn-sm" onclick="filterFromStats('status','late')">‚ö†Ô∏è Retards <span class="badge" id="lateAlertBadge">0</span></button>
            </div>
            <button class="btn btn-success btn-sm write-only" onclick="openImportModal()">üì• Importer</button>
            <button class="btn btn-warning btn-sm" onclick="exportCSV()">üì§ Exporter</button>
            <button class="btn btn-secondary btn-sm" onclick="openHistoryModal()">üìú Historique</button>
            <button class="btn btn-primary btn-sm write-only" onclick="openModal()">+ Nouvel √©tudiant</button>
            <button class="btn btn-danger btn-sm" onclick="logout()">üö™</button>
        </div>
    </header>
    
    <!-- ONGLETS -->
    <div class="tabs">
        <button class="tab active" onclick="switchTab('accueil')">üè† Accueil</button>
        <button class="tab" onclick="switchTab('stats')">üìä Statistiques</button>
    </div>
    
    <!-- ONGLET ACCUEIL -->
    <div id="tabAccueil" class="tab-content active">
        <div class="filters">
            <div class="search-box"><span>üîç</span><input type="text" id="searchInput" placeholder="Rechercher un √©tudiant..." oninput="renderStudents()"></div>
            <select id="formationFilter" onchange="renderStudents()"><option value="">Toutes formations</option></select>
            <select id="statusFilter" onchange="renderStudents()"><option value="">Tous statuts</option><option value="ok">‚úÖ √Ä jour</option><option value="pending">‚è≥ En attente</option><option value="late">‚ö†Ô∏è En retard</option></select>
            <select id="rythmeFilter" onchange="renderStudents()"><option value="">Tous rythmes</option><option value="IOA">IOA</option><option value="Initiale">Initiale</option><option value="Alternance">Alternance</option><option value="SFP">SFP</option></select>
            <select id="lateFilter" onchange="renderStudents()"><option value="">Tous d√©lais</option><option value="30">Retard &gt; 30j</option><option value="60">Retard &gt; 60j</option><option value="90">Retard &gt; 90j</option></select>
            <div class="view-toggle">
                <button onclick="setView('grid')" class="active" id="viewGrid" title="Vue grille">‚ñ¶</button>
                <button onclick="setView('list')" id="viewList" title="Vue liste">‚ò∞</button>
            </div>
            <button class="btn btn-secondary btn-sm" onclick="clearFilters()">‚úï R√©initialiser</button>
            <button class="btn btn-secondary btn-sm" onclick="loadStudents()">üîÑ</button>
        </div>
        <div id="activeFilterBanner" style="display:none;margin-bottom:16px;padding:12px 20px;background:rgba(102,126,234,0.15);border:1px solid rgba(102,126,234,0.3);border-radius:12px;display:none;align-items:center;justify-content:space-between">
            <span id="activeFilterText" style="font-size:14px"></span>
            <button class="btn btn-secondary btn-sm" onclick="clearFilters()" style="padding:6px 14px;font-size:12px">‚úï Tout afficher</button>
        </div>
        <div class="students-grid" id="studentsGrid"></div>
    </div>
    
    <!-- ONGLET STATISTIQUES -->
    <div id="tabStats" class="tab-content">
        <div class="dashboard">
            <div class="stat-card" onclick="filterFromStats('status','')"><div class="stat-icon blue">üë•</div><div><span class="stat-value" id="totalCount">0</span><span class="stat-label">√âtudiants</span></div></div>
            <div class="stat-card" onclick="filterFromStats('status','ok')"><div class="stat-icon green">‚úÖ</div><div><span class="stat-value" id="okCount">0</span><span class="stat-label">√Ä jour</span></div></div>
            <div class="stat-card" onclick="filterFromStats('status','pending')"><div class="stat-icon orange">‚è≥</div><div><span class="stat-value" id="pendingCount">0</span><span class="stat-label">En attente</span></div></div>
            <div class="stat-card" onclick="filterFromStats('status','late')"><div class="stat-icon red">‚ö†Ô∏è</div><div><span class="stat-value" id="lateCount">0</span><span class="stat-label">Retard</span></div></div>
        </div>
        <div class="financial-summary">
            <div class="financial-card"><span class="big green" id="statTotalPaid">0‚Ç¨</span><span class="small">Total encaiss√©</span></div>
            <div class="financial-card"><span class="big orange" id="statTotalRemaining">0‚Ç¨</span><span class="small">Total restant</span></div>
            <div class="financial-card"><span class="big blue" id="statTotalDue">0‚Ç¨</span><span class="small">Total d√ª</span></div>
        </div>
        <div class="stats-grid">
            <div class="stats-panel"><h3>üìö Par formation</h3><table class="stats-table"><thead><tr><th>Formation</th><th class="bar-cell"></th><th style="text-align:right">Nb</th></tr></thead><tbody id="statsFormation"></tbody></table></div>
            <div class="stats-panel"><h3>üîÑ Par rythme</h3><table class="stats-table"><thead><tr><th>Rythme</th><th class="bar-cell"></th><th style="text-align:right">Nb</th></tr></thead><tbody id="statsRythme"></tbody></table></div>
            <div class="stats-panel"><h3>üìù Ch√®que de caution</h3><table class="stats-table"><thead><tr><th>CHQ</th><th class="bar-cell"></th><th style="text-align:right">Nb</th></tr></thead><tbody id="statsChq"></tbody></table></div>
            <div class="stats-panel"><h3>üìå Par statut</h3><table class="stats-table"><thead><tr><th>Statut</th><th class="bar-cell"></th><th style="text-align:right">Nb</th></tr></thead><tbody id="statsStatus"></tbody></table></div>
        </div>
    </div>
    
    <div class="footer">Propuls√© par <a href="https://770lab.com" target="_blank">770 Lab</a></div>
</div>

<!-- MODAL NOUVEL √âTUDIANT -->
<div class="modal-overlay" id="modalOverlay" onclick="closeModal()">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-header"><h2>üìù Nouvel √©tudiant</h2><button class="close-btn" onclick="closeModal()">√ó</button></div>
        <div class="modal-body">
            <div class="form-row">
                <div class="form-group"><label>Nom</label><input type="text" id="studentNom" placeholder="NOM"></div>
                <div class="form-group"><label>Pr√©nom</label><input type="text" id="studentPrenom" placeholder="Pr√©nom"></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>Formation</label><select id="studentFormation"><option value="">-- Choisir --</option><option>BACH CDA</option><option>BACH CDME</option><option>BTS CG 1</option><option>BTS CG 2</option><option>BTS CI 1</option><option>BTS COM 1</option><option>BTS COM 2</option><option>BTS MCO 1</option><option>BTS MCO 2</option><option>BTS NDRC 1</option><option>BTS NDRC 2</option><option>BTS SAM 1</option><option>BTS SIO 1</option><option>BTS SIO 2 SISR</option><option>BTS SIO 2 SLAM</option><option>BTS SIO SISR</option><option>Bachelor AIS</option><option>Bachelor RH</option><option>M1 COM</option><option>M1 FCA</option><option>M1 FSO</option><option>M1 INFO BD</option><option>M1 INFO CS</option><option>M1 MCM</option><option>M1 MSC</option><option>M1 RH</option><option>M2 INFO BD</option><option>M2 INFO CS</option><option>M2 MCM</option><option>M2 MSC</option><option>M2 MSFO</option><option>M2 RH</option></select></div>
                <div class="form-group"><label>Rythme</label><select id="studentRythme"><option value="IOA">IOA</option><option value="Initiale">Initiale</option><option value="Alternance">Alternance</option><option value="SFP">SFP</option></select></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>T√©l√©phone</label><input type="text" id="studentPhone" placeholder="0612345678"></div>
                <div class="form-group"><label>Banque</label><input type="text" id="studentBank" placeholder="BNP, LCL, SG..."></div>
            </div>
            <div class="form-row">
                <div class="form-group"><label>CHQ (Ch√®que de caution)</label><select id="studentChq" onchange="toggleChqFields('student')"><option value="non">Non</option><option value="oui">Oui</option></select></div>
                <div class="form-group" id="studentChqMontantGroup" style="display:none"><label>Montant CHQ</label><input type="number" id="studentChqMontant" placeholder="0"></div>
                <div class="form-group" id="studentChqBanqueGroup" style="display:none"><label>Banque CHQ</label><input type="text" id="studentChqBanque" placeholder="Banque du ch√®que"></div>
            </div>
            <div class="form-group">
                <label>√âch√©ances (texte libre, pars√© en direct)</label>
                <textarea id="studentEcheances" placeholder="Ex: 760 r√©gl√© en esp√®ce le 20/02/25 puis pvt de 323 du 5/10/25 au 5/6/26" oninput="previewEcheancesLive('studentEcheances','echeancesPreviewCreate')"></textarea>
                <div id="echeancesPreviewCreate" style="margin-top:10px"></div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal()">Annuler</button>
            <button class="btn btn-primary" onclick="saveStudent()" id="saveStudentBtn">üíæ Enregistrer</button>
        </div>
    </div>
</div>

<!-- MODAL D√âTAIL √âTUDIANT -->
<div class="modal-overlay" id="detailModal" onclick="closeDetailModal()">
    <div class="modal" onclick="event.stopPropagation()">
        <div class="modal-header"><h2>üë§ Fiche √©tudiant</h2><button class="close-btn" onclick="closeDetailModal()">√ó</button></div>
        <div class="modal-body" id="detailContent"></div>
        <div class="modal-footer" id="detailFooter"></div>
    </div>
</div>

<!-- MODAL IMPORT -->
<div class="modal-overlay" id="importModal" onclick="closeImportModal()">
    <div class="modal" onclick="event.stopPropagation()" style="max-width:800px">
        <div class="modal-header"><h2>üì• Importer des donn√©es</h2><button class="close-btn" onclick="closeImportModal()">√ó</button></div>
        <div class="modal-body">
            <div class="import-zone" id="importZone" onclick="document.getElementById('fileInput').click()">
                <span style="font-size:48px">üìÑ</span>
                <p style="color:rgba(255,255,255,0.6);margin-top:10px">Cliquez ou glissez un fichier CSV/TSV</p>
                <input type="file" id="fileInput" accept=".csv,.tsv,.txt" onchange="handleFileSelect(event)">
            </div>
            <div id="importPreview" style="display:none">
                <div class="import-stats">
                    <div class="import-stat"><div class="import-stat-value" id="previewCount">0</div><div class="import-stat-label">D√©tect√©s</div></div>
                    <div class="import-stat"><div class="import-stat-value" id="previewNew">0</div><div class="import-stat-label">Nouveaux</div></div>
                    <div class="import-stat"><div class="import-stat-value" id="previewUpdate">0</div><div class="import-stat-label">M√†j</div></div>
                </div>
                <div class="import-preview"><table><thead><tr><th>Nom</th><th>Formation</th><th>Rythme</th><th>T√©l</th><th>√âch√©ances</th></tr></thead><tbody id="previewTable"></tbody></table></div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeImportModal()">Annuler</button>
            <button class="btn btn-primary" id="importBtn" onclick="confirmImport()" disabled>üì• Importer</button>
        </div>
    </div>
</div>

<!-- MODAL HISTORIQUE -->
<div class="modal-overlay" id="historyModal" onclick="closeHistoryModal()">
    <div class="modal" onclick="event.stopPropagation()" style="max-width:800px">
        <div class="modal-header"><h2>üìú Historique des modifications</h2><button class="close-btn" onclick="closeHistoryModal()">√ó</button></div>
        <div class="modal-body">
            <div class="history-list" id="historyList"></div>
        </div>
    </div>
</div>

<!-- MODAL RELANCE -->
<div class="modal-overlay" id="relanceModal" onclick="closeRelanceModal()">
    <div class="modal" onclick="event.stopPropagation()" style="max-width:600px">
        <div class="modal-header"><h2>üìß Mod√®le de relance</h2><button class="close-btn" onclick="closeRelanceModal()">√ó</button></div>
        <div class="modal-body">
            <div class="relance-preview" id="relanceText"></div>
            <div class="relance-actions">
                <button class="btn btn-primary btn-sm" onclick="copyRelance()">üìã Copier le texte</button>
                <button class="btn btn-success btn-sm" id="relanceSmsBtn">üí¨ Ouvrir SMS</button>
                <button class="btn btn-secondary btn-sm" onclick="closeRelanceModal()">Fermer</button>
            </div>
        </div>
    </div>
</div>

<!-- TOAST & LOADING -->
<div class="toast" id="toast"></div>
<div class="loading" id="loading"><div class="spinner"></div></div>

<script>
// ==========================================
// CONFIGURATION ‚Äî METS TON URL ICI
// ==========================================
const API_URL = 'https://script.google.com/macros/s/AKfycbxfc4ZadRS15vEu9qG-xpiZdRXv96Mz7Bqzefe3APSVP1ZFUOVnA610mVy0gOdyZKm6Zg/exec';
let students = [];
let currentUser = null;
let currentStudentId = null;
let pendingImport = [];
let currentView = 'grid';
let detailDirty = false;

// XSS Protection
function esc(str) {
    if (str == null) return '';
    const div = document.createElement('div');
    div.textContent = String(str);
    return div.innerHTML;
}

// Role Management
function isReadOnly() { return currentUser && currentUser.role === 'readonly'; }
function canWrite() { return currentUser && currentUser.role !== 'readonly'; }
function applyRoleRestrictions() {
    const writeButtons = document.querySelectorAll('.write-only');
    const banner = document.getElementById('readonlyBanner');
    if (isReadOnly()) {
        writeButtons.forEach(b => b.style.display = 'none');
        banner.style.display = 'flex';
    } else {
        writeButtons.forEach(b => b.style.display = '');
        banner.style.display = 'none';
    }
}

// View Toggle
function setView(view) {
    currentView = view;
    document.getElementById('viewGrid').classList.toggle('active', view === 'grid');
    document.getElementById('viewList').classList.toggle('active', view === 'list');
    document.getElementById('studentsGrid').classList.toggle('list-view', view === 'list');
}

// Alert Badge
function updateAlertBadge() {
    const lateCount = students.filter(s => s.status === 'late').length;
    const wrap = document.getElementById('alertBadgeWrap');
    const badge = document.getElementById('lateAlertBadge');
    if (lateCount > 0) { wrap.style.display = ''; badge.textContent = lateCount; }
    else { wrap.style.display = 'none'; }
}

// Export CSV
function exportCSV() {
    if (students.length === 0) { showToast('Aucune donn√©e √† exporter', true); return; }
    const headers = ['Nom','Formation','Rythme','T√©l√©phone','Banque','Statut','Pay√©','Total','Restant','CHQ','CHQ Montant','CHQ Banque','Notes','√âch√©ances','Cr√©√© par','Date cr√©ation','Modifi√© par','Date modification'];
    const statusLabels = { ok: '√Ä jour', pending: 'En attente', late: 'En retard' };
    const rows = students.map(s => [s.nom||'', s.formation||'', s.rythme||'', s.telephone||'', s.banque||'', statusLabels[s.status]||s.status||'', s.paid||0, s.total||0, (s.total||0)-(s.paid||0), s.chq?'Oui':'Non', s.chqMontant||'', s.chqBanque||'', (s.notes||'').replace(/[\n\r]+/g,' '), s.echeancesRaw||'', s.creePar||'', s.creeDate||'', s.modifiePar||'', s.modifieDate||'']);
    const csv = '\uFEFF' + [headers,...rows].map(row => row.map(c => '"'+String(c).replace(/"/g,'""')+'"').join(';')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'effectifs_'+new Date().toISOString().slice(0,10)+'.csv';
    a.click(); URL.revokeObjectURL(url);
    showToast('üì§ ' + students.length + ' √©tudiants export√©s');
}

// Late days calculator
function getOldestLatedays(s) {
    if (!s.echeancesJson || s.echeancesJson.length === 0) return 0;
    const now = new Date();
    let maxDays = 0;
    s.echeancesJson.forEach(e => { if (!e.paid) { const days = Math.floor((now - new Date(e.date)) / 86400000); if (days > maxDays) maxDays = days; } });
    return maxDays;
}

// Relance Templates
function openRelanceModal(studentId) {
    const s = students.find(st => String(st.id) === String(studentId));
    if (!s) return;
    const remaining = (s.total||0) - (s.paid||0);
    const lateEchs = (s.echeancesJson||[]).filter(e => !e.paid && new Date(e.date) < new Date());
    const lateTotal = lateEchs.reduce((sum,e) => sum + (e.montant||0), 0);
    const prenom = (s.nom||'').split(' ').slice(1).join(' ') || s.nom || '√©tudiant';
    const text = 'Bonjour ' + prenom + ',\n\nNous nous permettons de vous contacter concernant votre situation financi√®re pour la formation ' + (s.formation||'en cours') + '.\n\n√Ä ce jour, un montant de ' + lateTotal.toLocaleString('fr-FR') + '‚Ç¨ est en retard de paiement' + (lateEchs.length > 1 ? ' (' + lateEchs.length + ' √©ch√©ances)' : '') + '.\n\nMontant total restant d√ª : ' + remaining.toLocaleString('fr-FR') + '‚Ç¨\n\nNous vous invitons √† r√©gulariser votre situation dans les meilleurs d√©lais. Si vous rencontrez des difficult√©s, n\'h√©sitez pas √† nous contacter pour trouver une solution ensemble.\n\nCordialement,\nL\'√©quipe administrative';
    document.getElementById('relanceText').textContent = text;
    document.getElementById('relanceSmsBtn').onclick = () => {
        if (s.telephone) window.open('sms:' + s.telephone + '?body=' + encodeURIComponent(text), '_blank');
        else showToast('Pas de num√©ro de t√©l√©phone', true);
    };
    document.getElementById('relanceModal').classList.add('active');
}
function closeRelanceModal() { document.getElementById('relanceModal').classList.remove('active'); }
function copyRelance() {
    navigator.clipboard.writeText(document.getElementById('relanceText').textContent)
        .then(() => showToast('üìã Texte copi√© !')).catch(() => showToast('Erreur de copie', true));
}


// ==========================================
// HELPERS API
// ==========================================
function apiGet(params) {
    const qs = Object.entries(params).map(([k,v]) => `${k}=${encodeURIComponent(v)}`).join('&');
    return fetch(`${API_URL}?${qs}`).then(r => r.json());
}

function apiPost(body) {
    return fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
    }).then(r => r.json());
}

function isTestMode() {
    return API_URL === 'VOTRE_URL_APPS_SCRIPT';}

// ==========================================
// AUTHENTIFICATION
// ==========================================
function login() {
    const username = document.getElementById('loginUsername').value.trim();
    const password = document.getElementById('loginPassword').value;
    if (!username || !password) { showLoginError('Veuillez remplir tous les champs'); return; }
    
    if (isTestMode()) {
        currentUser = { username, role: 'admin' };
        localStorage.setItem('user', JSON.stringify(currentUser));
        showMainPage();
        showToast('‚ö†Ô∏è Mode test ‚Äî Configurez l\'API pour la prod', true);
        return;
    }
    
    const btn = document.getElementById('loginBtn');
    btn.classList.add('loading'); btn.disabled = true;
    showLoading(true);
    apiGet({ action: 'login', username, password }).then(data => {
        showLoading(false);
        btn.classList.remove('loading'); btn.disabled = false;
        if (data.success) {
            currentUser = data.user;
            localStorage.setItem('user', JSON.stringify(currentUser));
            showMainPage();
        } else {
            showLoginError(data.error || 'Identifiants incorrects');
        }
    }).catch(() => { showLoading(false); btn.classList.remove('loading'); btn.disabled = false; showLoginError('Erreur de connexion au serveur'); });
}

function logout() {
    currentUser = null;
    localStorage.removeItem('user');
    document.getElementById('loginPage').style.display = 'flex';
    document.getElementById('mainPage').style.display = 'none';
    document.getElementById('loginUsername').value = '';
    document.getElementById('loginPassword').value = '';
}

function showLoginError(msg) {
    const el = document.getElementById('loginError');
    el.textContent = msg;
    el.style.display = 'block';
}

function showMainPage() {
    document.getElementById('loginPage').style.display = 'none';
    document.getElementById('mainPage').style.display = 'block';
    document.getElementById('currentUser').textContent = currentUser.username;
    document.getElementById('loginError').style.display = 'none';
    document.getElementById('userRole').textContent = currentUser.role === 'readonly' ? '(lecture)' : currentUser.role === 'admin' ? '(admin)' : '';
    applyRoleRestrictions();
    loadStudents();
}

// ==========================================
// CHARGEMENT DES DONN√âES
// ==========================================
function loadStudents() {
    if (isTestMode()) {
        students = JSON.parse(localStorage.getItem('students_test') || '[]');
        students.sort((a, b) => {
            const dateA = a.creeDate || a.modifieDate || '';
            const dateB = b.creeDate || b.modifieDate || '';
            if (dateB > dateA) return 1;
            if (dateB < dateA) return -1;
            return 0;
        });
        updateAll();
        return;
    }
    
    showLoading(true);
    apiGet({ action: 'getStudents' }).then(data => {
        showLoading(false);
        if (data.success) {
            students = data.students;
            students.sort((a, b) => {
                    // Les plus r√©cents en premier (par date de cr√©ation)
                    const dateA = a.creeDate || a.modifieDate || '';
                    const dateB = b.creeDate || b.modifieDate || '';
                    if (dateB > dateA) return 1;
                    if (dateB < dateA) return -1;
                    return 0;
                });
            updateAll();
        } else {
            showToast('Erreur: ' + data.error, true);
        }
    }).catch(() => { showLoading(false); showToast('Erreur de connexion', true); });
}

function updateAll() {
    updateStats();
    updateFormationFilter();
    renderStudents();
    renderStatsPage();
    updateAlertBadge();
}

function saveToServer(student, callback) {
    if (isReadOnly()) { showToast('Mode lecture seule', true); return; }
    if (isTestMode()) {
        const now = new Date().toLocaleString('fr-FR');
        if (!student.id) {
            student.id = Date.now().toString();
            student.creePar = currentUser.username;
            student.creeDate = now;
        }
        student.modifiePar = currentUser.username;
        student.modifieDate = now;
        const idx = students.findIndex(s => s.id === student.id);
        if (idx >= 0) students[idx] = student;
        else students.push(student);
        localStorage.setItem('students_test', JSON.stringify(students));
        if (callback) callback({ success: true, student });
        return;
    }
    
    showLoading(true);
    apiPost({ action: 'saveStudent', user: currentUser.username, data: student }).then(data => {
        showLoading(false);
        if (callback) callback(data);
    }).catch(() => { showLoading(false); showToast('Erreur de connexion', true); });
}

function deleteFromServer(id, callback) {
    if (isReadOnly()) { showToast('Mode lecture seule', true); return; }
    if (isTestMode()) {
        students = students.filter(s => s.id !== id);
        localStorage.setItem('students_test', JSON.stringify(students));
        if (callback) callback({ success: true });
        return;
    }
    
    showLoading(true);
    apiGet({ action: 'deleteStudent', id, user: currentUser.username }).then(data => {
        showLoading(false);
        if (callback) callback(data);
    });
}

function updateStats() {
    document.getElementById('totalCount').textContent = students.length;
    document.getElementById('okCount').textContent = students.filter(s => s.status === 'ok').length;
    document.getElementById('pendingCount').textContent = students.filter(s => s.status === 'pending').length;
    document.getElementById('lateCount').textContent = students.filter(s => s.status === 'late').length;
}

function updateFormationFilter() {
    const formations = [...new Set(students.map(s => s.formation).filter(f => f))].sort();
    const select = document.getElementById('formationFilter');
    const current = select.value;
    select.innerHTML = '<option value="">Toutes formations</option>' + formations.map(f => `<option value="${f}">${f}</option>`).join('');
    select.value = current;
}

function renderStudents() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const formation = document.getElementById('formationFilter').value;
    const status = document.getElementById('statusFilter').value;
    const rythme = document.getElementById('rythmeFilter').value;
    
    const lateDays = parseInt(document.getElementById('lateFilter').value) || 0;
    
    const filtered = students.filter(s => {
        const matchSearch = (s.nom || '').toLowerCase().includes(search) || (s.telephone || '').includes(search);
        const matchLate = !lateDays || (s.status === 'late' && getOldestLatedays(s) >= lateDays);
        return matchSearch && (!formation || s.formation === formation) && (!status || s.status === status) && (!rythme || s.rythme === rythme) && matchLate;
    });
    
    // Banni√®re filtre actif
    const banner = document.getElementById('activeFilterBanner');
    const hasFilter = formation || status || rythme;
    if (hasFilter) {
        const parts = [];
        if (status) parts.push(status === 'ok' ? '‚úÖ √Ä jour' : status === 'pending' ? '‚è≥ En attente' : '‚ö†Ô∏è En retard');
        if (formation) parts.push(formation);
        if (rythme) parts.push(rythme);
        document.getElementById('activeFilterText').innerHTML = `üîç Filtre actif : <strong>${parts.join(' ¬∑ ')}</strong> ‚Äî ${filtered.length} √©tudiant${filtered.length > 1 ? 's' : ''}`;
        banner.style.display = 'flex';
    } else {
        banner.style.display = 'none';
    }
    
    const grid = document.getElementById('studentsGrid');
    if (filtered.length === 0) {
        grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:60px;color:rgba(255,255,255,0.4)"><span style="font-size:64px;display:block;margin-bottom:20px">üì≠</span>Aucun √©tudiant trouv√©</div>';
        return;
    }
    
    // Empty state onboarding
    if (students.length === 0) {
        grid.innerHTML = '<div class="empty-state"><span class="empty-icon">üéì</span><h3>Aucun √©tudiant pour le moment</h3><p>Commencez par importer un fichier CSV ou ajoutez votre premier √©tudiant manuellement.</p><div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap">' + (canWrite() ? '<button class="btn btn-success" onclick="openImportModal()">üì• Importer un CSV</button><button class="btn btn-primary" onclick="openModal()">+ Nouvel √©tudiant</button>' : '') + '</div></div>';
        return;
    }
    
    grid.innerHTML = filtered.map(s => {
        const pct = s.total > 0 ? Math.round((s.paid || 0) / s.total * 100) : 0;
        const statusText = s.status === 'ok' ? '‚úÖ √Ä jour' : s.status === 'pending' ? '‚è≥ En attente' : '‚ö†Ô∏è En retard';
        return `
            <div class="student-card" onclick="openDetailModal('${esc(s.id)}')">
                <div class="student-header">
                    <div><div class="student-name">${esc(s.nom) || 'Sans nom'}</div><span class="student-formation">${esc(s.formation) || '-'}</span></div>
                    <span class="status-badge ${esc(s.status) || 'pending'}">${statusText}</span>
                </div>
                <div class="student-details">
                    <div class="detail-row">üìû ${esc(s.telephone) || 'Non renseign√©'}</div>
                    <div class="detail-row">üìö ${esc(s.rythme) || '-'}</div>
                </div>
                <div class="payment-progress"><div class="payment-bar ${esc(s.status) || 'pending'}" style="width:${pct}%"></div></div>
                <div class="payment-info"><span>${s.paid || 0}‚Ç¨ pay√©s</span><span>${s.total || 0}‚Ç¨ total</span></div>
            </div>`;
    }).join('');
}

// ==========================================
// ONGLETS & STATISTIQUES
// ==========================================
function switchTab(tab) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    if (tab === 'stats') {
        document.querySelectorAll('.tab')[1].classList.add('active');
        document.getElementById('tabStats').classList.add('active');
        renderStatsPage();
    } else {
        document.querySelectorAll('.tab')[0].classList.add('active');
        document.getElementById('tabAccueil').classList.add('active');
    }
}

function filterFromStats(type, value) {
    // Switch to accueil tab and apply filter
    switchTab('accueil');
    if (type === 'status') {
        document.getElementById('statusFilter').value = value;
        document.getElementById('formationFilter').value = '';
        document.getElementById('rythmeFilter').value = '';
    } else if (type === 'formation') {
        document.getElementById('formationFilter').value = value;
        document.getElementById('statusFilter').value = '';
        document.getElementById('rythmeFilter').value = '';
    } else if (type === 'rythme') {
        document.getElementById('rythmeFilter').value = value;
        document.getElementById('statusFilter').value = '';
        document.getElementById('formationFilter').value = '';
    }
    document.getElementById('lateFilter').value = '';
    renderStudents();
}

function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('formationFilter').value = '';
    document.getElementById('statusFilter').value = '';
    document.getElementById('rythmeFilter').value = '';
    document.getElementById('lateFilter').value = '';
    renderStudents();
}

function renderStatsPage() {
    const total = students.length;
    if (total === 0) return;
    
    // Financial summary
    let totalPaid = 0, totalRemaining = 0, totalDue = 0;
    students.forEach(s => {
        totalPaid += s.paid || 0;
        totalDue += s.total || 0;
    });
    totalRemaining = totalDue - totalPaid;
    document.getElementById('statTotalPaid').textContent = totalPaid.toLocaleString('fr-FR') + '‚Ç¨';
    document.getElementById('statTotalRemaining').textContent = totalRemaining.toLocaleString('fr-FR') + '‚Ç¨';
    document.getElementById('statTotalDue').textContent = totalDue.toLocaleString('fr-FR') + '‚Ç¨';
    
    // By formation
    const byFormation = {};
    students.forEach(s => { const f = s.formation || 'Non renseign√©'; byFormation[f] = (byFormation[f] || 0) + 1; });
    const formSorted = Object.entries(byFormation).sort((a, b) => b[1] - a[1]);
    document.getElementById('statsFormation').innerHTML = formSorted.map(([name, count]) =>
        `<tr onclick="filterFromStats('formation','${name === 'Non renseign√©' ? '' : name}')"><td>${name}</td><td class="bar-cell"><div class="stats-bar"><div class="stats-bar-fill" style="width:${Math.round(count/total*100)}%"></div></div></td><td class="count">${count}</td></tr>`
    ).join('');
    
    // By rythme
    const byRythme = {};
    students.forEach(s => { const r = s.rythme || 'Non renseign√©'; byRythme[r] = (byRythme[r] || 0) + 1; });
    const rythmeSorted = Object.entries(byRythme).sort((a, b) => b[1] - a[1]);
    document.getElementById('statsRythme').innerHTML = rythmeSorted.map(([name, count]) =>
        `<tr onclick="filterFromStats('rythme','${name === 'Non renseign√©' ? '' : name}')"><td>${name}</td><td class="bar-cell"><div class="stats-bar"><div class="stats-bar-fill" style="width:${Math.round(count/total*100)}%"></div></div></td><td class="count">${count}</td></tr>`
    ).join('');
    
    // By CHQ
    const chqOui = students.filter(s => s.chq).length;
    const chqNon = total - chqOui;
    document.getElementById('statsChq').innerHTML = `
        <tr onclick="filterFromStats('status','')"><td>‚úÖ Oui</td><td class="bar-cell"><div class="stats-bar"><div class="stats-bar-fill" style="width:${Math.round(chqOui/total*100)}%;background:linear-gradient(90deg,#2ed573,#7bed9f)"></div></div></td><td class="count">${chqOui}</td></tr>
        <tr onclick="filterFromStats('status','')"><td>‚ùå Non</td><td class="bar-cell"><div class="stats-bar"><div class="stats-bar-fill" style="width:${Math.round(chqNon/total*100)}%;background:linear-gradient(90deg,#ff9f43,#ffc048)"></div></div></td><td class="count">${chqNon}</td></tr>`;
    
    // By status
    const statusMap = { ok: '‚úÖ √Ä jour', pending: '‚è≥ En attente', late: '‚ö†Ô∏è En retard' };
    const statusColors = { ok: '#2ed573,#7bed9f', pending: '#ff9f43,#ffc048', late: '#ff4757,#ff6b81' };
    const byStatus = {};
    students.forEach(s => { const st = s.status || 'pending'; byStatus[st] = (byStatus[st] || 0) + 1; });
    document.getElementById('statsStatus').innerHTML = ['ok', 'pending', 'late'].filter(k => byStatus[k]).map(k =>
        `<tr onclick="filterFromStats('status','${k}')"><td>${statusMap[k]}</td><td class="bar-cell"><div class="stats-bar"><div class="stats-bar-fill" style="width:${Math.round((byStatus[k]||0)/total*100)}%;background:linear-gradient(90deg,${statusColors[k]})"></div></div></td><td class="count">${byStatus[k] || 0}</td></tr>`
    ).join('');
}

// ==========================================
// MODAL NOUVEL √âTUDIANT
// ==========================================
function openModal() {
    ['studentNom','studentPrenom','studentPhone','studentBank','studentEcheances','studentChqMontant','studentChqBanque'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('studentFormation').value = '';
    document.getElementById('studentRythme').value = 'IOA';
    document.getElementById('studentChq').value = 'non';
    toggleChqFields('student');
    document.getElementById('modalOverlay').classList.add('active');
}

function toggleChqFields(prefix) {
    const val = document.getElementById(prefix + 'Chq').value;
    const show = val === 'oui';
    const montantGroup = document.getElementById(prefix + 'ChqMontantGroup');
    const banqueGroup = document.getElementById(prefix + 'ChqBanqueGroup');
    if (montantGroup) montantGroup.style.display = show ? '' : 'none';
    if (banqueGroup) banqueGroup.style.display = show ? '' : 'none';
}

function closeModal() { document.getElementById('modalOverlay').classList.remove('active'); }

function saveStudent() {
    const nom = document.getElementById('studentNom').value.trim();
    const prenom = document.getElementById('studentPrenom').value.trim();
    const fullName = (nom + ' ' + prenom).trim();
    if (!fullName) { showToast('Veuillez remplir le nom', true); return; }
    
    const echeancesRaw = document.getElementById('studentEcheances').value.trim();
    const parsed = parseEcheances(echeancesRaw);
    
    const student = {
        nom: fullName,
        formation: document.getElementById('studentFormation').value.trim(),
        rythme: document.getElementById('studentRythme').value,
        telephone: document.getElementById('studentPhone').value.trim().replace(/[^0-9]/g, ''),
        banque: document.getElementById('studentBank').value.trim(),
        chq: document.getElementById('studentChq').value === 'oui',
        chqMontant: document.getElementById('studentChq').value === 'oui' ? parseFloat(document.getElementById('studentChqMontant').value) || 0 : 0,
        chqBanque: document.getElementById('studentChq').value === 'oui' ? document.getElementById('studentChqBanque').value.trim() : '',
        echeancesRaw: echeancesRaw,
        echeancesJson: parsed.echeances.map(e => ({
            date: e.date.toISOString(),
            montant: e.montant,
            type: e.type,
            paid: e.paid,
            label: e.label || ''
        })),
        status: 'pending',
        paid: parsed.paid,
        total: parsed.total
    };
    
    saveToServer(student, (data) => {
        if (data.success) { closeModal(); loadStudents(); showToast('‚úÖ ' + fullName + ' enregistr√©!'); }
        else showToast('Erreur: ' + data.error, true);
    });
}

// ==========================================
// MODAL D√âTAIL ‚Äî VUE
// ==========================================
function openDetailModal(id) {
    currentStudentId = id;
    detailDirty = false;
    const s = students.find(st => String(st.id) === String(id));
    if (!s) return;
    
    const pct = s.total > 0 ? Math.round((s.paid || 0) / s.total * 100) : 0;
    const remaining = (s.total || 0) - (s.paid || 0);
    const initials = (s.nom || 'XX').split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
    
    // R√©cup√©rer les √©ch√©ances structur√©es
    let echeances = s.echeancesJson || [];
    if (echeances.length === 0 && s.echeancesRaw) {
        const parsed = parseEcheances(s.echeancesRaw);
        echeances = parsed.echeances.map(e => ({
            date: e.date.toISOString(),
            montant: e.montant,
            type: e.type,
            paid: e.paid,
            label: e.label || ''
        }));
    }
    
    let echeancierHtml = buildEcheancierHtml(echeances, s);
    
    // Options
    const statusOptions = ['ok', 'pending', 'late'].map(v =>
        `<option value="${v}" ${s.status === v ? 'selected' : ''}>${v === 'ok' ? '‚úÖ √Ä jour' : v === 'pending' ? '‚è≥ En attente' : '‚ö†Ô∏è En retard'}</option>`
    ).join('');
    const rythmeOptions = ['IOA', 'Initiale', 'Alternance', 'SFP'].map(v =>
        `<option value="${v}" ${s.rythme === v ? 'selected' : ''}>${v}</option>`
    ).join('');
    const formationsList = ['BACH CDA','BACH CDME','BTS CG 1','BTS CG 2','BTS CI 1','BTS COM 1','BTS COM 2','BTS MCO 1','BTS MCO 2','BTS NDRC 1','BTS NDRC 2','BTS SAM 1','BTS SIO 1','BTS SIO 2 SISR','BTS SIO 2 SLAM','BTS SIO SISR','Bachelor AIS','Bachelor RH','M1 COM','M1 FCA','M1 FSO','M1 INFO BD','M1 INFO CS','M1 MCM','M1 MSC','M1 RH','M2 INFO BD','M2 INFO CS','M2 MCM','M2 MSC','M2 MSFO','M2 RH'];
    const formationOptions = '<option value="">-- Choisir --</option>' + formationsList.map(f =>
        `<option value="${f}" ${(s.formation || '') === f ? 'selected' : ''}>${f}</option>`
    ).join('');
    
    const html = `
        <div class="student-profile">
            <div class="student-avatar">${initials}</div>
            <input type="text" id="editNom" class="inline-edit" value="${s.nom || ''}" placeholder="Nom complet" style="text-align:center;font-size:22px;font-weight:600;border-bottom:none;margin-bottom:8px">
        </div>
        <div class="info-section">
            <h4>üìã Informations</h4>
            <div class="info-grid">
                <div class="info-item"><div class="info-label">T√©l√©phone</div><input type="text" id="editPhone" class="inline-edit" value="${s.telephone || ''}" placeholder="0612345678"></div>
                <div class="info-item"><div class="info-label">Rythme</div><select id="editRythme" class="inline-edit">${rythmeOptions}</select></div>
                <div class="info-item"><div class="info-label">Banque</div><input type="text" id="editBank" class="inline-edit" value="${s.banque || ''}" placeholder="BNP, LCL, SG..."></div>
                <div class="info-item"><div class="info-label">Formation</div><select id="editFormation" class="inline-edit">${formationOptions}</select></div>
                <div class="info-item"><div class="info-label">Statut</div><select id="editStatus" class="inline-edit">${statusOptions}</select></div>
            </div>
        </div>
        <div class="info-section">
            <h4>üìù Ch√®que de caution</h4>
            <div class="info-grid">
                <div class="info-item"><div class="info-label">CHQ</div><select id="editChq" class="inline-edit" onchange="toggleChqFieldsInline()">${'<option value="non"' + (!s.chq ? ' selected' : '') + '>Non</option><option value="oui"' + (s.chq ? ' selected' : '') + '>Oui</option>'}</select></div>
                <div class="info-item" id="editChqMontantGroup" style="${s.chq ? '' : 'display:none'}"><div class="info-label">Montant CHQ</div><input type="number" id="editChqMontant" class="inline-edit" value="${s.chqMontant || ''}" placeholder="0"></div>
                <div class="info-item" id="editChqBanqueGroup" style="${s.chq ? '' : 'display:none'}"><div class="info-label">Banque CHQ</div><input type="text" id="editChqBanque" class="inline-edit" value="${s.chqBanque || ''}" placeholder="Banque du ch√®que"></div>
            </div>
        </div>
        <div class="info-section">
            <h4>üí≥ Situation financi√®re</h4>
            <div class="payment-detail">
                <div class="payment-progress"><div class="payment-bar ${s.status || 'pending'}" style="width:${pct}%"></div></div>
                <div class="payment-stats">
                    <span class="paid">${s.paid || 0}‚Ç¨ pay√©s (${pct}%)</span>
                    <span class="remaining">${remaining}‚Ç¨ restant</span>
                </div>
            </div>
        </div>
        <div class="info-section">
            <h4>üìÖ √âch√©ancier</h4>
            ${echeancierHtml}
        </div>
        <div class="info-section">
            <h4>üìù Notes</h4>
            <textarea id="editNotes" class="inline-edit" placeholder="Ajouter des notes...">${s.notes || ''}</textarea>
        </div>
        <div class="meta-info">
            Cr√©√© par <strong>${s.creePar || '-'}</strong> le ${s.creeDate || '-'}<br>
            Modifi√© par <strong>${s.modifiePar || '-'}</strong> le ${s.modifieDate || '-'}
        </div>`;
    
    document.getElementById('detailContent').innerHTML = html;
    let footerHtml = '';
    if (s.status === 'late' && canWrite()) footerHtml += '<button class="btn btn-warning btn-sm" onclick="openRelanceModal(\'' + esc(s.id) + '\')">üìß Relance</button>';
    if (canWrite()) footerHtml += '<button class="btn btn-danger" onclick="deleteStudent()">üóëÔ∏è Supprimer</button><button class="btn btn-primary" onclick="saveDetailAndClose()" id="saveDetailBtn">üíæ Enregistrer & Fermer</button>';
    else footerHtml += '<button class="btn btn-secondary" onclick="closeDetailModal()">Fermer</button>';
    document.getElementById('detailFooter').innerHTML = footerHtml;
    document.getElementById('detailModal').classList.add('active');
}

function toggleChqFieldsInline() {
    const val = document.getElementById('editChq').value;
    const show = val === 'oui';
    document.getElementById('editChqMontantGroup').style.display = show ? '' : 'none';
    document.getElementById('editChqBanqueGroup').style.display = show ? '' : 'none';
}

function saveDetailFields() {
    const s = students.find(st => String(st.id) === String(currentStudentId));
    if (!s) return;
    
    s.nom = (document.getElementById('editNom')?.value || '').trim();
    s.telephone = (document.getElementById('editPhone')?.value || '').trim();
    s.formation = (document.getElementById('editFormation')?.value || '').trim();
    s.rythme = document.getElementById('editRythme')?.value || 'IOA';
    s.banque = (document.getElementById('editBank')?.value || '').trim();
    s.status = document.getElementById('editStatus')?.value || 'pending';
    s.chq = document.getElementById('editChq')?.value === 'oui';
    s.chqMontant = s.chq ? parseFloat(document.getElementById('editChqMontant')?.value) || 0 : 0;
    s.chqBanque = s.chq ? (document.getElementById('editChqBanque')?.value || '').trim() : '';
    s.notes = document.getElementById('editNotes')?.value || '';
    
    const newRaw = (document.getElementById('editEcheances')?.value || '').trim();
    // Only update the raw text ‚Äî don't re-parse, the interactive ech√©ancier (echeancesJson) is the source of truth
    s.echeancesRaw = newRaw;
    
    return s;
}

function saveDetailAndClose() {
    const s = saveDetailFields();
    if (!s) return;
    saveToServer(s, (data) => {
        if (data.success) {
            loadStudents();
            showToast('‚úÖ Modifications enregistr√©es');
            document.getElementById('detailModal').classList.remove('active');
            currentStudentId = null;
        } else {
            showToast('Erreur: ' + data.error, true);
        }
    });
}

function buildEcheancierHtml(echeances, student) {
    const now = new Date();
    
    // Texte brut toujours visible et √©ditable
    let rawBlock = `
        <div style="margin-bottom:16px">
            <textarea id="editEcheances" class="inline-edit" style="min-height:50px;margin-bottom:10px" placeholder="Ex: 770 le 25/6/25 + 260 a partir du 25/9/25 pour faire 3590 en tout">${student.echeancesRaw || ''}</textarea>
            <button class="btn-add-ech" onclick="reparseEcheancesFromRaw()" style="width:100%">üîÑ Mettre √† jour l'√©ch√©ancier</button>
        </div>`;
    
    // Calculer les totaux
    let paid = 0, total = 0;
    echeances.forEach(e => {
        total += e.montant || 0;
        if (e.paid) paid += e.montant || 0;
    });
    const remaining = total - paid;
    
    if (echeances.length === 0) {
        return `
            <div class="echeancier-section">
                ${rawBlock}
                <p style="color:rgba(255,255,255,0.4);font-style:italic;text-align:center;padding:20px">Aucune √©ch√©ance d√©finie ‚Äî ajoutez-en ci-dessous ou via le texte brut</p>
                <div class="add-echeance-form">
                    <div class="field"><label>Date</label><input type="date" id="newEchDate"></div>
                    <div class="field"><label>Montant ‚Ç¨</label><input type="number" id="newEchAmount" placeholder="0"></div>
                    <div class="field"><label>Type</label><select id="newEchType"><option value="Pr√©l√®vement">Pr√©l√®vement</option><option value="Esp√®ces">Esp√®ces</option><option value="CB">CB</option><option value="Ch√®que">Ch√®que</option><option value="Virement">Virement</option></select></div>
                    <button class="btn-add-ech" onclick="addEcheance()">+ Ajouter</button>
                </div>
            </div>`;
    }
    
    // Trier par date
    echeances.sort((a, b) => new Date(a.date) - new Date(b.date));
    
    const items = echeances.map((e, i) => {
        const d = new Date(e.date);
        const isLate = !e.paid && d < now;
        const dateStr = e.label || d.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short', year: 'numeric' });
        
        return `
            <div class="echeance-item ${e.paid ? 'is-paid' : ''} ${isLate ? 'is-late' : ''}">
                <div class="ech-check ${e.paid ? 'checked' : ''}" onclick="toggleEcheance(${i})"></div>
                <div class="ech-date-wrap"><div class="ech-date editable" onclick="editEcheanceDate(${i}, this)" title="Cliquer pour modifier la date">${dateStr}</div></div>
                <div class="ech-amount-wrap"><div class="ech-amount editable ${e.paid ? 'paid' : 'unpaid'}" onclick="editEcheanceAmount(${i}, this)" title="Cliquer pour modifier le montant">${(e.montant || 0).toLocaleString('fr-FR')}‚Ç¨</div></div>
                <div class="ech-type editable" onclick="editEcheanceType(${i}, this)" title="Cliquer pour modifier le type">${e.type || 'Pr√©l√®vement'}</div>
                <button class="ech-delete" onclick="deleteEcheance(${i})" title="Supprimer">‚úï</button>
            </div>`;
    }).join('');
    
    return `
        <div class="echeancier-section">
            ${rawBlock}
            <div class="echeancier-header">
                <div class="echeancier-stats">
                    <div class="stat"><div class="stat-value green">${paid.toLocaleString('fr-FR')}‚Ç¨</div><div class="stat-label">Pay√©</div></div>
                    <div class="stat"><div class="stat-value orange">${remaining.toLocaleString('fr-FR')}‚Ç¨</div><div class="stat-label">Restant</div></div>
                    <div class="stat"><div class="stat-value total-val">${total.toLocaleString('fr-FR')}‚Ç¨</div><div class="stat-label">Total</div></div>
                </div>
            </div>
            <div class="echeance-list">${items}</div>
            <div class="add-echeance-form">
                <div class="field"><label>Date</label><input type="date" id="newEchDate"></div>
                <div class="field"><label>Montant ‚Ç¨</label><input type="number" id="newEchAmount" placeholder="0"></div>
                <div class="field"><label>Type</label><select id="newEchType"><option value="Pr√©l√®vement">Pr√©l√®vement</option><option value="Esp√®ces">Esp√®ces</option><option value="CB">CB</option><option value="Ch√®que">Ch√®que</option><option value="Virement">Virement</option></select></div>
                <button class="btn-add-ech" onclick="addEcheance()">+ Ajouter</button>
            </div>
        </div>`;
}

// ==========================================
// √âCH√âANCIER ‚Äî ACTIONS INTERACTIVES
// ==========================================

function reparseEcheancesFromRaw() {
    const s = students.find(st => String(st.id) === String(currentStudentId));
    if (!s) return;
    const rawEl = document.getElementById('editEcheances');
    if (!rawEl) return;
    const newRaw = rawEl.value.trim();
    s.echeancesRaw = newRaw;
    if (newRaw) {
        const parsed = parseEcheances(newRaw);
        const echeances = parsed.echeances.map(e => ({
            date: e.date.toISOString(),
            montant: e.montant,
            type: e.type,
            paid: e.paid,
            label: e.label || ''
        }));
        s.echeancesJson = echeances;
        s.paid = parsed.paid;
        s.total = parsed.total;
    }
    saveEcheancesToServer(s.echeancesJson || []);
    showToast('üîÑ √âch√©ancier recalcul√©');
}

function getStudentEcheances() {
    const s = students.find(st => String(st.id) === String(currentStudentId));
    if (!s) return [];
    let echeances = s.echeancesJson || [];
    if (echeances.length === 0 && s.echeancesRaw) {
        const parsed = parseEcheances(s.echeancesRaw);
        echeances = parsed.echeances.map(e => ({
            date: e.date.toISOString(),
            montant: e.montant,
            type: e.type,
            paid: e.paid,
            label: e.label || ''
        }));
    }
    return echeances;
}

function saveEcheancesToServer(echeances) {
    const s = students.find(st => String(st.id) === String(currentStudentId));
    if (!s) return;
    
    // Recalculer les totaux
    let paid = 0, total = 0;
    echeances.forEach(e => {
        total += e.montant || 0;
        if (e.paid) paid += e.montant || 0;
    });
    
    // D√©terminer le statut
    let status = 'pending';
    if (paid >= total && total > 0) status = 'ok';
    else {
        const now = new Date();
        const hasLate = echeances.some(e => !e.paid && new Date(e.date) < now);
        if (hasLate) status = 'late';
    }
    
    // Mettre √† jour localement
    s.echeancesJson = echeances;
    s.paid = paid;
    s.total = total;
    s.status = status;
    
    if (isTestMode()) {
        localStorage.setItem('students_test', JSON.stringify(students));
        updateStats();
        openDetailModal(currentStudentId); // Rafra√Æchir la vue
        return;
    }
    
    // Envoyer au serveur
    apiPost({
        action: 'saveEcheances',
        id: currentStudentId,
        user: currentUser.username,
        data: echeances
    }).then(data => {
        if (data.success) {
            s.paid = data.paid;
            s.total = data.total;
            s.status = data.status;
            updateStats();
            openDetailModal(currentStudentId);
        } else {
            showToast('Erreur: ' + data.error, true);
        }
    }).catch(() => showToast('Erreur de connexion', true));
}

function toggleEcheance(index) {
    const echeances = getStudentEcheances();
    if (index < 0 || index >= echeances.length) return;
    echeances[index].paid = !echeances[index].paid;
    showToast(echeances[index].paid ? '‚úÖ Paiement marqu√©' : '‚Ü©Ô∏è Paiement d√©-marqu√©');
    saveEcheancesToServer(echeances);
}

function deleteEcheance(index) {
    const echeances = getStudentEcheances();
    if (index < 0 || index >= echeances.length) return;
    if (!confirm(`Supprimer l'√©ch√©ance de ${echeances[index].montant}‚Ç¨ ?`)) return;
    echeances.splice(index, 1);
    showToast('üóëÔ∏è √âch√©ance supprim√©e');
    saveEcheancesToServer(echeances);
}

function addEcheance() {
    const dateEl = document.getElementById('newEchDate');
    const amountEl = document.getElementById('newEchAmount');
    const typeEl = document.getElementById('newEchType');
    
    const date = dateEl.value;
    const montant = parseFloat(amountEl.value);
    const type = typeEl.value;
    
    if (!date) { showToast('S√©lectionnez une date', true); return; }
    if (!montant || montant <= 0) { showToast('Montant invalide', true); return; }
    
    const echeances = getStudentEcheances();
    const newDate = new Date(date);
    
    echeances.push({
        date: newDate.toISOString(),
        montant: montant,
        type: type,
        paid: newDate < new Date(),
        label: ''
    });
    
    showToast(`‚úÖ √âch√©ance de ${montant}‚Ç¨ ajout√©e`);
    saveEcheancesToServer(echeances);
}

// ==========================================
// √âDITION INLINE DES √âCH√âANCES
// ==========================================

function editEcheanceDate(index, el) {
    if (el.querySelector('input')) return; // D√©j√† en √©dition
    const echeances = getStudentEcheances();
    if (index < 0 || index >= echeances.length) return;
    
    const e = echeances[index];
    const d = new Date(e.date);
    const isoDate = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
    
    const originalText = el.textContent;
    el.innerHTML = `<input type="date" class="ech-edit-input" value="${isoDate}">`;
    const input = el.querySelector('input');
    input.focus();
    
    function save() {
        const newVal = input.value;
        if (newVal && newVal !== isoDate) {
            const newDate = new Date(newVal + 'T12:00:00');
            echeances[index].date = newDate.toISOString();
            echeances[index].label = '';
            showToast('üìÖ Date modifi√©e');
            saveEcheancesToServer(echeances);
        } else {
            el.textContent = originalText;
            el.classList.add('editable');
        }
    }
    
    input.addEventListener('blur', save);
    input.addEventListener('keydown', function(ev) {
        if (ev.key === 'Enter') { ev.preventDefault(); input.blur(); }
        if (ev.key === 'Escape') { el.textContent = originalText; el.classList.add('editable'); }
    });
}

function editEcheanceAmount(index, el) {
    if (el.querySelector('input')) return;
    const echeances = getStudentEcheances();
    if (index < 0 || index >= echeances.length) return;
    
    const e = echeances[index];
    const currentAmount = e.montant || 0;
    
    const originalText = el.textContent;
    el.innerHTML = `<input type="number" class="ech-edit-input" value="${currentAmount}" min="0" step="0.01" style="width:90px">`;
    const input = el.querySelector('input');
    input.focus();
    input.select();
    
    function save() {
        const newVal = parseFloat(input.value);
        if (!isNaN(newVal) && newVal >= 0 && newVal !== currentAmount) {
            echeances[index].montant = newVal;
            showToast('üí∞ Montant modifi√©');
            saveEcheancesToServer(echeances);
        } else {
            el.textContent = originalText;
            el.classList.add('editable');
        }
    }
    
    input.addEventListener('blur', save);
    input.addEventListener('keydown', function(ev) {
        if (ev.key === 'Enter') { ev.preventDefault(); input.blur(); }
        if (ev.key === 'Escape') { el.textContent = originalText; el.classList.add('editable'); }
    });
}

function editEcheanceType(index, el) {
    if (el.querySelector('select')) return;
    const echeances = getStudentEcheances();
    if (index < 0 || index >= echeances.length) return;
    
    const e = echeances[index];
    const currentType = e.type || 'Pr√©l√®vement';
    const types = ['Pr√©l√®vement', 'Esp√®ces', 'CB', 'Ch√®que', 'Virement', 'Mensualit√©', 'Paiement'];
    
    const options = types.map(t => `<option value="${t}" ${t === currentType ? 'selected' : ''}>${t}</option>`).join('');
    const originalText = el.textContent;
    el.innerHTML = `<select class="ech-type-select">${options}</select>`;
    const select = el.querySelector('select');
    select.focus();
    
    function save() {
        const newVal = select.value;
        if (newVal && newVal !== currentType) {
            echeances[index].type = newVal;
            showToast('üè∑Ô∏è Type modifi√©');
            saveEcheancesToServer(echeances);
        } else {
            el.textContent = originalText;
            el.classList.add('editable');
        }
    }
    
    select.addEventListener('blur', save);
    select.addEventListener('change', function() { save(); });
    select.addEventListener('keydown', function(ev) {
        if (ev.key === 'Escape') { el.textContent = originalText; el.classList.add('editable'); }
    });
}

// ==========================================
// MODAL D√âTAIL ‚Äî FERMETURE
// ==========================================
function closeDetailModal() {
    if (currentStudentId && detailDirty && canWrite()) {
        if (confirm('Vous avez des modifications non sauvegard√©es. Voulez-vous les enregistrer ?')) {
            saveDetailAndClose();
            return;
        }
    }
    document.getElementById('detailModal').classList.remove('active');
    currentStudentId = null;
    detailDirty = false;
}

// ==========================================
// (√âdition inline int√©gr√©e dans openDetailModal)
// ==========================================

function deleteStudent() {
    const s = students.find(st => String(st.id) === String(currentStudentId));
    if (!s || !confirm('Supprimer ' + s.nom + ' ?')) return;
    deleteFromServer(currentStudentId, (data) => {
        if (data.success) { closeDetailModal(); loadStudents(); showToast('üóëÔ∏è √âtudiant supprim√©'); }
        else showToast('Erreur: ' + data.error, true);
    });
}

// ==========================================
// IMPORT CSV
// ==========================================
function openImportModal() {
    pendingImport = [];
    document.getElementById('importPreview').style.display = 'none';
    document.getElementById('importBtn').disabled = true;
    document.getElementById('fileInput').value = '';
    document.getElementById('importModal').classList.add('active');
}

function closeImportModal() { document.getElementById('importModal').classList.remove('active'); }

document.addEventListener('DOMContentLoaded', () => {
    const zone = document.getElementById('importZone');
    if (zone) {
        zone.addEventListener('dragover', e => { e.preventDefault(); zone.classList.add('dragover'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
        zone.addEventListener('drop', e => { e.preventDefault(); zone.classList.remove('dragover'); if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]); });
    }
});

function handleFileSelect(e) { if (e.target.files.length) handleFile(e.target.files[0]); }
function handleFile(file) { const reader = new FileReader(); reader.onload = e => parseCSV(e.target.result); reader.readAsText(file, 'UTF-8'); }

function parseCSV(content) {
    const firstLine = content.split('\n')[0];
    let sep = '\t';
    if (firstLine.includes(';') && !firstLine.includes('\t')) sep = ';';
    else if (firstLine.includes(',') && !firstLine.includes('\t')) sep = ',';
    
    const lines = content.split('\n').map(l => l.split(sep).map(c => c.trim().replace(/^"|"$/g, '')));
    const headers = lines[0].map(h => h.toUpperCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[^A-Z0-9]/g, ''));
    
    const col = {
        nom: headers.findIndex(h => h === 'NOM'),
        prenom: headers.findIndex(h => h.includes('PRENOM')),
        formation: headers.findIndex(h => h.includes('FORMATION')),
        rythme: headers.findIndex(h => h.includes('RYTHME')),
        telephone: headers.findIndex(h => h.includes('TELEPHONE') || h.includes('TEL')),
        banque: headers.findIndex(h => h.includes('BANQUE')),
        echeances: headers.findIndex(h => h.includes('ECHEANCE'))
    };
    
    pendingImport = [];
    let newCount = 0, updateCount = 0;
    
    for (let i = 1; i < lines.length; i++) {
        const row = lines[i];
        if (row.length < 2 || !row[col.nom >= 0 ? col.nom : 0]) continue;
        
        const nom = col.nom >= 0 ? (row[col.nom] || '') : '';
        const prenom = col.prenom >= 0 ? (row[col.prenom] || '') : '';
        const fullName = (nom + ' ' + prenom).trim();
        if (!fullName) continue;
        
        let phone = col.telephone >= 0 ? (row[col.telephone] || '') : '';
        phone = phone.replace(/[^0-9]/g, '');
        if (phone.length === 9 && !phone.startsWith('0')) phone = '0' + phone;
        if (phone.startsWith('33') && phone.length > 10) phone = '0' + phone.substring(2);
        
        let bank = col.banque >= 0 ? (row[col.banque] || '') : '';
        const bankMatch = bank.match(/^([A-Z\s.]+)/i);
        if (bankMatch) bank = bankMatch[1].trim();
        
        const echeancesRaw = col.echeances >= 0 ? (row[col.echeances] || '') : '';
        const parsed = parseEcheances(echeancesRaw);
        
        const student = {
            nom: fullName,
            formation: col.formation >= 0 ? (row[col.formation] || '') : '',
            rythme: col.rythme >= 0 ? (row[col.rythme] || 'IOA') : 'IOA',
            telephone: phone,
            banque: bank,
            echeancesRaw: echeancesRaw,
            echeancesJson: parsed.echeances.map(e => ({
                date: e.date.toISOString(),
                montant: e.montant,
                type: e.type,
                paid: e.paid,
                label: e.label || ''
            })),
            status: 'pending',
            paid: parsed.paid,
            total: parsed.total
        };
        
        const existing = students.find(s => (s.nom || '').toUpperCase() === fullName.toUpperCase());
        if (existing) updateCount++; else newCount++;
        pendingImport.push(student);
    }
    
    document.getElementById('previewCount').textContent = pendingImport.length;
    document.getElementById('previewNew').textContent = newCount;
    document.getElementById('previewUpdate').textContent = updateCount;
    
    document.getElementById('previewTable').innerHTML = pendingImport.slice(0, 15).map(s =>
        `<tr><td>${s.nom}</td><td>${s.formation}</td><td>${s.rythme}</td><td>${s.telephone}</td><td style="max-width:150px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${s.echeancesRaw || '-'}</td></tr>`
    ).join('') + (pendingImport.length > 15 ? `<tr><td colspan="5" style="text-align:center;opacity:0.5">... et ${pendingImport.length - 15} autres</td></tr>` : '');
    
    document.getElementById('importPreview').style.display = 'block';
    document.getElementById('importBtn').disabled = false;
}

function confirmImport() {
    if (!pendingImport.length) return;
    
    if (isTestMode()) {
        const now = new Date().toLocaleString('fr-FR');
        pendingImport.forEach(s => {
            const existing = students.find(st => (st.nom || '').toUpperCase() === (s.nom || '').toUpperCase());
            if (existing) {
                Object.assign(existing, s, { id: existing.id, creePar: existing.creePar, creeDate: existing.creeDate });
                existing.modifiePar = currentUser.username;
                existing.modifieDate = now;
            } else {
                s.id = Date.now().toString() + Math.random().toString(36).substr(2, 4);
                s.creePar = currentUser.username;
                s.creeDate = now;
                s.modifiePar = currentUser.username;
                s.modifieDate = now;
                students.push(s);
            }
        });
        localStorage.setItem('students_test', JSON.stringify(students));
        closeImportModal();
        loadStudents();
        showToast(`‚úÖ ${pendingImport.length} √©tudiants import√©s!`);
        return;
    }
    
    showLoading(true);
    apiPost({ action: 'importStudents', user: currentUser.username, data: pendingImport }).then(data => {
        showLoading(false);
        if (data.success) {
            closeImportModal();
            loadStudents();
            showToast(`‚úÖ ${data.created} cr√©√©s, ${data.updated} mis √† jour`);
        } else showToast('Erreur: ' + data.error, true);
    });
}

// ==========================================
// HISTORIQUE
// ==========================================
function openHistoryModal() {
    document.getElementById('historyModal').classList.add('active');
    if (isTestMode()) {
        document.getElementById('historyList').innerHTML = '<p style="text-align:center;color:rgba(255,255,255,0.4)">Historique non disponible en mode test</p>';
        return;
    }
    document.getElementById('historyList').innerHTML = '<p style="text-align:center;color:rgba(255,255,255,0.4)">Chargement...</p>';
    apiGet({ action: 'getHistory' }).then(data => {
        if (data.success) {
            document.getElementById('historyList').innerHTML = data.history.map(h => `
                <div class="history-item">
                    <div class="history-date">${h.date}</div>
                    <div class="history-user">${h.utilisateur}</div>
                    <div class="history-action ${h.action}">${h.action}</div>
                    <div class="history-details"><strong>${h.etudiant}</strong> ‚Äî ${h.details}</div>
                </div>
            `).join('') || '<p style="text-align:center;color:rgba(255,255,255,0.4)">Aucun historique</p>';
        }
    });
}

function closeHistoryModal() { document.getElementById('historyModal').classList.remove('active'); }

// ==========================================
// PARSEUR D'√âCH√âANCES (V3 ‚Äî R√â√âCRIT)
// ==========================================
// Formats support√©s :
//   "760 r√©gl√© en esp√®ce le 20/02/25"
//   "pvt de 323 du 5/10/25 au 5/6/26"
//   "770 le 25/6/25"
//   "260 a partir du 25/9/25 pour faire 3590 en tout"
//   "323 tous les 5 jusqu'au 5/6/26"
//   "a r√©gl√© 500"
//   Combinaisons avec "puis", "+", "et", "ensuite"

const MAX_ECHEANCES = 120;

function parseEcheances(text) {
    const result = { echeances: [], paid: 0, remaining: 0, total: 0 };
    if (!text || !text.trim()) return result;
    
    // Nettoyer
    let normalized = text
        .replace(/‚Ç¨/g, '')
        .replace(/"/g, '')
        .replace(/\s+/g, ' ')
        .trim();
    
    // Extraire "pour faire X en tout" / "total X" / "pour un total de X"
    let totalObjectif = 0;
    const totalMatch = normalized.match(/(?:pour\s+faire|pour\s+un\s+total\s+de|total\s*(?:de)?)\s+(\d+(?:[.,]\d+)?)\s*(?:en\s+tout|au\s+total)?/i);
    if (totalMatch) {
        totalObjectif = parseFloat(totalMatch[1].replace(',', '.'));
        // Retirer cette partie du texte pour ne pas interf√©rer
        normalized = normalized.replace(totalMatch[0], '');
    }
    
    // S√©parer les parties
    const parts = normalized.split(/\s+(?:puis|ensuite|\+|et(?:\s+enfin)?)\s+/i);
    
    for (const part of parts) {
        parsePart2(part.trim(), result, totalObjectif);
    }
    
    // Si on a un total objectif et des mensualit√©s "√† partir de", calculer le nombre de mois
    if (totalObjectif > 0) {
        const currentTotal = result.echeances.reduce((s, e) => s + e.montant, 0);
        if (currentTotal < totalObjectif) {
            // Chercher la derni√®re √©ch√©ance mensuelle pour la prolonger
            const lastMensuelle = [...result.echeances].reverse().find(e => e.type === 'Mensualit√©' || e.type === 'Pr√©l√®vement');
            if (lastMensuelle) {
                const montantMensuel = lastMensuelle.montant;
                let restant = totalObjectif - currentTotal;
                let nextDate = new Date(lastMensuelle.date);
                const now = new Date();
                let _safety = 0;
                while (restant > 0.5 && _safety < MAX_ECHEANCES) {
                    _safety++;
                    nextDate = new Date(nextDate);
                    nextDate.setMonth(nextDate.getMonth() + 1);
                    const m = Math.min(montantMensuel, restant);
                    result.echeances.push({
                        date: new Date(nextDate),
                        montant: m,
                        type: 'Mensualit√©',
                        paid: nextDate < now,
                        label: ''
                    });
                    restant -= m;
                }
            }
        }
    }
    
    // Trier et calculer
    result.echeances.sort((a, b) => a.date - b.date);
    result.paid = 0;
    result.remaining = 0;
    result.echeances.forEach(e => {
        if (e.paid) result.paid += e.montant;
        else result.remaining += e.montant;
    });
    result.total = result.paid + result.remaining;
    return result;
}

function parsePart2(text, result, totalObjectif) {
    if (!text || text.length < 2) return;
    const now = new Date();
    
    // ---- PATTERN 1 : "X r√©gl√© en YYY le DD/MM/YY" ou "a r√©gl√© X" ----
    const regle1 = text.match(/(\d+(?:[.,]\d+)?)\s*(?:r√©gl√©|regl√©|pay√©|vers√©)\s*(?:en\s+(\w+))?\s*(?:le\s+(\d{1,2})[\/\-](\d{1,2})(?:[\/\-](\d{2,4}))?)?/i);
    const regle2 = text.match(/(?:a\s+)?(?:r√©gl√©|regl√©|pay√©|vers√©)\s+(\d+(?:[.,]\d+)?)\s*(?:en\s+(\w+))?\s*(?:le\s+(\d{1,2})[\/\-](\d{1,2})(?:[\/\-](\d{2,4}))?)?/i);
    
    const regleM = regle1 || regle2;
    if (regleM) {
        const montant = parseFloat(regleM[1].replace(',', '.'));
        const typeRaw = regleM[2] || '';
        let date = now;
        if (regleM[3] && regleM[4]) {
            date = makeDate(regleM[3], regleM[4], regleM[5] || now.getFullYear());
        }
        result.echeances.push({
            date, montant,
            type: typeRaw ? getType(typeRaw) : 'Paiement',
            paid: true,
            label: 'R√©gl√©' + (typeRaw ? ' en ' + typeRaw : '')
        });
        return;
    }
    
    // ---- PATTERN 2 : "X √† partir du DD/MM/YY" (mensualit√© ouverte) ----
    const aPartirMatch = text.match(/(?:(?:pvt|prelevement|pr√©l√®vement)\s+(?:de\s+)?)?(\d+(?:[.,]\d+)?)\s+(?:√†\s+partir\s+du|a\s+partir\s+du|depuis\s+le)\s+(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/i);
    if (aPartirMatch) {
        const montant = parseFloat(aPartirMatch[1].replace(',', '.'));
        const dateDebut = makeDate(aPartirMatch[2], aPartirMatch[3], aPartirMatch[4]);
        
        // Si on a un totalObjectif, on a juste besoin de poser la 1√®re √©ch√©ance
        // Le code en haut (dans parseEcheances) se chargera de prolonger
        result.echeances.push({
            date: new Date(dateDebut),
            montant,
            type: 'Mensualit√©',
            paid: dateDebut < now,
            label: ''
        });
        return;
    }
    
    // ---- PATTERN 3 : "pvt de X du DD/MM/YY au DD/MM/YY" ----
    const pvtDuAuMatch = text.match(/(?:pvt|prelevement|pr√©l√®vement)\s+(?:de\s+)?(\d+(?:[.,]\d+)?)\s+(?:du|√†\s+partir\s+du)\s+(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})\s+(?:au|jusqu['\s]?au?)\s+(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/i);
    if (pvtDuAuMatch) {
        const montant = parseFloat(pvtDuAuMatch[1].replace(',', '.'));
        const dateDebut = makeDate(pvtDuAuMatch[2], pvtDuAuMatch[3], pvtDuAuMatch[4]);
        const dateFin = makeDate(pvtDuAuMatch[5], pvtDuAuMatch[6], pvtDuAuMatch[7]);
        dateFin.setDate(dateFin.getDate() + 1);
        let current = new Date(dateDebut);
        let _s3 = 0;
        while (current < dateFin && _s3 < MAX_ECHEANCES) {
            _s3++;
            result.echeances.push({ date: new Date(current), montant, type: 'Pr√©l√®vement', paid: current < now });
            current.setMonth(current.getMonth() + 1);
        }
        return;
    }
    
    // ---- PATTERN 4 : "X du DD/MM/YY au DD/MM/YY" (sans pvt) ----
    const duAuMatch = text.match(/(\d+(?:[.,]\d+)?)\s*(?:\/mois|par\s+mois)?\s*(?:du|√†\s+partir\s+du)\s+(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})\s+(?:au|jusqu['\s]?au?)\s+(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/i);
    if (duAuMatch) {
        const montant = parseFloat(duAuMatch[1].replace(',', '.'));
        const dateDebut = makeDate(duAuMatch[2], duAuMatch[3], duAuMatch[4]);
        const dateFin = makeDate(duAuMatch[5], duAuMatch[6], duAuMatch[7]);
        dateFin.setDate(dateFin.getDate() + 1);
        let current = new Date(dateDebut);
        let _s4 = 0;
        while (current < dateFin && _s4 < MAX_ECHEANCES) {
            _s4++;
            result.echeances.push({ date: new Date(current), montant, type: 'Mensualit√©', paid: current < now });
            current.setMonth(current.getMonth() + 1);
        }
        return;
    }
    
    // ---- PATTERN 5 : "X tous les J jusqu'au DD/MM/YY" ----
    const tousMatch = text.match(/(\d+(?:[.,]\d+)?)\s*(?:par\s+mois\s+)?tous\s+les\s+(\d+)\s+jusqu['\s]?(?:au)?\s*(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/i);
    if (tousMatch) {
        const montant = parseFloat(tousMatch[1].replace(',', '.'));
        const jour = parseInt(tousMatch[2]);
        const dateFin = makeDate(tousMatch[3], tousMatch[4], tousMatch[5]);
        dateFin.setDate(dateFin.getDate() + 1);
        let current = new Date();
        current.setDate(jour);
        if (current <= now) current.setMonth(current.getMonth() + 1);
        let _s5 = 0;
        while (current < dateFin && _s5 < MAX_ECHEANCES) {
            _s5++;
            result.echeances.push({ date: new Date(current), montant, type: 'Pr√©l√®vement', paid: false });
            current.setMonth(current.getMonth() + 1);
        }
        return;
    }
    
    // ---- PATTERN 6 : "pvt de X" (unique, chercher date) ----
    const pvtSimple = text.match(/(?:pvt|prelevement|pr√©l√®vement)\s+(?:de\s+)?(\d+(?:[.,]\d+)?)/i);
    if (pvtSimple) {
        const montant = parseFloat(pvtSimple[1].replace(',', '.'));
        const dateInText = text.match(/(?:le\s+)?(\d{1,2})[\/\-](\d{1,2})(?:[\/\-](\d{2,4}))?/);
        let date = now;
        if (dateInText) date = makeDate(dateInText[1], dateInText[2], dateInText[3] || now.getFullYear());
        result.echeances.push({ date, montant, type: 'Pr√©l√®vement', paid: date < now });
        return;
    }
    
    // ---- PATTERN 7 : "X le DD/MM/YY" ou "TYPE X le DD/MM/YY" ----
    const leMatch = text.match(/(?:(pvt|cb|esp|chq|vrt|espece|esp√®ce|cheque|ch√®que|virement|carte)\s+)?(\d+(?:[.,]\d+)?)\s*(?:\/(cb|esp|chq|vrt|pvt))?\s*(?:le|pour\s+le)\s+(\d{1,2})[\/\-](\d{1,2})(?:[\/\-](\d{2,4}))?/i);
    if (leMatch) {
        const type = getType(leMatch[1] || leMatch[3] || '');
        const montant = parseFloat(leMatch[2].replace(',', '.'));
        const annee = leMatch[6] || now.getFullYear();
        const date = makeDate(leMatch[4], leMatch[5], annee);
        result.echeances.push({ date, montant, type, paid: date < now });
        return;
    }
    
    // ---- PATTERN 8 : Juste "X" avec une date quelque part ----
    const montantSeul = text.match(/(\d+(?:[.,]\d+)?)/);
    const dateQuelquePart = text.match(/(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})/);
    if (montantSeul && dateQuelquePart) {
        const montant = parseFloat(montantSeul[1].replace(',', '.'));
        const date = makeDate(dateQuelquePart[1], dateQuelquePart[2], dateQuelquePart[3]);
        if (montant > 0) {
            result.echeances.push({ date, montant, type: 'Paiement', paid: date < now });
        }
    }
}

function makeDate(j, m, a) {
    let annee = parseInt(a);
    if (annee < 100) annee += 2000;
    return new Date(annee, parseInt(m) - 1, parseInt(j));
}

function getType(t) {
    if (!t) return 'Pr√©l√®vement';
    t = t.toLowerCase();
    if (t.includes('esp')) return 'Esp√®ces';
    if (t.includes('cb')) return 'CB';
    if (t.includes('chq')) return 'Ch√®que';
    if (t.includes('vrt') || t.includes('virement')) return 'Virement';
    return 'Pr√©l√®vement';
}

// ==========================================
// UTILITAIRES
// ==========================================

function previewEcheancesLive(textareaId, previewId) {
    const text = document.getElementById(textareaId).value;
    const preview = document.getElementById(previewId);
    if (!preview) return;
    
    const parsed = parseEcheances(text);
    
    if (parsed.echeances.length === 0) {
        preview.innerHTML = text.trim() ? '<div style="color:rgba(255,255,255,0.3);font-size:13px;padding:8px">‚ö†Ô∏è Aucune √©ch√©ance d√©tect√©e</div>' : '';
        return;
    }
    
    const items = parsed.echeances.map(e => {
        const d = e.date;
        const dateStr = e.label || d.toLocaleDateString('fr-FR', { day: '2-digit', month: 'short', year: 'numeric' });
        const isLate = !e.paid && d < new Date();
        return `
            <div class="echeance-item ${e.paid ? 'is-paid' : ''} ${isLate ? 'is-late' : ''}" style="cursor:default">
                <div class="ech-check ${e.paid ? 'checked' : ''}" style="cursor:default"></div>
                <div class="ech-date">${dateStr}</div>
                <div class="ech-amount ${e.paid ? 'paid' : 'unpaid'}">${e.montant.toLocaleString('fr-FR')}‚Ç¨</div>
                <div class="ech-type">${e.type}</div>
            </div>`;
    }).join('');
    
    preview.innerHTML = `
        <div class="echeancier-section">
            <div class="echeancier-header">
                <div class="echeancier-stats">
                    <div class="stat"><div class="stat-value green">${parsed.paid.toLocaleString('fr-FR')}‚Ç¨</div><div class="stat-label">Pay√©</div></div>
                    <div class="stat"><div class="stat-value orange">${parsed.remaining.toLocaleString('fr-FR')}‚Ç¨</div><div class="stat-label">Restant</div></div>
                    <div class="stat"><div class="stat-value total-val">${parsed.total.toLocaleString('fr-FR')}‚Ç¨</div><div class="stat-label">Total</div></div>
                </div>
            </div>
            <div class="echeance-list" style="max-height:200px">${items}</div>
        </div>`;
}
function showToast(msg, isError = false) {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.className = 'toast' + (isError ? ' error' : '');
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 3000);
}

function showLoading(show) {
    document.getElementById('loading').classList.toggle('active', show);
}

// ==========================================
// INITIALISATION
// ==========================================
document.addEventListener('DOMContentLoaded', () => {
    const savedUser = localStorage.getItem('user');
    if (savedUser) {
        try { currentUser = JSON.parse(savedUser); showMainPage(); }
        catch (e) { localStorage.removeItem('user'); }
    }
});
</script>
</body>
</html>
